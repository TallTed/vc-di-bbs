<!DOCTYPE html><html lang="en" dir="ltr"><head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="generator" content="ReSpec 34.5.0">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<style>
span.example-title{text-transform:none}
:is(aside,div).example,div.illegal-example{padding:.5em;margin:1em 0;position:relative;clear:both}
div.illegal-example{color:red}
div.illegal-example p{color:#000}
aside.example div.example{border-left-width:.1em;border-color:#999;background:#fff}
</style>
<style>
.issue-label{text-transform:initial}
.warning>p:first-child{margin-top:0}
.warning{padding:.5em;border-left-width:.5em;border-left-style:solid}
span.warning{padding:.1em .5em .15em}
.issue.closed span.issue-number{text-decoration:line-through}
.issue.closed span.issue-number::after{content:" (Closed)";font-size:smaller}
.warning{border-color:#f11;border-color:var(--warning-border,#f11);border-width:.2em;border-style:solid;background:#fbe9e9;background:var(--warning-bg,#fbe9e9);color:#000;color:var(--text,#000)}
.warning-title:before{content:"⚠";font-size:1.3em;float:left;padding-right:.3em;margin-top:-.3em}
li.task-list-item{list-style:none}
input.task-list-item-checkbox{margin:0 .35em .25em -1.6em;vertical-align:middle}
.issue a.respec-gh-label{padding:5px;margin:0 2px 0 2px;font-size:10px;text-transform:none;text-decoration:none;font-weight:700;border-radius:4px;position:relative;bottom:2px;border:none;display:inline-block}
</style>
<style>
dfn{cursor:pointer}
.dfn-panel{position:absolute;z-index:35;min-width:300px;max-width:500px;padding:.5em .75em;margin-top:.6em;font-family:"Helvetica Neue",sans-serif;font-size:small;background:#fff;background:var(--indextable-hover-bg,#fff);color:#000;color:var(--text,#000);box-shadow:0 1em 3em -.4em rgba(0,0,0,.3),0 0 1px 1px rgba(0,0,0,.05);box-shadow:0 1em 3em -.4em var(--tocsidebar-shadow,rgba(0,0,0,.3)),0 0 1px 1px var(--tocsidebar-shadow,rgba(0,0,0,.05));border-radius:2px}
.dfn-panel:not(.docked)>.caret{position:absolute;top:-9px}
.dfn-panel:not(.docked)>.caret::after,.dfn-panel:not(.docked)>.caret::before{content:"";position:absolute;border:10px solid transparent;border-top:0;border-bottom:10px solid #fff;border-bottom-color:var(--indextable-hover-bg,#fff);top:0}
.dfn-panel:not(.docked)>.caret::before{border-bottom:9px solid #a2a9b1;border-bottom-color:var(--indextable-hover-bg,#a2a9b1)}
.dfn-panel *{margin:0}
.dfn-panel b{display:block;color:#000;color:var(--text,#000);margin-top:.25em}
.dfn-panel ul a[href]{color:#333;color:var(--text,#333)}
.dfn-panel>div{display:flex}
.dfn-panel a.self-link{font-weight:700;margin-right:auto}
.dfn-panel .marker{padding:.1em;margin-left:.5em;border-radius:.2em;text-align:center;white-space:nowrap;font-size:90%;color:#040b1c}
.dfn-panel .marker.dfn-exported{background:#d1edfd;box-shadow:0 0 0 .125em #1ca5f940}
.dfn-panel .marker.idl-block{background:#8ccbf2;box-shadow:0 0 0 .125em #0670b161}
.dfn-panel a:not(:hover){text-decoration:none!important;border-bottom:none!important}
.dfn-panel a[href]:hover{border-bottom-width:1px}
.dfn-panel ul{padding:0}
.dfn-panel li{margin-left:1em}
.dfn-panel.docked{position:fixed;left:.5em;top:unset;bottom:2em;margin:0 auto;max-width:calc(100vw - .75em * 2 - .5em - .2em * 2);max-height:30vh;overflow:auto}
</style>
    
<title>Data Integrity BBS Cryptosuites v1.0</title>
    
    
    
<style id="respec-mainstyle">
@keyframes pop{
0%{transform:scale(1,1)}
25%{transform:scale(1.25,1.25);opacity:.75}
100%{transform:scale(1,1)}
}
:is(h1,h2,h3,h4,h5,h6,a) abbr{border:none}
dfn{font-weight:700}
a.internalDFN{color:inherit;border-bottom:1px solid #99c;text-decoration:none}
a.externalDFN{color:inherit;border-bottom:1px dotted #ccc;text-decoration:none}
a.bibref{text-decoration:none}
.respec-offending-element:target{animation:pop .25s ease-in-out 0s 1}
.respec-offending-element,a[href].respec-offending-element{text-decoration:red wavy underline}
@supports not (text-decoration:red wavy underline){
.respec-offending-element:not(pre){display:inline-block}
.respec-offending-element{background:url(data:image/gif;base64,R0lGODdhBAADAPEAANv///8AAP///wAAACwAAAAABAADAEACBZQjmIAFADs=) bottom repeat-x}
}
#references :target{background:#eaf3ff;animation:pop .4s ease-in-out 0s 1}
cite .bibref{font-style:normal}
a[href].orcid{padding-left:4px;padding-right:4px}
a[href].orcid>svg{margin-bottom:-2px}
.toc a,.tof a{text-decoration:none}
ol.tof,ul.tof{list-style:none outside none}
.caption{margin-top:.5em;font-style:italic}
table.simple{border-spacing:0;border-collapse:collapse;border-bottom:3px solid #005a9c}
.simple th{background:#005a9c;color:#fff;padding:3px 5px;text-align:left}
.simple th a{color:#fff;padding:3px 5px;text-align:left}
.simple th[scope=row]{background:inherit;color:inherit;border-top:1px solid #ddd}
.simple td{padding:3px 10px;border-top:1px solid #ddd}
.simple tr:nth-child(even){background:#f0f6ff}
.section dd>p:first-child{margin-top:0}
.section dd>p:last-child{margin-bottom:0}
.section dd{margin-bottom:1em}
.section dl.attrs dd,.section dl.eldef dd{margin-bottom:0}
#issue-summary>ul{column-count:2}
#issue-summary li{list-style:none;display:inline-block}
details.respec-tests-details{margin-left:1em;display:inline-block;vertical-align:top}
details.respec-tests-details>*{padding-right:2em}
details.respec-tests-details[open]{z-index:999999;position:absolute;border:thin solid #cad3e2;border-radius:.3em;background-color:#fff;padding-bottom:.5em}
details.respec-tests-details[open]>summary{border-bottom:thin solid #cad3e2;padding-left:1em;margin-bottom:1em;line-height:2em}
details.respec-tests-details>ul{width:100%;margin-top:-.3em}
details.respec-tests-details>li{padding-left:1em}
.self-link:hover{opacity:1;text-decoration:none;background-color:transparent}
aside.example .marker>a.self-link{color:inherit}
.header-wrapper{display:flex;align-items:baseline}
:is(h2,h3,h4,h5,h6):not(#toc>h2,#abstract>h2,#sotd>h2,.head>h2){position:relative;left:-.5em}
:is(h2,h3,h4,h5,h6):not(#toch2)+a.self-link{color:inherit;order:-1;position:relative;left:-1.1em;font-size:1rem;opacity:.5}
:is(h2,h3,h4,h5,h6)+a.self-link::before{content:"§";text-decoration:none;color:var(--heading-text)}
:is(h2,h3)+a.self-link{top:-.2em}
:is(h4,h5,h6)+a.self-link::before{color:#000}
@media (max-width:767px){
dd{margin-left:0}
}
@media print{
.removeOnSave{display:none}
}
</style>
    

    
        
<style>

code {
  color: rgb(199, 73, 0);
  font-weight: bold;
}
pre {
  overflow-x: auto;
  white-space: pre-wrap;
}
pre .highlight {
  font-weight: bold;
  color: Green;
}
pre .subject {
  font-weight: bold;
  color: RoyalBlue;
}
pre .property {
  font-weight: bold;
  color: DarkGoldenrod;
}
pre .comment {
  font-weight: bold;
  color: SteelBlue;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
ol.algorithm {
  counter-reset: numsection;
  list-style-type: none;
}
ol.algorithm li {
  margin: 0.5em 0;
}
ol.algorithm li:before {
  font-weight: bold;
  counter-increment: numsection;
  content: counters(numsection, ".") ") ";
}
              
</style>
  
<meta name="description" content="This specification describes a Data Integrity Cryptosuite for use when generating
digital signatures using the BBS signature scheme.
The Signature Suite utilizes BBS signatures to provide selective disclosure and
unlinkable derived proofs.">
<link rel="canonical" href="https://www.w3.org/TR/vc-di-bbs/">
<style>
.hljs{--base:#fafafa;--mono-1:#383a42;--mono-2:#686b77;--mono-3:#717277;--hue-1:#0b76c5;--hue-2:#336ae3;--hue-3:#a626a4;--hue-4:#42803c;--hue-5:#ca4706;--hue-5-2:#c91243;--hue-6:#986801;--hue-6-2:#9a6a01}
@media (prefers-color-scheme:dark){
.hljs{--base:#282c34;--mono-1:#abb2bf;--mono-2:#818896;--mono-3:#5c6370;--hue-1:#56b6c2;--hue-2:#61aeee;--hue-3:#c678dd;--hue-4:#98c379;--hue-5:#e06c75;--hue-5-2:#be5046;--hue-6:#d19a66;--hue-6-2:#e6c07b}
}
.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;color:var(--mono-1,#383a42);background:#fafafa;background:var(--base,#fafafa)}
.hljs-comment,.hljs-quote{color:#717277;color:var(--mono-3,#717277);font-style:italic}
.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4;color:var(--hue-3,#a626a4)}
.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#ca4706;color:var(--hue-5,#ca4706);font-weight:700}
.hljs-literal{color:#0b76c5;color:var(--hue-1,#0b76c5)}
.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#42803c;color:var(--hue-4,#42803c)}
.hljs-built_in,.hljs-class .hljs-title{color:#9a6a01;color:var(--hue-6-2,#9a6a01)}
.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801;color:var(--hue-6,#986801)}
.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#336ae3;color:var(--hue-2,#336ae3)}
.hljs-emphasis{font-style:italic}
.hljs-strong{font-weight:700}
.hljs-link{text-decoration:underline}
</style>
<style>
var{position:relative;cursor:pointer}
var[data-type]::after,var[data-type]::before{position:absolute;left:50%;top:-6px;opacity:0;transition:opacity .4s;pointer-events:none}
var[data-type]::before{content:"";transform:translateX(-50%);border-width:4px 6px 0 6px;border-style:solid;border-color:transparent;border-top-color:#222}
var[data-type]::after{content:attr(data-type);transform:translateX(-50%) translateY(-100%);background:#222;text-align:center;font-family:"Dank Mono","Fira Code",monospace;font-style:normal;padding:6px;border-radius:3px;color:#daca88;text-indent:0;font-weight:400}
var[data-type]:hover::after,var[data-type]:hover::before{opacity:1}
</style>
<script id="initialUserConfig" type="application/json">{
  "specStatus": "CR",
  "shortName": "vc-di-bbs",
  "subtitle": "Achieving Unlinkable Data Integrity with Pairing-based Cryptography",
  "group": "vc",
  "publishDate": "2024-03-28",
  "edDraftURI": "https://w3c.github.io/vc-di-bbs/",
  "implementationReportURI": "https://w3c.github.io/vc-data-integrity/implementations/",
  "crEnd": "2024-04-30",
  "editors": [
    {
      "name": "Greg Bernstein",
      "url": "https://www.grotto-networking.com/",
      "company": "Invited Expert",
      "w3cid": 140479
    },
    {
      "name": "Manu Sporny",
      "url": "https://www.linkedin.com/in/manusporny/",
      "company": "Digital Bazaar",
      "companyURL": "https://www.digitalbazaar.com/",
      "w3cid": 41758
    }
  ],
  "github": "https://github.com/w3c/vc-di-bbs",
  "maxTocLevel": 4,
  "localBiblio": {
    "RDF-CONCEPTS": {
      "title": "RDF 1.1 Concepts and Abstract Syntax",
      "href": "https://www.w3.org/TR/rdf11-concepts/",
      "authors": [
        "Richard Cyganiak",
        "David Wood",
        "Markus Lanthaler"
      ],
      "status": "Recommendation",
      "publisher": "W3C"
    },
    "DI-ECDSA": {
      "title": "The Elliptic Curve Digital Signature Algorithm Cryptosuites v1.0",
      "href": "https://www.w3.org/TR/vc-di-ecdsa/",
      "authors": [
        "David Longley",
        "Manu Sporny",
        "Marty Reed"
      ],
      "status": "WD",
      "publisher": "W3C Verifiable Credentials Working Group",
      "id": "di-ecdsa"
    },
    "VC-DATA-MODEL-2": {
      "title": "Verifiable Credentials Data Model v2.0",
      "href": "https://www.w3.org/TR/vc-data-model-2.0/",
      "authors": [
        "Manu Sporny",
        "Dave Longley",
        "Grant Noble",
        "Dan Burnett",
        "Ted Thibodeau",
        "Brent Zundel",
        "David Chadwick",
        "Kyle Den Hartog"
      ],
      "status": "Working Draft",
      "publisher": "W3C Verifiable Credentials Working Group"
    },
    "CFRG-BBS-SIGNATURE": {
      "title": "The BBS Signature Scheme",
      "href": "https://www.ietf.org/archive/id/draft-irtf-cfrg-bbs-signatures-02.html",
      "authors": [
        "Tobias Looker",
        "Vasilis Kalos",
        "Andrew Whitehead",
        "Mike Lodder"
      ],
      "status": "Draft",
      "id": "cfrg-bbs-signature"
    },
    "CFRG-PAIRING-FRIENDLY": {
      "title": "Pairing-Friendly Curves",
      "href": "https://www.ietf.org/archive/id/draft-irtf-cfrg-pairing-friendly-curves-11.html",
      "authors": [
        "Yumi Sakemi",
        "Tetsutaro Kobayashi",
        "Tsunekazu Saito",
        "Riad S. Wahby"
      ],
      "status": "Draft",
      "id": "cfrg-pairing-friendly"
    },
    "BLS-JOSE-COSE": {
      "title": "Barreto-Lynn-Scott Elliptic Curve Key Representations for JOSE and COSE",
      "href": "https://datatracker.ietf.org/doc/draft-ietf-cose-bls-key-representations/",
      "authors": [
        "Michael B. Jones",
        "Tobias Looker"
      ],
      "status": "Draft"
    },
    "Taming_EdDSAs": {
      "title": "Taming the many EdDSAs",
      "href": "https://eprint.iacr.org/2020/1244",
      "authors": [
        "Konstantinos Chalkias",
        "François Garillot",
        "Valeria Nikolaenko"
      ],
      "date": "2020",
      "publisher": "Cryptology ePrint Archive, Paper 2020/1244",
      "doi": "10.1007/978-3-030-64357-7_4",
      "id": "taming_eddsas"
    },
    "CDL2016": {
      "title": "Anonymous Attestation Using the Strong Diffie Hellman Assumption Revisited",
      "href": "https://eprint.iacr.org/2016/663",
      "authors": [
        "Jan Camenisch",
        "Manu Drijvers",
        "Anja Lehmann"
      ],
      "date": "2016",
      "publisher": "Cryptology ePrint Archive, Paper 2016/663",
      "id": "cdl2016"
    },
    "TZ2023": {
      "title": "Revisiting BBS Signatures",
      "href": "https://eprint.iacr.org/2023/275",
      "authors": [
        "Stefano Tessaro",
        "Chenzhi Zhu"
      ],
      "date": "2023",
      "publisher": "Cryptology ePrint Archive, Paper 2023/275",
      "id": "tz2023"
    },
    "NISTIR8053": {
      "title": "NISTIR 8053: De-Identification of Personal Information",
      "href": "https://nvlpubs.nist.gov/nistpubs/ir/2015/NIST.IR.8053.pdf",
      "authors": [
        "Simson L. Garfinkel"
      ],
      "date": "October 2015",
      "id": "nistir8053"
    },
    "Powar2023": {
      "title": "SoK: Managing risks of linkage attacks on data privacy",
      "authors": [
        "J. Powar",
        "A. R. Beresford"
      ],
      "publisher": "Proceedings on Privacy Enhancing Technologies",
      "date": "2023",
      "href": "https://petsymposium.org/popets/2023/popets-2023-0043.php",
      "id": "powar2023"
    },
    "Pugliese2020": {
      "title": "Long-Term Observation on Browser Fingerprinting: Users' Trackability and Perspective",
      "authors": [
        "G. Pugliese",
        "C. Riess",
        "F. Gassmann",
        "Z. Benenson"
      ],
      "publisher": "Proceedings on Privacy Enhancing Technologies",
      "date": "2020",
      "href": "https://petsymposium.org/popets/2020/popets-2020-0041.php",
      "id": "pugliese2020"
    },
    "CFRG-Blind-BBS-Signature": {
      "title": "Blind BBS Signatures",
      "authors": [
        "V. Kalos",
        "G. Bernstein"
      ],
      "date": "2024",
      "href": "https://www.ietf.org/archive/id/draft-kalos-bbs-blind-signatures-00.html#name-proof-generation",
      "id": "cfrg-blind-bbs-signature"
    },
    "CFRG-Pseudonym-BBS-Signature": {
      "title": "BBS per Verifier Linkability",
      "authors": [
        "V. Kalos"
      ],
      "date": "2023",
      "href": "https://basileioskal.github.io/bbs-per-verifier-id/draft-vasilis-bbs-per-verifier-linkability.html",
      "id": "cfrg-pseudonym-bbs-signature"
    }
  },
  "lint": {
    "informative-dfn": false
  },
  "postProcess": [],
  "xref": [
    "INFRA",
    "I18N-GLOSSARY",
    "VC-DATA-MODEL-2.0",
    "VC-DATA-INTEGRITY"
  ],
  "publishISODate": "2024-03-28T00:00:00.000Z",
  "generatedSubtitle": "W3C Candidate Recommendation Snapshot 28 March 2024"
}</script>
<link rel="stylesheet" href="https://www.w3.org/StyleSheets/TR/2021/W3C-CR"></head>
  <body class="h-entry" data-cite="INFRA I18N-GLOSSARY VC-DATA-MODEL-2.0 VC-DATA-INTEGRITY"><div class="head">
    <p class="logos"><a class="logo" href="https://www.w3.org/"><img crossorigin="" alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72">
  </a></p>
    <h1 id="title" class="title">Data Integrity BBS Cryptosuites v1.0</h1> <h2 id="subtitle" class="subtitle">Achieving Unlinkable Data Integrity with Pairing-based Cryptography</h2>
    <p id="w3c-state"><a href="https://www.w3.org/standards/types#CR">W3C Candidate Recommendation Snapshot</a> <time class="dt-published" datetime="2024-03-28">28 March 2024</time></p>
    <details open="">
      <summary>More details about this document</summary>
      <dl>
        <dt>This version:</dt><dd>
                <a class="u-url" href="https://www.w3.org/TR/2024/CR-vc-di-bbs-20240328/">https://www.w3.org/TR/2024/CR-vc-di-bbs-20240328/</a>
              </dd>
        <dt>Latest published version:</dt><dd>
                <a href="https://www.w3.org/TR/vc-di-bbs/">https://www.w3.org/TR/vc-di-bbs/</a>
              </dd>
        <dt>Latest editor's draft:</dt><dd><a href="https://w3c.github.io/vc-di-bbs/">https://w3c.github.io/vc-di-bbs/</a></dd>
        <dt>History:</dt><dd>
                    <a href="https://www.w3.org/standards/history/vc-di-bbs/">https://www.w3.org/standards/history/vc-di-bbs/</a>
                  </dd><dd>
                    <a href="https://github.com/w3c/vc-di-bbs/commits/">Commit history</a>
                  </dd>
        
        <dt>Implementation report:</dt><dd>
                <a href="https://w3c.github.io/vc-data-integrity/implementations/">https://w3c.github.io/vc-data-integrity/implementations/</a>
              </dd>
        
        
        
        <dt>Editors:</dt><dd class="editor p-author h-card vcard" data-editor-id="140479">
    <a class="u-url url p-name fn" href="https://www.grotto-networking.com/">Greg Bernstein</a> (<span class="p-org org h-org">Invited Expert</span>)
  </dd><dd class="editor p-author h-card vcard" data-editor-id="41758">
    <a class="u-url url p-name fn" href="https://www.linkedin.com/in/manusporny/">Manu Sporny</a> (<a class="p-org org h-org" href="https://www.digitalbazaar.com/">Digital Bazaar</a>)
  </dd>
        
        
        <dt>Feedback:</dt><dd>
        <a href="https://github.com/w3c/vc-di-bbs/">GitHub w3c/vc-di-bbs</a>
        (<a href="https://github.com/w3c/vc-di-bbs/pulls/">pull requests</a>,
        <a href="https://github.com/w3c/vc-di-bbs/issues/new/choose">new issue</a>,
        <a href="https://github.com/w3c/vc-di-bbs/issues/">open issues</a>)
      </dd>
        
        
      </dl>
    </details>
    
    
    <p class="copyright">
    <a href="https://www.w3.org/policies/#copyright">Copyright</a>
    ©
    2024
    
    <a href="https://www.w3.org/">World Wide Web Consortium</a>.
    <abbr title="World Wide Web Consortium">W3C</abbr><sup>®</sup>
    <a href="https://www.w3.org/policies/#Legal_Disclaimer">liability</a>,
    <a href="https://www.w3.org/policies/#W3C_Trademarks">trademark</a> and
    <a rel="license" href="https://www.w3.org/copyright/software-license-2023/" title="W3C Software and Document Notice and License">permissive document license</a> rules apply.
  </p>
    <hr title="Separator for header">
  </div>
    <section id="abstract" class="introductory"><h2>Abstract</h2>
      <p>
This specification describes a Data Integrity Cryptosuite for use when generating
digital signatures using the BBS signature scheme.
The Signature Suite utilizes BBS signatures to provide selective disclosure and
unlinkable derived proofs.
      </p>
    </section>

    <section id="sotd" class="introductory"><h2>Status of This Document</h2><p><em>This section describes the status of this
      document at the time of its publication. A list of current <abbr title="World Wide Web Consortium">W3C</abbr>
      publications and the latest revision of this technical report can be found
      in the <a href="https://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> technical reports index</a> at
      https://www.w3.org/TR/.</em></p>
      <p>
The Working Group is actively seeking implementation feedback for this
specification. In order to exit the Candidate Recommendation phase, the
Working Group has set the requirement of at least two independent
implementations for each mandatory feature in the specification. For details
on the conformance testing process, see the test suites listed in the
<a href="https://w3c.github.io/vc-data-integrity/implementations/">
implementation report</a>.
      </p>
    <p>
    This document was published by the <a href="https://www.w3.org/groups/wg/vc">Verifiable Credentials Working Group</a> as
    a Candidate Recommendation Snapshot using the
        <a href="https://www.w3.org/2023/Process-20231103/#recs-and-notes">Recommendation track</a>. 
  </p><p>Publication as a Candidate Recommendation does not
  imply endorsement by <abbr title="World Wide Web Consortium">W3C</abbr> and its Members. A Candidate Recommendation Snapshot has received
        <a href="https://www.w3.org/2023/Process-20231103/#dfn-wide-review">wide review</a>, is intended to
        gather
        <a href="https://w3c.github.io/vc-data-integrity/implementations/">implementation experience</a>,
        and has commitments from Working Group members to
        <a href="https://www.w3.org/Consortium/Patent-Policy/#sec-Requirements">royalty-free licensing</a>
        for implementations.</p><p>
          This Candidate Recommendation is not expected to advance to Proposed
          Recommendation any earlier than 30 April 2024.
        </p><p>
    
        This document was produced by a group
        operating under the
        <a href="https://www.w3.org/Consortium/Patent-Policy/"><abbr title="World Wide Web Consortium">W3C</abbr> Patent
          Policy</a>.
      
    
                <abbr title="World Wide Web Consortium">W3C</abbr> maintains a
                <a rel="disclosure" href="https://www.w3.org/groups/wg/vc/ipr">public list of any patent disclosures</a>
          made in connection with the deliverables of
          the group; that page also includes
          instructions for disclosing a patent. An individual who has actual
          knowledge of a patent which the individual believes contains
          <a href="https://www.w3.org/Consortium/Patent-Policy/#def-essential">Essential Claim(s)</a>
          must disclose the information in accordance with
          <a href="https://www.w3.org/Consortium/Patent-Policy/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.
        
  </p><p>
                      This document is governed by the
                      <a id="w3c_process_revision" href="https://www.w3.org/2023/Process-20231103/">03 November 2023 <abbr title="World Wide Web Consortium">W3C</abbr> Process Document</a>.
                    </p></section><nav id="toc"><h2 class="introductory" id="table-of-contents">Table of Contents</h2><ol class="toc"><li class="tocline"><a class="tocxref" href="#abstract">Abstract</a></li><li class="tocline"><a class="tocxref" href="#sotd">Status of This Document</a></li><li class="tocline"><a class="tocxref" href="#introduction"><bdi class="secno">1. </bdi>Introduction</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#terminology"><bdi class="secno">1.1 </bdi>Terminology</a></li><li class="tocline"><a class="tocxref" href="#conformance"><bdi class="secno">1.2 </bdi>Conformance</a></li></ol></li><li class="tocline"><a class="tocxref" href="#data-model"><bdi class="secno">2. </bdi>Data Model</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#verification-methods"><bdi class="secno">2.1 </bdi>Verification Methods</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#multikey"><bdi class="secno">2.1.1 </bdi>Multikey</a></li></ol></li><li class="tocline"><a class="tocxref" href="#proof-representations"><bdi class="secno">2.2 </bdi>Proof Representations</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#dataintegrityproof"><bdi class="secno">2.2.1 </bdi>DataIntegrityProof</a></li></ol></li></ol></li><li class="tocline"><a class="tocxref" href="#algorithms"><bdi class="secno">3. </bdi>Algorithms</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#instantiate-cryptosuite"><bdi class="secno">3.1 </bdi>Instantiate Cryptosuite</a></li><li class="tocline"><a class="tocxref" href="#selective-disclosure-functions"><bdi class="secno">3.2 </bdi>Selective Disclosure Functions</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#createshuffledidlabelmapfunction"><bdi class="secno">3.2.1 </bdi>createShuffledIdLabelMapFunction</a></li></ol></li><li class="tocline"><a class="tocxref" href="#bbs-2023-functions"><bdi class="secno">3.3 </bdi>bbs-2023 Functions</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#serializebaseproofvalue"><bdi class="secno">3.3.1 </bdi>serializeBaseProofValue</a></li><li class="tocline"><a class="tocxref" href="#parsebaseproofvalue"><bdi class="secno">3.3.2 </bdi>parseBaseProofValue</a></li><li class="tocline"><a class="tocxref" href="#createdisclosuredata"><bdi class="secno">3.3.3 </bdi>createDisclosureData</a></li><li class="tocline"><a class="tocxref" href="#compresslabelmap"><bdi class="secno">3.3.4 </bdi>compressLabelMap</a></li><li class="tocline"><a class="tocxref" href="#decompresslabelmap"><bdi class="secno">3.3.5 </bdi>decompressLabelMap</a></li><li class="tocline"><a class="tocxref" href="#serializederivedproofvalue"><bdi class="secno">3.3.6 </bdi>serializeDerivedProofValue</a></li><li class="tocline"><a class="tocxref" href="#parsederivedproofvalue"><bdi class="secno">3.3.7 </bdi>parseDerivedProofValue</a></li><li class="tocline"><a class="tocxref" href="#createverifydata"><bdi class="secno">3.3.8 </bdi>createVerifyData</a></li></ol></li><li class="tocline"><a class="tocxref" href="#bbs-2023"><bdi class="secno">3.4 </bdi>bbs-2023</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#create-base-proof-bbs-2023"><bdi class="secno">3.4.1 </bdi>Create Base Proof (bbs-2023)</a></li><li class="tocline"><a class="tocxref" href="#base-proof-transformation-bbs-2023"><bdi class="secno">3.4.2 </bdi>Base Proof Transformation (bbs-2023)</a></li><li class="tocline"><a class="tocxref" href="#base-proof-hashing-bbs-2023"><bdi class="secno">3.4.3 </bdi>Base Proof Hashing (bbs-2023)</a></li><li class="tocline"><a class="tocxref" href="#base-proof-configuration-bbs-2023"><bdi class="secno">3.4.4 </bdi>Base Proof Configuration (bbs-2023)</a></li><li class="tocline"><a class="tocxref" href="#base-proof-serialization-bbs-2023"><bdi class="secno">3.4.5 </bdi>Base Proof Serialization (bbs-2023)</a></li><li class="tocline"><a class="tocxref" href="#add-derived-proof-bbs-2023"><bdi class="secno">3.4.6 </bdi>Add Derived Proof (bbs-2023)</a></li><li class="tocline"><a class="tocxref" href="#verify-derived-proof-bbs-2023"><bdi class="secno">3.4.7 </bdi>Verify Derived Proof (bbs-2023)</a></li></ol></li></ol></li><li class="tocline"><a class="tocxref" href="#optional-features"><bdi class="secno">4. </bdi>Optional Features</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#anonymous-holder-binding"><bdi class="secno">4.1 </bdi>Anonymous Holder Binding</a></li><li class="tocline"><a class="tocxref" href="#pseudonyms-with-issuer-known-pid"><bdi class="secno">4.2 </bdi>Pseudonyms with Issuer-known PID</a></li><li class="tocline"><a class="tocxref" href="#pseudonyms-with-hidden-pid"><bdi class="secno">4.3 </bdi>Pseudonyms with Hidden PID</a></li></ol></li><li class="tocline"><a class="tocxref" href="#security-considerations"><bdi class="secno">5. </bdi>Security Considerations</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#base-proof-security-properties"><bdi class="secno">5.1 </bdi>Base Proof Security Properties</a></li><li class="tocline"><a class="tocxref" href="#derived-proof-security-properties"><bdi class="secno">5.2 </bdi>Derived Proof Security Properties</a></li></ol></li><li class="tocline"><a class="tocxref" href="#privacy-considerations"><bdi class="secno">6. </bdi>Privacy Considerations</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#selective-disclosure-and-data-leakage"><bdi class="secno">6.1 </bdi>Selective Disclosure and Data Leakage</a></li><li class="tocline"><a class="tocxref" href="#selective-disclosure-and-unlinkability"><bdi class="secno">6.2 </bdi>Selective Disclosure and Unlinkability</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#linkage-via-cryptographic-artifacts"><bdi class="secno">6.2.1 </bdi>Linkage via Cryptographic Artifacts</a></li><li class="tocline"><a class="tocxref" href="#linkage-via-vc-processing"><bdi class="secno">6.2.2 </bdi>Linkage via VC Processing</a></li><li class="tocline"><a class="tocxref" href="#linkage-via-json-ld-node-identifiers"><bdi class="secno">6.2.3 </bdi>Linkage via JSON-LD Node Identifiers</a></li><li class="tocline"><a class="tocxref" href="#linkage-via-proof-options-and-mandatory-reveal"><bdi class="secno">6.2.4 </bdi>Linkage via Proof Options and Mandatory Reveal</a></li><li class="tocline"><a class="tocxref" href="#linkage-via-holder-selective-reveal"><bdi class="secno">6.2.5 </bdi>Linkage via Holder Selective Reveal</a></li><li class="tocline"><a class="tocxref" href="#external-vc-system-based-linkage"><bdi class="secno">6.2.6 </bdi>External VC System Based Linkage</a></li></ol></li></ol></li><li class="tocline"><a class="tocxref" href="#test-vectors"><bdi class="secno">A. </bdi>Test Vectors</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#base-proof"><bdi class="secno">A.1 </bdi>Base Proof</a></li><li class="tocline"><a class="tocxref" href="#derived-proof"><bdi class="secno">A.2 </bdi>Derived Proof</a></li></ol></li><li class="tocline"><a class="tocxref" href="#acknowledgements"><bdi class="secno">B. </bdi>Acknowledgements</a></li><li class="tocline"><a class="tocxref" href="#references"><bdi class="secno">C. </bdi>References</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#normative-references"><bdi class="secno">C.1 </bdi>Normative references</a></li><li class="tocline"><a class="tocxref" href="#informative-references"><bdi class="secno">C.2 </bdi>Informative references</a></li></ol></li></ol></nav>

    <section id="introduction"><div class="header-wrapper"><h2 id="x1-introduction"><bdi class="secno">1. </bdi>Introduction</h2><a class="self-link" href="#introduction" aria-label="Permalink for Section 1."></a></div>
      
      <p>
This specification defines a cryptographic suite for the purpose of
creating, verifying, and deriving proofs using the BBS Signature Scheme in
conformance with the Data Integrity [<cite><a class="bibref" data-link-type="biblio" href="#bib-vc-data-integrity" title="Verifiable Credential Data Integrity 1.0">VC-DATA-INTEGRITY</a></cite>] specification. The
BBS signature scheme directly provides for selective disclosure and unlinkable
proofs. It provides four high-level functions that work within the <i>issuer,
holder, verifier</i> model. Specifically, an issuer uses the BBS <code>Sign</code> function to
create a cryptographic value known as a "BBS signature" which is used in signing
the original credential. A holder, on receipt of
a credential signed with BBS, then verifies the credential with the BBS <code>Verify</code>
function.
      </p>
      <p>
The holder then chooses information to selectively disclose from the
received credential and uses the BBS <code>ProofGen</code> function to generate a
cryptographic value, known as a "BBS proof", which is used in creating a proof
for this "derived credential". The cryptographic "BBS proof" value is not linkable
to the original "BBS signature" and a different, unlinkable "BBS proof" can be
generated by the holder for additional "derived credentials", including any
containing the exact same information.
Finally, a verifier uses the BBS <code>ProofVerify</code> function to verify the derived
credential received from the holder.
      </p>
      <p>
Applying the BBS signature scheme to verifiable credentials involves the
processing specified in this document.
In general the suite uses the RDF Dataset Canonicalization Algorithm
[<cite><a class="bibref" data-link-type="biblio" href="#bib-rdf-canon" title="RDF Dataset Canonicalization">RDF-CANON</a></cite>] to transform an input document into its canonical
form. An issuer then uses selective disclosure primitives to separate the
canonical form into mandatory and non-mandatory statements. These are processed
separately with other information to serve as the inputs to the BBS <code>Sign</code>
function along with appropriate key material. This output is used to
generate a secured credential. A holder uses a set of selective disclosure
functions and the BBS <code>Verify</code> function on receipt of the credential
to ascertain validity.
      </p>
      <p>
Similarly, on receipt of a BBS signed credential, a holder uses the RDF Dataset
Canonicalization Algorithm [<cite><a class="bibref" data-link-type="biblio" href="#bib-rdf-canon" title="RDF Dataset Canonicalization">RDF-CANON</a></cite>] to transform an input
document into its canonical form, and then applies selective disclosure
primitives to separate the canonical form into mandatory and selectively
disclosed statements, which are appropriately processed and serve as inputs to
the BBS <code>ProofGen</code> function. Suitably processed, the output of this function
becomes the signed selectively disclosed credential sent to a verifier. Using
canonicalization and selective disclosure primitives, the verifier can then use
the BBS <code>verifyProof</code> function to validate the credential.
      </p>

      <section id="terminology"><div class="header-wrapper"><h3 id="x1-1-terminology"><bdi class="secno">1.1 </bdi>Terminology</h3><a class="self-link" href="#terminology" aria-label="Permalink for Section 1.1"></a></div>
        
        <p>
Terminology used throughout this document is defined in the
<a href="https://www.w3.org/TR/vc-data-integrity/#terminology">Terminology</a> section of the
<cite><a data-matched-text="[[[VC-DATA-INTEGRITY]]]" href="https://www.w3.org/TR/vc-data-integrity/">Verifiable Credential Data Integrity 1.0</a></cite> specification.
        </p>

      </section>

      <section id="conformance"><div class="header-wrapper"><h3 id="x1-2-conformance"><bdi class="secno">1.2 </bdi>Conformance</h3><a class="self-link" href="#conformance" aria-label="Permalink for Section 1.2"></a></div><p>As well as sections marked as non-normative, all authoring guidelines, diagrams, examples, and notes in this specification are non-normative. Everything else in this specification is normative.</p><p>
        The key words <em class="rfc2119">MAY</em>, <em class="rfc2119">MUST</em>, <em class="rfc2119">MUST NOT</em>, <em class="rfc2119">OPTIONAL</em>, and <em class="rfc2119">SHOULD</em> in this document
        are to be interpreted as described in
        <a href="https://datatracker.ietf.org/doc/html/bcp14">BCP 14</a>
        [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">RFC2119</a></cite>] [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc8174" title="Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words">RFC8174</a></cite>]
        when, and only when, they appear in all capitals, as shown here.
      </p>
        <p>
A <dfn id="dfn-conforming-proof" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">conforming proof</dfn> is any concrete expression of the data model
that complies with the normative statements in this specification. Specifically,
all relevant normative statements in Sections
<a href="#data-model" class="sec-ref"><bdi class="secno">2. </bdi>Data Model</a> and <a href="#algorithms" class="sec-ref"><bdi class="secno">3. </bdi>Algorithms</a>
of this document <em class="rfc2119">MUST</em> be enforced.
        </p>

        <p>
A <dfn class="lint-ignore" id="dfn-conforming-processor" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">conforming processor</dfn> is any algorithm realized
as software and/or hardware that generates or consumes a
<a href="#dfn-conforming-proof" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-conforming-proof-1">conforming proof</a>. Conforming processors <em class="rfc2119">MUST</em> produce errors when
non-conforming documents are consumed.
        </p>
	<p>
This document contains examples of JSON and JSON-LD data. Some of these examples
are invalid JSON, as they include features such as inline comments (<code>//</code>)
explaining certain portions and ellipses (<code>...</code>) indicating the omission of
information that is irrelevant to the example. Such parts need to be
removed if implementers want to treat the examples as valid JSON or JSON-LD.
        </p>
      </section>
    </section>

    <section id="data-model"><div class="header-wrapper"><h2 id="x2-data-model"><bdi class="secno">2. </bdi>Data Model</h2><a class="self-link" href="#data-model" aria-label="Permalink for Section 2."></a></div>
      

      <p>
The following sections outline the data model that is used by this specification
for <a data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-verification-method">verification methods</a> and <a data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-data-integrity-proof">data integrity proof</a> formats.
      </p>

      <section id="verification-methods"><div class="header-wrapper"><h3 id="x2-1-verification-methods"><bdi class="secno">2.1 </bdi>Verification Methods</h3><a class="self-link" href="#verification-methods" aria-label="Permalink for Section 2.1"></a></div>
        
        <p>
These verification methods are used to verify Data Integrity Proofs
[<cite><a class="bibref" data-link-type="biblio" href="#bib-vc-data-integrity" title="Verifiable Credential Data Integrity 1.0">VC-DATA-INTEGRITY</a></cite>] produced using BLS12-381 cryptographic key material
that is compliant with [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-SIGNATURE</a></cite>]. The encoding formats for these key types
are provided in this section. Lossless cryptographic key transformation
processes that result in equivalent cryptographic key material <em class="rfc2119">MAY</em> be used
during the processing of digital signatures.
        </p>
        <section id="multikey"><div class="header-wrapper"><h4 id="x2-1-1-multikey"><bdi class="secno">2.1.1 </bdi>Multikey</h4><a class="self-link" href="#multikey" aria-label="Permalink for Section 2.1.1"></a></div>
          
          <p>
The <a href="https://www.w3.org/TR/vc-data-integrity/#multikey">Multikey format</a>, as defined in
[<cite><a class="bibref" data-link-type="biblio" href="#bib-vc-data-integrity" title="Verifiable Credential Data Integrity 1.0">VC-DATA-INTEGRITY</a></cite>], is used to express public keys for the cryptographic
suites defined in this specification.
          </p>

          <p>
The <code>publicKeyMultibase</code> property represents a Multibase-encoded Multikey
expression of a BLS12-381 public key in the G2 group. The encoding of this field
is the two-byte prefix <code>0xeb01</code> followed
by the 96-byte compressed public key data.
The 98-byte value is then encoded using base58-btc (<code>z</code>) as the prefix. Any
other encodings <em class="rfc2119">MUST NOT</em> be allowed.
          </p>

          <p class="advisement">
Developers are advised to not accidentally publish a representation of a private
key. Implementations of this specification will raise errors in the event of a
value other than <code>0xeb01</code> being used in a <code>publicKeyMultibase</code> value.
          </p>

          <div class="example" id="example-a-bls12-381-g2-group-public-key-encoded-as-a-multikey">
        <div class="marker">
    <a class="self-link" href="#example-a-bls12-381-g2-group-public-key-encoded-as-a-multikey">Example<bdi> 1</bdi></a><span class="example-title">: A BLS12-381 G2 group public key, encoded as a Multikey</span>
  </div> <pre aria-busy="false"><code class="hljs">{
  "id": "https://example.com/issuer/123#key-0",
  "type": "Multikey",
  "controller": "https://example.com/issuer/123",
  "publicKeyMultibase": "zUC7EK3ZakmukHhuncwkbySmomv3FmrkmS36E4Ks5rsb6VQSRpoCrx6
  Hb8e2Nk6UvJFSdyw9NK1scFXJp21gNNYFjVWNgaqyGnkyhtagagCpQb5B7tagJu3HDbjQ8h
  5ypoHjwBb"
}</code></pre>
      </div>

          <div class="example" id="example-a-bls12-381-g2-group-public-key-encoded-as-a-multikey-in-a-controller-document">
        <div class="marker">
    <a class="self-link" href="#example-a-bls12-381-g2-group-public-key-encoded-as-a-multikey-in-a-controller-document">Example<bdi> 2</bdi></a><span class="example-title">: A BLS12-381 G2 group public key,
          encoded as a Multikey in a controller document</span>
  </div> <pre aria-busy="false"><code class="hljs">{
  "@context": [
    "https://www.w3.org/ns/did/v1",
    "https://w3id.org/security/data-integrity/v1"
  ],
  "id": "https://example.com/issuer/123",
  "verificationMethod": [{
    "id": "https://example.com/issuer/123#key-1",
    "type": "Multikey",
    "controller": "https://example.com/issuer/123",
    "publicKeyMultibase": "zUC7EK3ZakmukHhuncwkbySmomv3FmrkmS36E4Ks5rsb6VQSRpoCr
    x6Hb8e2Nk6UvJFSdyw9NK1scFXJp21gNNYFjVWNgaqyGnkyhtagagCpQb5B7tagJu3HDbjQ8h
    5ypoHjwBb"
  }]
}</code></pre>
      </div>
        </section>
      </section>

      <section id="proof-representations"><div class="header-wrapper"><h3 id="x2-2-proof-representations"><bdi class="secno">2.2 </bdi>Proof Representations</h3><a class="self-link" href="#proof-representations" aria-label="Permalink for Section 2.2"></a></div>
        

        <section id="dataintegrityproof"><div class="header-wrapper"><h4 id="x2-2-1-dataintegrityproof"><bdi class="secno">2.2.1 </bdi>DataIntegrityProof</h4><a class="self-link" href="#dataintegrityproof" aria-label="Permalink for Section 2.2.1"></a></div>
          

          <p>
A proof contains the attributes specified in the
<a href="https://www.w3.org/TR/vc-data-integrity/#proofs">Proofs section</a>
of [<cite><a class="bibref" data-link-type="biblio" href="#bib-vc-data-integrity" title="Verifiable Credential Data Integrity 1.0">VC-DATA-INTEGRITY</a></cite>] with the following restrictions.
          </p>
          <p>
The <code>verificationMethod</code> property of the proof <em class="rfc2119">MUST</em> be a URL.
Dereferencing the <code>verificationMethod</code> <em class="rfc2119">MUST</em> result in an object
containing a <code>type</code> property with the value set to
<code>Multikey</code>.
          </p>

          <p>
The <code>type</code> property of the proof <em class="rfc2119">MUST</em> be <code>DataIntegrityProof</code>.
          </p>
          <p>
The <code>cryptosuite</code> property of the proof <em class="rfc2119">MUST</em> be <code>bbs-2023</code>.
          </p>
          <p>
The value of the <code>proofValue</code> property of the proof <em class="rfc2119">MUST</em> be a BBS signature or
BBS proof produced according to [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-SIGNATURE</a></cite>] that is serialized and encoded
according to procedures in section <a href="#algorithms" class="sec-ref"><bdi class="secno">3. </bdi>Algorithms</a>.
          </p>
        </section>
      </section>

    </section>

    <section id="algorithms"><div class="header-wrapper"><h2 id="x3-algorithms"><bdi class="secno">3. </bdi>Algorithms</h2><a class="self-link" href="#algorithms" aria-label="Permalink for Section 3."></a></div>
      

      <p>
The following algorithms describe how to use verifiable credentials with
the BBS Signature Scheme [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-SIGNATURE</a></cite>]. When using the BBS signature
scheme the SHA-256 variant <em class="rfc2119">SHOULD</em> be used.
      </p>

      <p>
Implementations <em class="rfc2119">SHOULD</em> fetch and cache <a data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-verification-method">verification method</a> information as
early as possible when adding or verifying proofs. Parameters passed to
functions in this section use information from the <a data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-verification-method">verification
method</a> — such as the public key size — to determine function parameters — such
as the cryptographic hashing algorithm.
      </p>

      <p class="advisement">
When the RDF Dataset Canonicalization Algorithm [<cite><a class="bibref" data-link-type="biblio" href="#bib-rdf-canon" title="RDF Dataset Canonicalization">RDF-CANON</a></cite>] is used,
implementations of that algorithm will detect
<a href="https://www.w3.org/TR/rdf-canon/#dataset-poisoning">dataset poisoning</a>
by default, and abort processing upon detection.
      </p>

      <section id="instantiate-cryptosuite"><div class="header-wrapper"><h3 id="x3-1-instantiate-cryptosuite"><bdi class="secno">3.1 </bdi>Instantiate Cryptosuite</h3><a class="self-link" href="#instantiate-cryptosuite" aria-label="Permalink for Section 3.1"></a></div>
        

        <p>
This algorithm is used to configure a cryptographic suite to be used by the
<a href="https://www.w3.org/TR/vc-data-integrity/#add-proof">Add Proof</a> and
<a href="https://www.w3.org/TR/vc-data-integrity/#verify-proof">Verify Proof</a>
functions in <cite><a data-matched-text="[[[VC-DATA-INTEGRITY]]]" href="https://www.w3.org/TR/vc-data-integrity/">Verifiable Credential Data Integrity 1.0</a></cite>. The algorithm takes an options object
(<a data-link-type="dfn|abstract-op" data-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map">map</a> <var>options</var>) as input and returns a <a data-link-type="dfn|abstract-op" data-lt="data integrity cryptographic suite instance" data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-data-integrity-cryptographic-suite-instance">cryptosuite instance</a> (<a data-link-type="dfn|abstract-op" data-type="dfn" href="https://infra.spec.whatwg.org/#struct">struct</a> <var>cryptosuite</var>).
        </p>

        <ol class="algorithm">
          <li>
Initialize <var>cryptosuite</var> to an empty <a data-link-type="dfn|abstract-op" data-type="dfn" href="https://infra.spec.whatwg.org/#struct">struct</a>.
          </li>
          <li>
If <var>options</var>.<var>type</var> does not equal <code>DataIntegrityProof</code>, return <var>cryptosuite</var>.
          </li>
          <li>
If <var>options</var>.<var>cryptosuite</var> is <code>bbs-2023</code> then:
            <ol class="algorithm">
              <li>
Set <var>cryptosuite</var>.<var>createProof</var> to the algorithm in Section
<a href="#create-base-proof-bbs-2023" data-matched-text="[[[#create-base-proof-bbs-2023]]]" class="sec-ref"><bdi class="secno">3.4.1 </bdi>Create Base Proof (bbs-2023)</a>.
              </li>
              <li>
Set <var>cryptosuite</var>.<var>verifyProof</var> to the algorithm in Section
<a href="#verify-derived-proof-bbs-2023" data-matched-text="[[[#verify-derived-proof-bbs-2023]]]" class="sec-ref"><bdi class="secno">3.4.7 </bdi>Verify Derived Proof (bbs-2023)</a>.
              </li>
            </ol>
          </li>
          <li>
Return <var>cryptosuite</var>.
          </li>
        </ol>

      </section>

      <section id="selective-disclosure-functions"><div class="header-wrapper"><h3 id="x3-2-selective-disclosure-functions"><bdi class="secno">3.2 </bdi>Selective Disclosure Functions</h3><a class="self-link" href="#selective-disclosure-functions" aria-label="Permalink for Section 3.2"></a></div>
        

        <section id="createshuffledidlabelmapfunction"><div class="header-wrapper"><h4 id="x3-2-1-createshuffledidlabelmapfunction"><bdi class="secno">3.2.1 </bdi>createShuffledIdLabelMapFunction</h4><a class="self-link" href="#createshuffledidlabelmapfunction" aria-label="Permalink for Section 3.2.1"></a></div>
          
          <p>
The following algorithm creates a label map factory function that uses an
HMAC to shuffle canonical blank node identifiers. The required input is an HMAC
(previously initialized with a secret key), <var>HMAC</var>. A function,
<em>labelMapFactoryFunction</em>, is produced as output.
          </p>

          <ol class="algorithm">
            <li>
Create a function, <var>labelMapFactoryFunction</var>, with one required input
(a canonical node identifier map, <var>canonicalIdMap</var>), that will
return a blank node identifier map, <em>bnodeIdMap</em>, as output. Set the
function's implementation to:
              <ol class="algorithm">
                <li>
Generate a new empty bnode identifier map, <em>bnodeIdMap</em>.
                </li>
                <li>
For each map entry, <em>entry</em>, in <var>canonicalIdMap</var>:
                  <ol class="algorithm">
                    <li>
Perform an HMAC operation on the canonical identifier from the value in <em>entry</em> to get an HMAC
digest, <em>digest</em>.
                    </li>
                    <li>
Generate a new string value, <em>b64urlDigest</em>, and initialize it to "u"
followed by appending a base64url-no-pad encoded version of the <em>digest</em>
value.
                    </li>
                    <li>
Add a new entry, <var>newEntry</var>, to <em>bnodeIdMap</em> using the key
from <em>entry</em> and <em>b64urlDigest</em> as the value.
                    </li>
                  </ol>
                </li>
                <li>
Derive the shuffled mapping from the <code>bnodeIdMap</code> as follows:
                  <ol class="algorithm">
                    <li>
Set <code>hmacIds</code> to be the sorted array of values from the <code>bnodeIdMap</code>, and set
<code>bnodeKeys</code> to be the ordered array of keys from the <code>bnodeIdMap</code>.
                    </li>
                    <li>
For each key in <code>bnodeKeys</code>, replace the <code>bnodeIdMap</code> value for that key with the
index position of the value in the <code>hmacIds</code> array prefixed by "b", i.e.,
<code>bnodeIdMap.set(bkey, 'b' + hmacIds.indexOf(bnodeIdMap.get(bkey)))</code>.
                    </li>
                  </ol>
                </li>
                <li>
Return <em>bnodeIdMap</em>.
                </li>
              </ol>
            </li>
            <li>
Return <var>labelMapFactoryFunction</var>.
            </li>
          </ol>

          <div class="note" role="note" id="issue-container-generatedID"><div role="heading" class="note-title marker" id="h-note" aria-level="5"><span>Note</span></div><p class="informative">
It should be noted that step 1.2 in the above algorithm is identical to step 1.2
in <a href="https://www.w3.org/TR/vc-di-ecdsa/#createhmacidlabelmapfunction">
Section 3.3.4 <code>createHmacIdLabelMapFunction</code></a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-di-ecdsa" title="The Elliptic Curve Digital Signature Algorithm Cryptosuites v1.0">DI-ECDSA</a></cite>],
so developers might be able to reuse the code or call the function if implementing
both.
          </p></div>
        </section>


      </section>

      <section id="bbs-2023-functions"><div class="header-wrapper"><h3 id="x3-3-bbs-2023-functions"><bdi class="secno">3.3 </bdi>bbs-2023 Functions</h3><a class="self-link" href="#bbs-2023-functions" aria-label="Permalink for Section 3.3"></a></div>
        
        <section id="serializebaseproofvalue"><div class="header-wrapper"><h4 id="x3-3-1-serializebaseproofvalue"><bdi class="secno">3.3.1 </bdi>serializeBaseProofValue</h4><a class="self-link" href="#serializebaseproofvalue" aria-label="Permalink for Section 3.3.1"></a></div>
          
          <p>
The following algorithm serializes the base proof value, including the
BBS signature, HMAC key, and mandatory pointers.
The required inputs are a base signature <var>bbsSignature</var>,
an HMAC key <var>hmacKey</var>, and an array of
<var>mandatoryPointers</var>.
A single <em>base proof</em> string value is produced as output.
          </p>

          <ol class="algorithm">
            <li>
Initialize a byte array, <code>proofValue</code>, that starts with the BBS base proof
header bytes <code>0xd9</code>, <code>0x5d</code>, and <code>0x02</code>.
            </li>
            <li>
Initialize <var>components</var> to an array with five elements containing the values of:
<var>bbsSignature</var>, <var>bbsHeader</var>, <var>publicKey</var>, <var>hmacKey</var>, and <var>mandatoryPointers</var>.
            </li>
            <li>
CBOR-encode <var>components</var> per [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc8949" title="Concise Binary Object Representation (CBOR)">RFC8949</a></cite>] where CBOR tagging <em class="rfc2119">MUST NOT</em> be used on
any of the <var>components</var>. Append the produced encoded value to <var>proofValue</var>.
            </li>
            <li>
Initialize <var>baseProof</var> to a string with the multibase-base64url-no-pad-encoding
of <code>proofValue</code>. That is, return a string starting with "<code>u</code>" and ending with the
base64url-no-pad-encoded value of <var>proofValue</var>.
            </li>
            <li>
Return <var>baseProof</var> as <em>base proof</em>.
            </li>
          </ol>

        </section>

        <section id="parsebaseproofvalue"><div class="header-wrapper"><h4 id="x3-3-2-parsebaseproofvalue"><bdi class="secno">3.3.2 </bdi>parseBaseProofValue</h4><a class="self-link" href="#parsebaseproofvalue" aria-label="Permalink for Section 3.3.2"></a></div>
          
          <p>
The following algorithm parses the components of a <code>bbs-2023</code> selective
disclosure base proof value. The required input is a proof value
(<var>proofValue</var>). A single object, <em>parsed base proof</em>, containing
five  or seven elements, using the names "bbsSignature", "bbsHeader",
"publicKey",
"hmacKey", "mandatoryPointers", and optional feature parameters "pid" and
"signer_blind" is produced  as output.
          </p>

          <ol class="algorithm">
            <li>
Ensure the <code>proofValue</code> string starts with
<span class="codepoint" translate="no">
  <bdi lang="en"><code title="LATIN SMALL LETTER U">u</code></bdi>
  (<code class="codepoint">U+0075</code>
  <code class="uname">LATIN SMALL LETTER U</code>)</span>,
indicating that it is a <code>multibase-base64url-no-pad-encoded</code> value, and throw
an error if it does not.
            </li>
            <li>
Initialize <code>decodedProofValue</code> to the result of base64url-no-pad-decoding the
substring following the leading <code>u</code> in <code>proofValue</code>.
            </li>
            <li>
Ensure that the <code>decodedProofValue</code> starts with the BBS base proof header
bytes <code>0xd9</code>, <code>0x5d</code>, and <code>0x02</code>, and throw an error if it does not.
            </li>
            <li>
Initialize <code>components</code> to an array that is the result of CBOR-decoding the
bytes that follow the three-byte BBS base proof header.
            </li>
            <li>
Return an object with properties set to the following elements, using the names
"bbsSignature", "bbsHeader", "publicKey", "hmacKey", "mandatoryPointers", (and
optional feature parameters) "pid" and "signer_blind"
respectively.
            </li>
          </ol>

        </section>

        <section id="createdisclosuredata"><div class="header-wrapper"><h4 id="x3-3-3-createdisclosuredata"><bdi class="secno">3.3.3 </bdi>createDisclosureData</h4><a class="self-link" href="#createdisclosuredata" aria-label="Permalink for Section 3.3.3"></a></div>
          

          <p>
The following algorithm creates data to be used to generate a derived proof. The
inputs include a JSON-LD document (<var>document</var>), a BBS base proof
(<var>proof</var>), an array of JSON pointers to use to selectively disclose
statements (<var>selectivePointers</var>), an <em class="rfc2119">OPTIONAL</em> BBS
<var>presentationHeader</var> (byte array that defaults to an empty byte array if
not present),
an <em class="rfc2119">OPTIONAL</em>
<var>commitment_with_proof</var> (a byte array), an <em class="rfc2119">OPTIONAL</em> <var>pid</var> value (a byte array),
and any custom JSON-LD API options
(such as a document loader). A single object, <em>disclosure data</em>, is
produced as output, which contains the <code>bbsProof</code>, <code>labelMap</code>,
<code>mandatoryIndexes</code>, <code>selectiveIndexes</code>, <code>presentationHeader</code>, and
<code>revealDocument</code> fields.
          </p>

          <ol class="algorithm">
            <li>
Initialize <code>bbsSignature</code>, <code>bbsHeader</code>, <code>publicKey</code>, <code>hmacKey</code>,
<code>mandatoryPointers</code>, and the optional feature parameters <code>pid</code> and
<code>signer_blind</code> to the values of the associated properties in the object
returned when calling the algorithm in Section
<a href="#parsebaseproofvalue" class="sec-ref"><bdi class="secno">3.3.2 </bdi>parseBaseProofValue</a>, passing the <code>proofValue</code> from <code>proof</code>.
            </li>
            <li>
Initialize <code>hmac</code> to an HMAC API using <code>hmacKey</code>. The HMAC uses the same hash
algorithm used in the signature algorithm, i.e., SHA-256.
            </li>
            <li>
Initialize <code>labelMapFactoryFunction</code> to the result of calling the
<code>createShuffledIdLabelMapFunction</code> algorithm passing <code>hmac</code> as <code>HMAC</code>.
            </li>
            <li>
Initialize <code>combinedPointers</code> to the concatenation of <code>mandatoryPointers</code>
and <code>selectivePointers</code>.
            </li>
            <li>
Initialize <code>groupDefinitions</code> to a map with the following entries: key of
the string <code>"mandatory"</code> and value of <code>mandatoryPointers</code>; key of the string
<code>"selective"</code> and value of <code>selectivePointers</code>; and key of the string <code>"combined"</code>
and value of <code>combinedPointers</code>.
            </li>
            <li>
Initialize <code>groups</code> and <code>labelMap</code> to the result of calling the algorithm in
<a href="https://www.w3.org/TR/vc-di-ecdsa/#canonicalizeandgroup">Section 3.3.16
canonicalizeAndGroup</a> of the [<cite><a class="bibref" data-link-type="biblio" href="#bib-di-ecdsa" title="The Elliptic Curve Digital Signature Algorithm Cryptosuites v1.0">DI-ECDSA</a></cite>] specification, passing <code>document</code>
<code>labelMapFactoryFunction</code>,
<code>groupDefinitions</code>, and any custom JSON-LD
API options. Note: This step transforms the document into an array of canonical
N-Quads whose order has been shuffled based on 'hmac' applied blank node
identifiers, and groups
the N-Quad strings according to selections based on JSON pointers.
            </li>

            <li>
Compute the mandatory indexes relative to their positions in the combined
statement list, i.e., find the position at which a mandatory statement occurs
in the list of combined statements. One method for doing this is given below.
              <ol class="algorithm">
                <li>
Initialize <code>mandatoryIndexes</code> to an empty array. Set <code>mandatoryMatch</code> to
<code>groups.mandatory.matching</code> map; set <code>combinedMatch</code> to
<code>groups.combined.matching</code>; and set <code>combinedIndexes</code> to the ordered array of
just the keys of the <code>combinedMatch</code> map.
                </li>
                <li>
For each key in the <code>mandatoryMatch</code> map, find its index in the <code>combinedIndexes</code>
array (e.g., <code>combinedIndexes.indexOf(key)</code>), and add this value to the
<code>mandatoryIndexes</code> array.
                </li>
              </ol>
            </li>
            <li>
Compute the selective indexes relative to their positions in the non-mandatory
statement list, i.e., find the position at which a selected statement occurs in
the list of non-mandatory statements. One method for doing this is given below.
              <ol class="algorithm">
                <li>
Initialize <code>selectiveIndexes</code> to an empty array. Set <code>selectiveMatch</code> to the
<code>groups.selective.matching</code> map; set <code>mandatoryNonMatch</code> to the map
<code>groups.mandatory.nonMatching</code>; and <code>nonMandatoryIndexes</code> to to the ordered array of
just the keys of the <code>mandatoryNonMatch</code> map.
                </li>
                <li>
For each key in the <code>selectiveMatch</code> map, find its index in the <code>nonMandatoryIndexes</code>
array (e.g., <code>nonMandatoryIndexes.indexOf(key)</code>), and add this value to the
<code>selectiveIndexes</code> array.
                </li>
              </ol>
            </li>
            <li>
Initialize <code>bbsMessages</code> to an array of byte arrays containing the values in the
<code>nonMandatory</code> array of strings encoded using the UTF-8 <a data-type="dfn" href="https://www.w3.org/TR/i18n-glossary/#dfn-character-encoding">character encoding</a>.
            </li>
            <li>
Set <code>bbsProof</code> to the value computed by the appropriate procedure given below
based on the values of the <var>commitment_with_proof</var> and <var>pid</var> options.
              <ol class="algorithm">
                <li>
If both <var>commitment_with_proof</var> and <var>pid</var> options are empty,
set <code>bbsProof</code> to the value computed by the <code>ProofGen</code> procedure from
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-SIGNATURE</a></cite>], i.e.,
<code>ProofGen(PK, signature, header, ph, messages, disclosed_indexes)</code>,
where <code>PK</code> is the original issuers public key, <code>signature</code> is the
<code>bbsSignature</code>, <code>header</code> is the <code>bbsHeader</code>, <code>ph</code> is the  <code>presentationHeader</code>
<code>messages</code> is <code>bbsMessages</code>, and <code>disclosed_indexes</code> is <code>selectiveIndexes</code>.
                </li>
                <li>
If <var>commitment_with_proof</var> is not empty and <var>pid</var> is empty,
set <code>bbsProof</code> to the value computed by the <code>ProofGen</code> procedure from
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-blind-bbs-signature" title="Blind BBS Signatures">CFRG-Blind-BBS-Signature</a></cite>], where <code>PK</code> is the original issuers public key,
<code>signature</code> is the
<code>bbsSignature</code>, <code>header</code> is the <code>bbsHeader</code>, <code>ph</code> is the  <code>presentationHeader</code>
<code>messages</code> is <code>bbsMessages</code>, <code>disclosed_indexes</code> is <code>selectiveIndexes</code>,
<code>commitment_with_proof</code>, and <code>signer_blind</code>. The holder will also furnish its
"secret value" that was used to compute the <code>commitment_with_proof</code>. This is the
"anonymous holder binding" option.
                </li>
                <li>
If <var>pid</var> is not empty, compute the <var>pseudonym</var> according to the procedures given
in [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pseudonym-bbs-signature" title="BBS per Verifier Linkability">CFRG-Pseudonym-BBS-Signature</a></cite>],
and set <code>bbsProof</code> to the value computed by the <code>ProofGen</code> procedure from
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pseudonym-bbs-signature" title="BBS per Verifier Linkability">CFRG-Pseudonym-BBS-Signature</a></cite>], where <code>PK</code> is the original issuers public key,
<code>signature</code> is the
<code>bbsSignature</code>, <code>header</code> is the <code>bbsHeader</code>, <code>ph</code> is the  <code>presentationHeader</code>
<code>messages</code> is <code>bbsMessages</code>, <code>disclosed_indexes</code> is <code>selectiveIndexes</code>, and
<var>pseudonym</var> is the <code>pseudonym</code>. This is for both "pseudonym with issuer known
pid" and "pseudonym with hidden pid" cases.
                </li>
              </ol>
            </li>


            <li>
Initialize <var>revealDocument</var> to the result of the "selectJsonLd"
algorithm, passing <code>document</code>, and <code>combinedPointers</code> as <code>pointers</code>.
            </li>
            <li>
Run the RDF Dataset Canonicalization Algorithm [<cite><a class="bibref" data-link-type="biblio" href="#bib-rdf-canon" title="RDF Dataset Canonicalization">RDF-CANON</a></cite>] on
the joined <var>combinedGroup</var>.<var>deskolemizedNQuads</var>, passing any custom
options, and get the canonical bnode identifier map, <var>canonicalIdMap</var>.
Note: This map includes the canonical blank node identifiers that a verifier
will produce when they canonicalize the reveal document.
            </li>
            <li>
Initialize <var>verifierLabelMap</var> to an empty map. This map will map
the canonical blank node identifiers produced by the verifier when they
canonicalize the revealed document, to the blank node identifiers that were
originally signed in the base proof.
            </li>
            <li>
For each key (<code>inputLabel</code>) and value (<code>verifierLabel</code>) in `canonicalIdMap:
              <ol class="algorithm">
                <li>
Add an entry to <code>verifierLabelMap</code>, using <code>verifierLabel</code> as the key, and the
value associated with <code>inputLabel</code> as a key in <code>labelMap</code> as the value.
                </li>
              </ol>
            </li>
            <li>
Return an object with properties matching <code>bbsProof</code>, "verifierLabelMap" for <code>labelMap</code>,
<code>mandatoryIndexes</code>, <code>selectiveIndexes</code>, <code>revealDocument</code>, and <var>pseudonym</var>, if
computed.
            </li>
          </ol>

        </section>

        <section id="compresslabelmap"><div class="header-wrapper"><h4 id="x3-3-4-compresslabelmap"><bdi class="secno">3.3.4 </bdi>compressLabelMap</h4><a class="self-link" href="#compresslabelmap" aria-label="Permalink for Section 3.3.4"></a></div>
          
          <p>
The following algorithm compresses a label map. The required input is
label map (<var>labelMap</var>). The output is a <em>compressed label map</em>.
          </p>

          <ol class="algorithm">
            <li>
Initialize <code>map</code> to an empty map.
            </li>
            <li>
For each entry (<code>k</code>, <code>v</code>) in <code>labelMap</code>:
              <ol class="algorithm">
                <li>
Add an entry to <code>map</code>, with a key that is a base-10 integer parsed from the
characters following the "c14n" prefix in <code>k</code>, and a value that is a base-10
integer parsed from the characters following the "b" prefix in <code>v</code>.
                </li>
              </ol>
            </li>
            <li>
Return <code>map</code> as <em>compressed label map</em>.
            </li>
          </ol>
        </section>

        <section id="decompresslabelmap"><div class="header-wrapper"><h4 id="x3-3-5-decompresslabelmap"><bdi class="secno">3.3.5 </bdi>decompressLabelMap</h4><a class="self-link" href="#decompresslabelmap" aria-label="Permalink for Section 3.3.5"></a></div>
          

          <p>
The following algorithm decompresses a label map. The required input is a
compressed label map (<var>compressedLabelMap</var>). The output is a
<em>decompressed label map</em>.
          </p>

          <ol class="algorithm">
            <li>
Initialize <code>map</code> to an empty map.
            </li>

            <li>
For each entry (<code>k</code>, <code>v</code>) in <code>compressedLabelMap</code>:
              <ol class="algorithm">
                <li>
Add an entry to <code>map</code>, with a key that adds the prefix "c14n" to <code>k</code>, and a value
that adds a prefix of "b" to <code>v</code>.
                </li>
              </ol>
            </li>
            <li>
Return <code>map</code> as <em>decompressed label map</em>.
            </li>
          </ol>

        </section>

        <section id="serializederivedproofvalue"><div class="header-wrapper"><h4 id="x3-3-6-serializederivedproofvalue"><bdi class="secno">3.3.6 </bdi>serializeDerivedProofValue</h4><a class="self-link" href="#serializederivedproofvalue" aria-label="Permalink for Section 3.3.6"></a></div>
          

          <p>
The following algorithm serializes a derived proof value. The required inputs
are a BBS proof (<var>bbsProof</var>), a label map (<var>labelMap</var>), an
array of mandatory indexes (<var>mandatoryIndexes</var>), an array of
selective indexes (<var>selectiveIndexes</var>), and a BBS presentation header
(<var>presentationHeader</var>).
Optional input is <var>pseudonym</var>.
A single <em>derived proof</em>
value, serialized as a byte string, is produced as output.
          </p>

          <ol class="algorithm">
            <li>
Initialize <code>compressedLabelMap</code> to the result of calling the algorithm in
Section <a href="#compresslabelmap" class="sec-ref"><bdi class="secno">3.3.4 </bdi>compressLabelMap</a>, passing <code>labelMap</code> as the parameter.
            </li>
            <li>
Initialize a byte array, <code>proofValue</code>, that starts with the BBS disclosure
proof header bytes <code>0xd9</code>, <code>0x5d</code>, and <code>0x03</code>.
            </li>
            <li>
Initialize <var>components</var> to an array with elements containing the values of
<var>bbsProof</var>, <var>compressedLabelMap</var>, <var>mandatoryIndexes</var>, <var>selectiveIndexes</var>,
<var>presentationHeader</var>, and, if provided,<var>pseudonym</var>.
            </li>
            <li>
CBOR-encode <var>components</var> per [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc8949" title="Concise Binary Object Representation (CBOR)">RFC8949</a></cite>] where CBOR tagging <em class="rfc2119">MUST NOT</em> be used on
any of the <var>components</var>. Append the produced encoded value to <var>proofValue</var>.
            </li>
            <li>
Return the <em>derived proof</em> as a string with the
multibase-base64url-no-pad-encoding of <var>proofValue</var>. That is, return a string
starting with "<code>u</code>" and ending with the base64url-no-pad-encoded value of
<code>proofValue</code>.
            </li>
          </ol>

        </section>

        <section id="parsederivedproofvalue"><div class="header-wrapper"><h4 id="x3-3-7-parsederivedproofvalue"><bdi class="secno">3.3.7 </bdi>parseDerivedProofValue</h4><a class="self-link" href="#parsederivedproofvalue" aria-label="Permalink for Section 3.3.7"></a></div>
          

          <p>
The following algorithm parses the components of the derived proof value.
The required input is a derived proof value (<var>proofValue</var>). A
single <em>derived proof value</em> object is produced as output, which
contains a set of five or six elements, having the names <code>bbsProof</code>, <code>labelMap</code>,
<code>mandatoryIndexes</code>, <code>selectiveIndexes</code>, <code>presentationHeader</code>, and the optional
<code>pseudonym</code> parameter.
          </p>

          <ol class="algorithm">
            <li>
Ensure the <code>proofValue</code> string starts with
<span class="codepoint" translate="no">
  <bdi lang="en"><code title="LATIN SMALL LETTER U">u</code></bdi>
  (<code class="codepoint">U+0075</code>,
  <code class="uname">LATIN SMALL LETTER U</code>)</span>, indicating that
it is a <code>multibase-base64url-no-pad-encoded</code> value, and throw an error if it does
not.
            </li>
            <li>
Initialize <code>decodedProofValue</code> to the result of base64url-no-pad-decoding the
substring that follows the leading <code>u</code> in <code>proofValue</code>.
            </li>
            <li>
Ensure that the <code>decodedProofValue</code> starts with the BBS disclosure proof
header bytes <code>0xd9</code>, <code>0x5d</code>, and <code>0x03</code>, and throw an error if it does not.
            </li>
            <li>
Initialize <code>components</code> to an array that is the result of CBOR-decoding the
bytes that follow the three-byte BBS disclosure proof header. Ensure the result
is an array of five or six elements —
a byte array, a map of integers to integers, an
array of integers, another array of integers, and a byte array; otherwise, throw
an error.
            </li>
            <li>
Replace the second element in <code>components</code> using the result of calling the
algorithm in Section <a href="#decompresslabelmap" class="sec-ref"><bdi class="secno">3.3.5 </bdi>decompressLabelMap</a>, passing the existing
second element of <code>components</code> as <code>compressedLabelMap</code>.
            </li>
            <li>
Return <em>derived proof value</em> as an object with properties set to the five
elements, using the names <code>bbsProof</code>, <code>labelMap</code>, <code>mandatoryIndexes</code>,
<code>selectiveIndexes</code>, <code>presentationHeader</code>, and optional <code>pseudonym</code>, respectively.
            </li>
          </ol>

        </section>

        <section id="createverifydata"><div class="header-wrapper"><h4 id="x3-3-8-createverifydata"><bdi class="secno">3.3.8 </bdi>createVerifyData</h4><a class="self-link" href="#createverifydata" aria-label="Permalink for Section 3.3.8"></a></div>
          

          <p>
The following algorithm creates the data needed to perform verification of a
BBS-protected <a data-type="dfn" href="https://www.w3.org/TR/vc-data-model-2.0/#dfn-verifiable-credential">verifiable credential</a>. The inputs include a JSON-LD
document (<var>document</var>), a BBS disclosure proof (<var>proof</var>),
and any custom JSON-LD API options (such as a document loader). A single
<em>verify data</em> object value is produced as output containing the following
fields: <code>bbsProof</code>, <code>proofHash</code>, <code>mandatoryHash</code>, <code>selectedIndexes</code>,
<code>presentationHeader</code>, and <code>nonMandatory</code>.
          </p>

          <ol class="algorithm">
            <li>
Initialize <code>proofHash</code> to the result of performing RDF Dataset Canonicalization
[<cite><a class="bibref" data-link-type="biblio" href="#bib-rdf-canon" title="RDF Dataset Canonicalization">RDF-CANON</a></cite>] on the proof options, i.e., the proof  portion of the document
with the <code>proofValue</code> removed. The hash used is the same as that used in
the signature algorithm, i.e., SHA-256. Note: This step can be
performed in parallel; it only needs to be completed before this algorithm needs
to use the <code>proofHash</code> value.
            </li>
            <li>
Initialize <code>bbsProof</code>, <code>labelMap</code>, <code>mandatoryIndexes</code>, <code>selectiveIndexes</code>,
<code>presentationHeader</code>, and <code>pseudonym</code> to the values associated with their
property names in the
object returned when calling the algorithm in Section
<a href="#parsederivedproofvalue" class="sec-ref"><bdi class="secno">3.3.7 </bdi>parseDerivedProofValue</a>, passing <code>proofValue</code> from <code>proof</code>.
            </li>
            <li>
Initialize <code>labelMapFactoryFunction</code> to the result of calling the
"<code>createLabelMapFunction</code>" algorithm.
            </li>
            <li>
Initialize <code>nquads</code> to the result of calling the "<code>labelReplacementCanonicalize</code>"
algorithm of [<cite><a class="bibref" data-link-type="biblio" href="#bib-di-ecdsa" title="The Elliptic Curve Digital Signature Algorithm Cryptosuites v1.0">DI-ECDSA</a></cite>], passing <code>document</code>, <code>labelMapFactoryFunction</code>, and
any custom
JSON-LD API options. Note: This step transforms the document into an array of
canonical N-Quads with pseudorandom blank node identifiers based on <code>labelMap</code>.
            </li>
            <li>
Initialize <code>mandatory</code> to an empty array.
            </li>
            <li>
Initialize <code>nonMandatory</code> to an empty array.
            </li>
            <li>
For each entry (<code>index</code>, <code>nq</code>) in <code>nquads</code>, separate the N-Quads into mandatory
and non-mandatory categories:
              <ol class="algorithm">
                <li>
If <code>mandatoryIndexes</code> includes <code>index</code>, add <code>nq</code> to <code>mandatory</code>.
                </li>
                <li>
Otherwise, add <code>nq</code> to <code>nonMandatory</code>.
                </li>
              </ol>
            </li>
            <li>
Initialize <code>mandatoryHash</code> to the result of calling the "<code>hashMandatory</code>"
primitive, passing <code>mandatory</code>.
            </li>
            <li>
Return an object with properties matching <code>baseSignature</code>, <code>proofHash</code>,
<code>nonMandatory</code>, <code>mandatoryHash</code>, <code>selectiveIndexes</code>, and <code>pseudonym</code>.
            </li>
          </ol>

        </section>

      </section>

      <section id="bbs-2023"><div class="header-wrapper"><h3 id="x3-4-bbs-2023"><bdi class="secno">3.4 </bdi>bbs-2023</h3><a class="self-link" href="#bbs-2023" aria-label="Permalink for Section 3.4"></a></div>
        

        <p>
The <code>bbs-2023</code> cryptographic suite takes an input document, canonicalizes
the document using the Universal RDF Dataset Canonicalization Algorithm
[<cite><a class="bibref" data-link-type="biblio" href="#bib-rdf-canon" title="RDF Dataset Canonicalization">RDF-CANON</a></cite>], and then applies a number of transformations and cryptographic
operations resulting in the production of a data integrity proof. The algorithms
in this section also include the verification of such a data integrity proof.
        </p>

        <section id="create-base-proof-bbs-2023"><div class="header-wrapper"><h4 id="x3-4-1-create-base-proof-bbs-2023"><bdi class="secno">3.4.1 </bdi>Create Base Proof (bbs-2023)</h4><a class="self-link" href="#create-base-proof-bbs-2023" aria-label="Permalink for Section 3.4.1"></a></div>
          

          <p>
The following algorithm specifies how to create a <a data-link-type="dfn|abstract-op" data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-data-integrity-proof">data integrity proof</a> given
an <a data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-unsecured-data-document">unsecured data document</a>. Required inputs are an
<a data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-unsecured-data-document">unsecured data document</a> (<a data-link-type="dfn|abstract-op" data-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map">map</a> <var>unsecuredDocument</var>), and a set of proof
options (<a data-link-type="dfn|abstract-op" data-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map">map</a> <var>options</var>). A <a data-link-type="dfn|abstract-op" data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-data-integrity-proof">data integrity proof</a> (<a data-link-type="dfn|abstract-op" data-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map">map</a>), or an error,
is produced as output.
          </p>

          <ol class="algorithm">
            <li>
Let <var>proof</var> be a clone of the proof options, <var>options</var>.
            </li>
            <li>
Let <var>proofConfig</var> be the result of running the algorithm in
Section <a href="#base-proof-configuration-bbs-2023" data-matched-text="[[[#base-proof-configuration-bbs-2023]]]" class="sec-ref"><bdi class="secno">3.4.4 </bdi>Base Proof Configuration (bbs-2023)</a> with
<var>options</var> passed as a parameter.
            </li>
            <li>
Let <var>transformedData</var> be the result of running the algorithm in Section
<a href="#base-proof-transformation-bbs-2023" data-matched-text="[[[#base-proof-transformation-bbs-2023]]]" class="sec-ref"><bdi class="secno">3.4.2 </bdi>Base Proof Transformation (bbs-2023)</a> with <var>unsecuredDocument</var>,
<var>proofConfig</var>, and <var>options</var> passed as parameters.
            </li>
            <li>
Let <var>hashData</var> be the result of running the algorithm in Section
<a href="#base-proof-hashing-bbs-2023" data-matched-text="[[[#base-proof-hashing-bbs-2023]]]" class="sec-ref"><bdi class="secno">3.4.3 </bdi>Base Proof Hashing (bbs-2023)</a> with <var>transformedData</var> and <var>proofConfig</var>
passed as a parameters.
            </li>
            <li>
Let <var>proofBytes</var> be the result of running the algorithm in Section
<a href="#base-proof-serialization-bbs-2023" data-matched-text="[[[#base-proof-serialization-bbs-2023]]]" class="sec-ref"><bdi class="secno">3.4.5 </bdi>Base Proof Serialization (bbs-2023)</a> with <var>hashData</var> and
<var>options</var> passed as parameters.
            </li>
            <li>
Let <var>proof</var>.<var>proofValue</var> be a <a href="https://www.w3.org/TR/vc-data-integrity/#multibase-0">
base64url-encoded Multibase value</a> of the <var>proofBytes</var>.
            </li>
            <li>
Return <var>proof</var> as the <a data-link-type="dfn|abstract-op" data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-data-integrity-proof">data integrity proof</a>.
            </li>
          </ol>

        </section>

        <section id="base-proof-transformation-bbs-2023"><div class="header-wrapper"><h4 id="x3-4-2-base-proof-transformation-bbs-2023"><bdi class="secno">3.4.2 </bdi>Base Proof Transformation (bbs-2023)</h4><a class="self-link" href="#base-proof-transformation-bbs-2023" aria-label="Permalink for Section 3.4.2"></a></div>
          
          <p>
The following algorithm specifies how to transform an unsecured input document
into a transformed document that is ready to be provided as input to the
hashing algorithm in Section <a href="#base-proof-hashing-bbs-2023" class="sec-ref"><bdi class="secno">3.4.3 </bdi>Base Proof Hashing (bbs-2023)</a>.
          </p>
          <p>
Required inputs to this algorithm are an
<a href="https://www.w3.org/TR/vc-data-integrity/#dfn-unsecured-data-document">
unsecured data document</a> (<var>unsecuredDocument</var>) and
transformation options (<var>options</var>). The
transformation options <em class="rfc2119">MUST</em> contain a type identifier for the
<a href="https://www.w3.org/TR/vc-data-integrity/#dfn-cryptosuite">
cryptographic suite</a> (<var>type</var>), a cryptosuite
identifier (<var>cryptosuite</var>), and a verification method
(<var>verificationMethod</var>). The transformation options <em class="rfc2119">MUST</em> contain an
array of mandatory JSON pointers (<var>mandatoryPointers</var>) and <em class="rfc2119">MAY</em> contain
additional options, such as a JSON-LD document loader. A <em>transformed data
document</em> is produced as output. Whenever this algorithm encodes strings, it
<em class="rfc2119">MUST</em> use UTF-8 encoding.
          </p>
          <ol class="algorithm">
            <li>
Initialize <var>hmac</var> to an HMAC API using a locally generated and exportable HMAC
key. The HMAC uses the same hash algorithm used in the signature algorithm,
i.e., SHA-256. Per the recommendations of [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc2104" title="HMAC: Keyed-Hashing for Message Authentication">RFC2104</a></cite>], the HMAC key <em class="rfc2119">MUST</em> be the
same length as the digest size; for SHA-256, this is 256 bits or 32 bytes.
            </li>
            <li>
Initialize <code>labelMapFactoryFunction</code> to the result of calling the
<code>createShuffledIdLabelMapFunction</code> algorithm passing <code>hmac</code> as <code>HMAC</code>.
            </li>
            <li>
Initialize <code>groupDefinitions</code> to a map with an entry with a key of the string
"<code>mandatory</code>" and a value of <var>mandatoryPointers</var>.
            </li>
            <li>
Initialize <code>groups</code> to the result of calling the algorithm in
<a href="https://www.w3.org/TR/vc-di-ecdsa/#canonicalizeandgroup">Section 3.3.16
canonicalizeAndGroup</a> of the [<cite><a class="bibref" data-link-type="biblio" href="#bib-di-ecdsa" title="The Elliptic Curve Digital Signature Algorithm Cryptosuites v1.0">DI-ECDSA</a></cite>] specification, passing
<code>labelMapFactoryFunction</code>,
<code>groupDefinitions</code>, <code>unsecuredDocument</code> as <code>document</code>, and any custom JSON-LD
API options. Note: This step transforms the document into an array of canonical
N-Quads whose order has been shuffled based on 'hmac' applied blank node
identifiers, and groups
the N-Quad strings according to selections based on JSON pointers.
            </li>
            <li>
Initialize <code>mandatory</code> to the values in the <code>groups.mandatory.matching</code> map.
            </li>
            <li>
Initialize <code>nonMandatory</code> to the values in the <code>groups.mandatory.nonMatching</code>
map.
            </li>
            <li>
Initialize <code>hmacKey</code> to the result of exporting the HMAC key from <code>hmac</code>.
            </li>
            <li>
Return an object with "<code>mandatoryPointers</code>" set to <code>mandatoryPointers</code>,
"<code>mandatory</code>" set to <code>mandatory</code>, "<code>nonMandatory</code>" set to <code>nonMandatory</code>,
and "<code>hmacKey</code>" set to <code>hmacKey</code>.
            </li>
          </ol>
        </section>

        <section id="base-proof-hashing-bbs-2023"><div class="header-wrapper"><h4 id="x3-4-3-base-proof-hashing-bbs-2023"><bdi class="secno">3.4.3 </bdi>Base Proof Hashing (bbs-2023)</h4><a class="self-link" href="#base-proof-hashing-bbs-2023" aria-label="Permalink for Section 3.4.3"></a></div>
          

          <p>
The following algorithm specifies how to cryptographically hash a
<em>transformed data document</em> and <em>proof configuration</em>
into cryptographic hash data that is ready to be provided as input to the
algorithms in Section <a href="#base-proof-serialization-bbs-2023" class="sec-ref"><bdi class="secno">3.4.5 </bdi>Base Proof Serialization (bbs-2023)</a>.
          </p>

          <p>
The required inputs to this algorithm are a <em>transformed data document</em>
(<var>transformedDocument</var>) and <em>canonical proof configuration</em>
(<var>canonicalProofConfig</var>). A <em>hash data</em> value represented
as an object is produced as output.
          </p>

          <ol class="algorithm">
            <li>
Initialize <code>proofHash</code> to the result of calling the RDF Dataset Canonicalization
algorithm [<cite><a class="bibref" data-link-type="biblio" href="#bib-rdf-canon" title="RDF Dataset Canonicalization">RDF-CANON</a></cite>] on <code>canonicalProofConfig</code> and then cryptographically
hashing the result using the same hash that is used by the signature algorithm,
i.e., SHA-256. Note: This step can be performed in parallel;
it only needs to be completed before this algorithm terminates, as the result is
part of the return value.
            </li>
            <li>
Initialize <code>mandatoryHash</code> to the result of calling the the algorithm in
<a href="https://www.w3.org/TR/vc-di-ecdsa/#hashmandatorynquads">Section 3.3.17
hashMandatoryNQuads</a> of the [<cite><a class="bibref" data-link-type="biblio" href="#bib-di-ecdsa" title="The Elliptic Curve Digital Signature Algorithm Cryptosuites v1.0">DI-ECDSA</a></cite>] specification, passing
<var>transformedDocument</var>.<code>mandatory</code> and using the SHA-256
algorithm.
            </li>
            <li>
Initialize <code>hashData</code> as a deep copy of <var>transformedDocument</var>, and
add <code>proofHash</code> as "<code>proofHash</code>" and <code>mandatoryHash</code> as "<code>mandatoryHash</code>" to that
object.
            </li>
            <li>
Return <code>hashData</code> as <em>hash data</em>.
            </li>
          </ol>

        </section>

        <section id="base-proof-configuration-bbs-2023"><div class="header-wrapper"><h4 id="x3-4-4-base-proof-configuration-bbs-2023"><bdi class="secno">3.4.4 </bdi>Base Proof Configuration (bbs-2023)</h4><a class="self-link" href="#base-proof-configuration-bbs-2023" aria-label="Permalink for Section 3.4.4"></a></div>
          

          <p>
The following algorithm specifies how to generate a
<em>proof configuration</em> from a set of <em>proof options</em>
that is used as input to the
<a href="#base-proof-hashing-bbs-2023">base proof hashing algorithm</a>.
          </p>

          <p>
The required inputs to this algorithm are <em>proof options</em>
(<var>options</var>). The <em>proof options</em> <em class="rfc2119">MUST</em> contain a type identifier
for the
<a href="https://www.w3.org/TR/vc-data-integrity/#dfn-cryptosuite">
cryptographic suite</a> (<var>type</var>) and <em class="rfc2119">MUST</em> contain a cryptosuite
identifier (<var>cryptosuite</var>). A <em>proof configuration</em>
object is produced as output.
          </p>

          <ol class="algorithm">
            <li>
Let <var>proofConfig</var> be a clone of the <var>options</var> object.
            </li>
            <li>
If <var>proofConfig</var>.<var>type</var> is not set to <code>DataIntegirtyProof</code> and/or
<var>proofConfig</var>.<var>cryptosuite</var> is not set to <code>bbs-2023</code>, an
<code>INVALID_PROOF_CONFIGURATION</code> error <em class="rfc2119">MUST</em> be raised.
            </li>
            <li>
If <var>proofConfig</var>.<var>created</var> is set and if the value is not a
valid [<cite><a class="bibref" data-link-type="biblio" href="#bib-xmlschema11-2" title="W3C XML Schema Definition Language (XSD) 1.1 Part 2: Datatypes">XMLSCHEMA11-2</a></cite>] datetime, an <code>INVALID_PROOF_DATETIME</code> error <em class="rfc2119">MUST</em> be
raised.
            </li>
            <li>
Set <var>proofConfig</var>.|@context| to
<var>unsecuredDocument</var>.|@context|.
            </li>
            <li>
Let <var>canonicalProofConfig</var> be the result of applying the Universal RDF Dataset
Canonicalization Algorithm [<cite><a class="bibref" data-link-type="biblio" href="#bib-rdf-canon" title="RDF Dataset Canonicalization">RDF-CANON</a></cite>] to the <var>proofConfig</var>.
            </li>
            <li>
Return <var>canonicalProofConfig</var>.
            </li>
          </ol>

        </section>


        <section id="base-proof-serialization-bbs-2023"><div class="header-wrapper"><h4 id="x3-4-5-base-proof-serialization-bbs-2023"><bdi class="secno">3.4.5 </bdi>Base Proof Serialization (bbs-2023)</h4><a class="self-link" href="#base-proof-serialization-bbs-2023" aria-label="Permalink for Section 3.4.5"></a></div>
          

          <p>
The following algorithm, to be called by an issuer of a BBS-protected Verifiable
Credential, specifies how to create a base proof. The base proof is to be
given only to the holder, who is responsible for generating a derived proof from
it, exposing only selectively disclosed details in the proof to a verifier. This
algorithm is designed to be used in conjunction with the algorithms defined
in the Data Integrity [<cite><a class="bibref" data-link-type="biblio" href="#bib-vc-data-integrity" title="Verifiable Credential Data Integrity 1.0">VC-DATA-INTEGRITY</a></cite>] specification,
<a href="https://www.w3.org/TR/vc-data-integrity/#algorithms">
Section 4: Algorithms</a>. Required inputs are
cryptographic hash data (<var>hashData</var>) and
<em>proof options</em> (<var>options</var>).
Optional inputs include a <var>commitment_with_proof</var> byte array and/or a
<var>use_pseudonyms</var> boolean.
The <em>proof options</em> <em class="rfc2119">MUST</em> contain a type identifier for the
<a href="https://www.w3.org/TR/vc-data-integrity/#dfn-cryptosuite">
cryptographic suite</a> (<var>type</var>) and <em class="rfc2119">MAY</em> contain a cryptosuite
identifier (<var>cryptosuite</var>). A single <em>digital proof</em> value
represented as series of bytes is produced as output.
          </p>

          <ol class="algorithm">
            <li>
Initialize <code>proofHash</code>, <code>mandatoryPointers</code>, <code>mandatoryHash</code>, <code>nonMandatory</code>,
and <code>hmacKey</code> to the values associated with their property names in
<var>hashData</var>.
            </li>
            <li>
Initialize <code>bbsHeader</code> to the concatenation of <code>proofHash</code> and <code>mandatoryHash</code> in
that order.
            </li>
            <li>
Initialize <code>bbsMessages</code> to an array of byte arrays containing the values in the
<code>nonMandatory</code> array of strings encoded using the UTF-8 <a data-type="dfn" href="https://www.w3.org/TR/i18n-glossary/#dfn-character-encoding">character encoding</a>.
            </li>
            <li>
Compute the <code>bbsSignature</code> using the procedures below, dependent on the values
of <var>commitment_with_proof</var> and <var>use_pseudonyms</var> options.
              <ol class="algorithm">
                <li>
If <var>commitment_with_proof</var> is empty and <var>use_pseudonyms</var> is false, compute the
<code>bbsSignature</code> using the <code>Sign</code> procedure of [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-Signature</a></cite>],
with appropriate key material, <code>bbsHeader</code> for the <code>header</code>, and <code>bbsMessages</code>
for the <code>messages</code>.
                </li>
                <li>
If <var>commitment_with_proof</var> is not empty and <var>use_pseudonyms</var> is false, compute the
<code>bbsSignature</code> using the <code>Sign</code> procedure of [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-blind-bbs-signature" title="Blind BBS Signatures">CFRG-Blind-BBS-Signature</a></cite>],
with appropriate key material, <code>bbsHeader</code> for the <code>header</code>, and <code>bbsMessages</code>
for the <code>messages</code>. If the signing procedure uses the optional <var>signer_blind</var>
parameter, retain this value for use when calling
<a href="#serializebaseproofvalue" class="sec-ref"><bdi class="secno">3.3.1 </bdi>serializeBaseProofValue</a> (below). This provides for the
"anonymous holder binding" feature.
                </li>
                <li>
If <var>commitment_with_proof</var> is empty and <var>use_pseudonyms</var> is true, generate a
cryptographically random 32 byte <var>pid</var> value. Compute the
<code>bbsSignature</code> using the <code>Sign</code> procedure of [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pseudonym-bbs-signature" title="BBS per Verifier Linkability">CFRG-Pseudonym-BBS-Signature</a></cite>],
with appropriate key material, <code>bbsHeader</code> for the <code>header</code>, <code>bbsMessages</code>
for the <code>messages</code>, and <var>pid</var> for the <code>pid</code>. Retain the <var>pid</var> value for use when
calling <a href="#serializebaseproofvalue" class="sec-ref"><bdi class="secno">3.3.1 </bdi>serializeBaseProofValue</a> below.
This provides for "pseudonym with issuer known pid".
                </li>
                <li>
If <var>commitment_with_proof</var> is not empty and <var>use_pseudonyms</var> is true, compute
the <code>bbsSignature</code> using the <code>Sign</code> procedure of
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pseudonym-bbs-signature" title="BBS per Verifier Linkability">CFRG-Pseudonym-BBS-Signature</a></cite>], with appropriate key material, <code>bbsHeader</code>
for the <code>header</code>, <code>bbsMessages</code> for the <code>messages</code>, and <var>commitment_with_proof</var>
for the <code>commitment_with_proof</code>. If the signing procedure uses the optional
<var>signer_blind</var> parameter retain this value for use when calling
<a href="#serializebaseproofvalue" class="sec-ref"><bdi class="secno">3.3.1 </bdi>serializeBaseProofValue</a> below.
This provides for the "pseudonym with hidden pid" feature.
                </li>
              </ol>
            </li>
            <li>
Initialize `proofValue to the result of calling the algorithm in Section
<a href="#serializebaseproofvalue" class="sec-ref"><bdi class="secno">3.3.1 </bdi>serializeBaseProofValue</a>, passing <code>bbsSignature</code>, <code>bbsHeader</code>,
<code>publicKey</code>, <code>hmacKey</code>, <code>mandatoryPointers</code>, <code>pid</code>, and <code>signer_blind</code> values as
paramters. Use empty byte arrays for <code>pid</code> and <code>signer_blind</code> if they are not
used.
Note <code>publicKey</code> is a byte array of the public key, encoded according to
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-SIGNATURE</a></cite>].
            </li>
            <li>
Return <code>proofValue</code> as <em>digital proof</em>.
            </li>
          </ol>
        </section>


        <section id="add-derived-proof-bbs-2023"><div class="header-wrapper"><h4 id="x3-4-6-add-derived-proof-bbs-2023"><bdi class="secno">3.4.6 </bdi>Add Derived Proof (bbs-2023)</h4><a class="self-link" href="#add-derived-proof-bbs-2023" aria-label="Permalink for Section 3.4.6"></a></div>
          

          <p>
The following algorithm, to be called by a holder of a <code>bbs-2023</code>-protected
<a data-type="dfn" href="https://www.w3.org/TR/vc-data-model-2.0/#dfn-verifiable-credential">verifiable credential</a>, creates a selective disclosure derived proof.
The derived proof is to be given to the <a data-type="dfn" href="https://www.w3.org/TR/vc-data-model-2.0/#dfn-verifier">verifier</a>. The inputs include a
JSON-LD document (<var>document</var>), a BBS base proof
(<var>proof</var>), an array of JSON pointers to use to selectively disclose
statements (<var>selectivePointers</var>), an <em class="rfc2119">OPTIONAL</em> BBS
<var>presentationHeader</var> (a byte array), an <em class="rfc2119">OPTIONAL</em>
<var>commitment_with_proof</var> (a byte array), an <em class="rfc2119">OPTIONAL</em> <var>pid</var> value (a byte array),
and any custom JSON-LD API options,
such as a document loader. A single <em>selectively revealed document</em>
value, represented as an object, is produced as output.
          </p>

          <ol>
            <li>
Initialize <code>bbsProof</code>,  <code>labelMap</code>, <code>mandatoryIndexes</code>, <code>selectiveIndexes</code>, and
<code>revealDocument</code> to the values associated with their
property names in the object returned when calling the algorithm in
Section <a href="#createdisclosuredata" class="sec-ref"><bdi class="secno">3.3.3 </bdi>createDisclosureData</a>, passing the <code>document</code>, <code>proof</code>,
<code>selectivePointers</code>, <code>presentationHeader</code>, and any custom JSON-LD API options,
such as a document loader.
            </li>
            <li>
Initialize <code>newProof</code> to a shallow copy of <code>proof</code>.
            </li>
            <li>
Replace <code>proofValue</code> in <code>newProof</code> with the result of calling the algorithm
in Section <a href="#serializederivedproofvalue" class="sec-ref"><bdi class="secno">3.3.6 </bdi>serializeDerivedProofValue</a>, passing <code>bbsProof</code>,
<code>labelMap</code>, <code>mandatoryIndexes</code>, <code>selectiveIndexes</code>, <var>commitment_with_proof</var>, and
<var>pid</var>.
            </li>
            <li>
Set the value of the "<code>proof</code>" property in <code>revealDocument</code> to <code>newProof</code>.
            </li>
            <li>
Return <code>revealDocument</code> as the <em>selectively revealed document</em>.
            </li>
          </ol>

        </section>

        <section id="verify-derived-proof-bbs-2023"><div class="header-wrapper"><h4 id="x3-4-7-verify-derived-proof-bbs-2023"><bdi class="secno">3.4.7 </bdi>Verify Derived Proof (bbs-2023)</h4><a class="self-link" href="#verify-derived-proof-bbs-2023" aria-label="Permalink for Section 3.4.7"></a></div>
          

          <p>
The following algorithm specifies how to verify a <a data-link-type="dfn|abstract-op" data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-data-integrity-proof">data integrity proof</a> given
an <a data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-secured-data-document">secured data document</a>. Required inputs are a
<a data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-secured-data-document">secured data document</a> (<a data-link-type="dfn|abstract-op" data-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map">map</a> <var>securedDocument</var>). This algorithm returns
a <dfn id="dfn-verification-result" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">verification result</dfn>, which is a <a data-link-type="dfn|abstract-op" data-type="dfn" href="https://infra.spec.whatwg.org/#struct">struct</a> whose
<a data-link-type="dfn|abstract-op" data-type="dfn" href="https://infra.spec.whatwg.org/#struct-item">items</a> are:
          </p>

          <dl>
            <dt><dfn data-dfn-for="verification result" id="dfn-verified" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">verified</dfn></dt>
            <dd><code>true</code> or <code>false</code></dd>
            <dt><dfn data-dfn-for="verification result" id="dfn-verifieddocument" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">verifiedDocument</dfn></dt>
            <dd>
<a href="https://infra.spec.whatwg.org/#nulls">Null</a>, if <a data-link-type="dfn|abstract-op" href="#dfn-verified" class="internalDFN" id="ref-for-dfn-verified-1">verified</a> is
<code>false</code>; otherwise, an <a data-link-type="dfn|abstract-op" data-type="dfn" href="https://www.w3.org/TR/vc-data-integrity/#dfn-unsecured-data-document">unsecured data document</a>
            </dd>
          </dl>

          <p>
To verify a derived proof, perform the following steps:
          </p>

          <ol class="algorithm">
            <li>
Let <var>unsecuredDocument</var> be a copy of <var>securedDocument</var> with
the <code>proof</code> value removed.
            </li>
            <li>
Let <var>proofConfig</var> be a copy of <var>securedDocument</var>.<var>proof</var> with <code>proofValue</code>
removed.
            </li>
            <li>
Let <var>proof</var> be the value of <var>securedDocument</var>.<var>proof</var>.
            </li>
            <li>
Initialize <code>bbsProof</code>, <code>proofHash</code>, <code>mandatoryHash</code>, <code>selectedIndexes</code>,
<code>presentationHeader</code>, <code>pseudonym</code>, and <code>nonMandatory</code> to the values associated
with their property names in the object returned when calling the algorithm in
Section <a href="#createverifydata" class="sec-ref"><bdi class="secno">3.3.8 </bdi>createVerifyData</a>, passing the <var>unsecuredDocument</var>,
<var>proof</var>, and any custom JSON-LD API options (such as a document loader).
            </li>
            <li>
Initialize <code>bbsHeader</code> to the concatenation of <code>proofHash</code> and <code>mandatoryHash</code>
in that order. Initialize <code>disclosedMessages</code> to an array of byte arrays
obtained from the UTF-8 encoding of the elements of the <code>nonMandatory</code> array.
            </li>
            <li>
Initialize <var>verified</var> to the result of applying the verification
algorithm below, depending on whether the <var>pseudonym</var> value is empty.
            <ol class="algorithm">
              <li>
If the <var>pseudonym</var> value is empty, initialize <var>verified</var> to the result of
applying the verification algorithm <code>ProofVerify(PK, proof, header, ph,
disclosed_messages, disclosed_indexes)</code> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-SIGNATURE</a></cite>] with <code>PK</code> set
as the public key of the original issuer, <code>proof</code> set as <code>bbsProof</code>, <code>header</code>
set as <code>bbsHeader</code>, <code>disclosed_messages</code> set as <code>disclosedMessages</code>, <code>ph</code> set as
<code>presentationHeader</code>, and <code>disclosed_indexes</code> set as <code>selectiveIndexes</code>. This
applies to the regular BBS proof case as well as "anonymous holder binding"
case.
              </li>
              <li>
If the <var>pseudonym</var> value is not empty, initialize <var>verified</var> to the result of
applying the verification algorithm <code>PseudonymProofVerify(PK, proof, header, ph,
disclosed_messages, disclosed_indexes, pseudonym)</code> of
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pseudonym-bbs-signature" title="BBS per Verifier Linkability">CFRG-Pseudonym-BBS-Signature</a></cite>], with <code>PK</code> set as the public key of the
original issuer, <code>proof</code> set as <code>bbsProof</code>, <code>header</code> set as <code>bbsHeader</code>,
<code>disclosed_messages</code> set as <code>disclosedMessages</code>, <code>ph</code> set as
<code>presentationHeader</code>, <code>disclosed_indexes</code> set as <code>selectiveIndexes</code>, and
<code>pseudonym</code>. This applies to the "pseudonym with issuer known pid" and
"pseudonym with hidden pid" cases.
              </li>
            </ol>
          </li>
          <li>
Return a <a data-link-type="dfn|abstract-op" href="#dfn-verification-result" class="internalDFN" id="ref-for-dfn-verification-result-1">verification result</a> with <a data-link-type="dfn|abstract-op" data-type="dfn" href="https://infra.spec.whatwg.org/#struct-item">items</a>:
              <dl data-link-for="verification result">
                <dt><a data-link-type="dfn|abstract-op" href="#dfn-verified" class="internalDFN" id="ref-for-dfn-verified-2">verified</a></dt>
                <dd><var>verified</var></dd>
                <dt><a data-link-type="dfn|abstract-op" href="#dfn-verifieddocument" class="internalDFN" id="ref-for-dfn-verifieddocument-1">verifiedDocument</a></dt>
                <dd>
<var>unsecuredDocument</var> if <var>verified</var> is <code>true</code>, otherwise
<a href="https://infra.spec.whatwg.org/#nulls">Null</a>
                </dd>
              </dl>
            </li>
          </ol>

        </section>
      </section>
    </section>
    <section class="informative" id="optional-features"><div class="header-wrapper"><h2 id="x4-optional-features"><bdi class="secno">4. </bdi>Optional Features</h2><a class="self-link" href="#optional-features" aria-label="Permalink for Section 4."></a></div><p><em>This section is non-normative.</em></p>
      
      <p>
The cryptographic properties of BBS signatures permit variants that
can support advanced functionalities. This specification is limited to
supporting only the most relevant of these enhancements, which we explain in the
following sections. The variables <var>commitment_with_proof</var>, <var>use_pseudonyms</var>,
<var>pid</var>, and <var>pseudonym</var> are associated with these features and are not otherwise
needed for BBS signatures and proofs.
      </p>
      <div class="issue" id="issue-container-number-1"><div role="heading" class="issue-title marker" id="h-issue" aria-level="3"><span>Issue 1</span><span class="issue-label">: Optional BBS features are at risk</span></div><p class="at-risk">
The optional BBS features described in this section, and included in the
algorithms in this specification, are at risk and will be removed before
the finalization of this specification if their respective specifications
at the IETF do not reach RFC status on the same timeline or if there
are not at least two independent implementations for each optional
feature.
      </p></div>
      <section id="anonymous-holder-binding"><div class="header-wrapper"><h3 id="x4-1-anonymous-holder-binding"><bdi class="secno">4.1 </bdi>Anonymous Holder Binding</h3><a class="self-link" href="#anonymous-holder-binding" aria-label="Permalink for Section 4.1"></a></div>
        
        <p>
This feature binds, at the time of issuance, a document with base proof, to a
secret, known only to a holder, in such a way, that only that holder can generate
a revealed document with derived proof that will verify. For example, if an
adversary obtained the document with base proof, they could not create a revealed
document with derived proof that can verify.
        </p>
        <p>
To provide for this functionality, a holder generates a <var>holder_secret</var> value
which should generally be at least 32 bytes long and cryptographically randomly
generated. This value is never shared by the holder. Instead, the holder
generates a commitment along with a zero knowledge proof of knowledge of this
value, using the "Commitment Generation" procedure of [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-blind-bbs-signature" title="Blind BBS Signatures">CFRG-Blind-BBS-Signature</a></cite>].
This computation involves cryptographically random values and computes
the <var>commitment_with_proof</var> and <var>secret_prover_blind</var> values. The
<var>commitment_with_proof</var> is conveyed to the issuer while the
<var>secret_prover_blind</var> is kept secret and is retained by the holder for use
in generation of derived proofs.
Note that a holder can run the "Commitment Generation" procedure multiple times
to produce unlinkable <var>commitment_with_proof</var> values for use with different issuers.
        </p>
        <p>
The issuer, on receipt of the <var>commitment_with_proof</var>, follows the procedures of
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-blind-bbs-signature" title="Blind BBS Signatures">CFRG-Blind-BBS-Signature</a></cite>] to produce a base proof (signature) over the document
with the commitment furnished by the holder. If the issuer chooses to use the
<var>signer_blind</var> parameter when creating the signature in
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-blind-bbs-signature" title="Blind BBS Signatures">CFRG-Blind-BBS-Signature</a></cite>], this value needs to be conveyed to the holder as
part of the base proof value.
        </p>
        <p>
When the holder wants to create a selectively disclosed document with derived
proof, they use their <var>holder_secret</var> (as a "commited message"), the
<var>secret_prover_blind</var>, and, if supplied in the base proof, the <var>signer_blind</var>
in the proof generation procedure of
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-blind-bbs-signature" title="Blind BBS Signatures">CFRG-Blind-BBS-Signature</a></cite>].
        </p>
        <p>
Verification of the revealed document with derived proof uses the "regular" BBS
proof verification procedures of [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-SIGNATURE</a></cite>].
        </p>

      </section>
      <section id="pseudonyms-with-issuer-known-pid"><div class="header-wrapper"><h3 id="x4-2-pseudonyms-with-issuer-known-pid"><bdi class="secno">4.2 </bdi>Pseudonyms with Issuer-known PID</h3><a class="self-link" href="#pseudonyms-with-issuer-known-pid" aria-label="Permalink for Section 4.2"></a></div>
        
        <p>
This feature is a privacy preserving enhancement that allows a verifier that has
seen a selectively revealed document with derived proof from a holder to
recognize that the same holder is presenting a new selectively revealed document
with derived proof. Note that this may just be a new unlinkable proof (derived
proof) on the same selectively revealed information. By "privacy preserving," we
mean that no uniquely identifiable information is added that would allow tracking
between different verifiers that may share information amongst themselves. This
variant does allow for the issuer to monitor usage if verifiers share
information with the issuer.
        </p>
        <p>
To furnish this capability, before creating the base proof for a document, an
issuer generates a value known as a <var>pid</var> (prover id) which should be
cryptographically random and at least 32 bytes long. This value is shared with
the holder but otherwise kept secret. This value is then used in creating the
base proof via the signing procedure in [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pseudonym-bbs-signature" title="BBS per Verifier Linkability">CFRG-Pseudonym-BBS-Signature</a></cite>].
        </p>
        <p>
The holder receives the document with base proof which includes the <var>pid</var> value
from the issuer. The holder obtains a <var>verifier_id</var> associated with the verifier
for which they intend to create a revealed document with derived proof. Using the
procedures of [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pseudonym-bbs-signature" title="BBS per Verifier Linkability">CFRG-Pseudonym-BBS-Signature</a></cite>], a cryptographic <var>pseudonym</var> value
is generated. The derived proof value is generated via the proof generation
procedure of [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pseudonym-bbs-signature" title="BBS per Verifier Linkability">CFRG-Pseudonym-BBS-Signature</a></cite>], and this value along with the
<var>pseudonym</var> are given to the verifier. Note that the <var>pid</var> value cannot be
recovered from the <var>pseudonym</var>.
        </p>
        <p>
When the verifier receives the revealed document with derived proof and
<var>pseudonym</var>, they use the proof verification procedures of
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pseudonym-bbs-signature" title="BBS per Verifier Linkability">CFRG-Pseudonym-BBS-Signature</a></cite>].
        </p>
      </section>
      <section id="pseudonyms-with-hidden-pid"><div class="header-wrapper"><h3 id="x4-3-pseudonyms-with-hidden-pid"><bdi class="secno">4.3 </bdi>Pseudonyms with Hidden PID</h3><a class="self-link" href="#pseudonyms-with-hidden-pid" aria-label="Permalink for Section 4.3"></a></div>
      <p>
This feature is a privacy preserving enhancement that allows a verifier that has
seen a selectively revealed document with derived proof from a holder to
recognize that the same holder is presenting a new selectively revealed document
with derived proof. Note that this may just be a new unlinkable proof (derived
proof) on the same selectively revealed information. By "privacy preserving," we
mean that no uniquely identifiable information is added that would allow tracking
between different verifiers that may share information amongst themselves and/or
with the issuer.
        </p>
        <p>
To provide for this capability, a holder needs to generate a secret <var>pid</var> value
that should be at least 32 bytes long and generated in cryptographically random
manner. The holder then uses the "Commitment Generation" procedure of
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-blind-bbs-signature" title="Blind BBS Signatures">CFRG-Blind-BBS-Signature</a></cite>] to generate a <var>commitment_with_proof</var> value and
a private <var>secret_prover_blind</var> value.
This value needs to be conveyed to the issuer who will use it in the issuance
of a document with base proof, in accordance with
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pseudonym-bbs-signature" title="BBS per Verifier Linkability">CFRG-Pseudonym-BBS-Signature</a></cite>], which is sent to the holder. The <var>pid</var>
value is never shared by the holder. If the issuer chooses to use the optional
<var>signer_blind</var> parameter when creating the signature in this value needs to be
conveyed to the holder as part of the base proof value.
        </p>
        <p>
The holder obtains a <var>verifier_id</var> associated with the verifier for which
they intend to create a revealed document with derived proof. Using the
procedures of [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pseudonym-bbs-signature" title="BBS per Verifier Linkability">CFRG-Pseudonym-BBS-Signature</a></cite>], a cryptographic <var>pseudonym</var>
value is generated from their <var>pid</var> value and the <var>verifier_id</var>. The derived
proof value is generated via the proof generation using the <var>pid</var>,
<var>secret_prover_blind</var>, <var>verifier_id</var>, and <var>signer_blind</var> using the
procedures of [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pseudonym-bbs-signature" title="BBS per Verifier Linkability">CFRG-Pseudonym-BBS-Signature</a></cite>],
and this value is given to the
verifier along with the <var>pseudonym</var>. Note that the <var>pid</var> value cannot be
recovered from the <var>pseudonym</var>.
        </p>
        <p>
When the verifier receives the revealed document with derived proof and
<var>pseudonym</var>, they use the proof verification procedures of
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pseudonym-bbs-signature" title="BBS per Verifier Linkability">CFRG-Pseudonym-BBS-Signature</a></cite>].
        </p>
    </section></section>
    
    <section id="security-considerations"><div class="header-wrapper"><h2 id="x5-security-considerations"><bdi class="secno">5. </bdi>Security Considerations</h2><a class="self-link" href="#security-considerations" aria-label="Permalink for Section 5."></a></div>
      

      <p class="advisement">
        Before reading this section, readers are urged to familiarize themselves
        with general security advice provided in the
        <a href="https://www.w3.org/TR/vc-data-integrity/#security-considerations">
        Security Considerations section of the Data Integrity specification</a>.
      </p>

      <section class="informative" id="base-proof-security-properties"><div class="header-wrapper"><h3 id="x5-1-base-proof-security-properties"><bdi class="secno">5.1 </bdi>Base Proof Security Properties</h3><a class="self-link" href="#base-proof-security-properties" aria-label="Permalink for Section 5.1"></a></div><p><em>This section is non-normative.</em></p>
        

        <p>
The security of the base proof is dependent on the security properties of the
associated <em>BBS signature</em>. Digital signatures might exhibit a number of
desirable cryptographic properties [<cite><a class="bibref" data-link-type="biblio" href="#bib-taming_eddsas" title="Taming the many EdDSAs">Taming_EdDSAs</a></cite>] among these are:
        </p>
        <p><strong>EUF-CMA</strong> (<em>existential unforgeability under
chosen message attacks</em>) is usually the minimal security property required
of a signature scheme. It guarantees that any efficient adversary who has the
public key
          <math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
            <mstyle displaystyle="true" scriptlevel="0">
              <mrow data-mjx-texclass="ORD">
                <mtable rowspacing=".5em" columnspacing="1em" displaystyle="true">
                  <mtr>
                    <mtd>
                      <mi>p</mi>
                      <mi>k</mi>
                    </mtd>
                  </mtr>
                </mtable>
              </mrow>
            </mstyle>
          </math>
of the signer and received an arbitrary number of signatures on
messages of its choice (in an adaptive manner):
          <math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
            <mstyle displaystyle="true" scriptlevel="0">
              <mrow data-mjx-texclass="ORD">
                <mtable rowspacing=".5em" columnspacing="1em" displaystyle="true">
                  <mtr>
                    <mtd>
                      <mo fence="false" stretchy="false">{</mo>
                      <msub>
                        <mi>m</mi>
                        <mi>i</mi>
                      </msub>
                      <mo>,</mo>
                      <msub>
                        <mi>σ</mi>
                        <mi>i</mi>
                      </msub>
                      <msubsup>
                        <mo fence="false" stretchy="false">}</mo>
                        <mrow data-mjx-texclass="ORD">
                          <mi>i</mi>
                          <mo>=</mo>
                          <mn>1</mn>
                        </mrow>
                        <mi>N</mi>
                      </msubsup>
                    </mtd>
                  </mtr>
                </mtable>
              </mrow>
            </mstyle>
          </math>,
cannot output a valid signature
          <math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
            <mstyle displaystyle="true" scriptlevel="0">
              <mrow data-mjx-texclass="ORD">
                <mtable rowspacing=".5em" columnspacing="1em" displaystyle="true">
                  <mtr>
                    <mtd>
                      <msup>
                        <mi>σ</mi>
                        <mo>∗</mo>
                      </msup>
                    </mtd>
                  </mtr>
                </mtable>
              </mrow>
            </mstyle>
          </math>
for a new message
          <math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
            <mstyle displaystyle="true" scriptlevel="0">
              <mrow data-mjx-texclass="ORD">
                <mtable rowspacing=".5em" columnspacing="1em" displaystyle="true">
                  <mtr>
                    <mtd>
                      <msup>
                        <mi>m</mi>
                        <mo>∗</mo>
                      </msup>
                      <mo>∉</mo>
                      <mo fence="false" stretchy="false">{</mo>
                      <msub>
                        <mi>m</mi>
                        <mi>i</mi>
                      </msub>
                      <msubsup>
                        <mo fence="false" stretchy="false">}</mo>
                        <mrow data-mjx-texclass="ORD">
                          <mi>i</mi>
                          <mo>=</mo>
                          <mn>1</mn>
                        </mrow>
                        <mi>N</mi>
                      </msubsup>
                    </mtd>
                  </mtr>
                </mtable>
              </mrow>
            </mstyle>
          </math>
(except with negligible probability). In case the attacker outputs a valid
signature on a new message:
          <math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
            <mstyle displaystyle="true" scriptlevel="0">
              <mrow data-mjx-texclass="ORD">
                <mtable rowspacing=".5em" columnspacing="1em" displaystyle="true">
                  <mtr>
                    <mtd>
                      <mo stretchy="false">(</mo>
                      <msup>
                        <mi>m</mi>
                        <mo>∗</mo>
                      </msup>
                      <mo>,</mo>
                      <msup>
                        <mi>σ</mi>
                        <mo>∗</mo>
                      </msup>
                      <mo stretchy="false">)</mo>
                    </mtd>
                  </mtr>
                </mtable>
              </mrow>
            </mstyle>
          </math>,
it is called an <em>existential forgery</em>.
        </p>
        <p><strong>SUF-CMA</strong> (<em>strong unforgeability under chosen
message attacks</em>) is a stronger notion than <em>EUF-CMA</em>. It guarantees
that for any efficient adversary who has the public key
          <math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
            <mstyle displaystyle="true" scriptlevel="0">
              <mrow data-mjx-texclass="ORD">
                <mtable rowspacing=".5em" columnspacing="1em" displaystyle="true">
                  <mtr>
                    <mtd>
                      <mi>p</mi>
                      <mi>k</mi>
                    </mtd>
                  </mtr>
                </mtable>
              </mrow>
            </mstyle>
          </math>
of the signer and received an arbitrary number of signatures on messages of its
choice:
          <math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
            <mstyle displaystyle="true" scriptlevel="0">
              <mrow data-mjx-texclass="ORD">
                <mtable rowspacing=".5em" columnspacing="1em" displaystyle="true">
                  <mtr>
                    <mtd>
                      <mo fence="false" stretchy="false">{</mo>
                      <msub>
                        <mi>m</mi>
                        <mi>i</mi>
                      </msub>
                      <mo>,</mo>
                      <msub>
                        <mi>σ</mi>
                        <mi>i</mi>
                      </msub>
                      <msubsup>
                        <mo fence="false" stretchy="false">}</mo>
                        <mrow data-mjx-texclass="ORD">
                          <mi>i</mi>
                          <mo>=</mo>
                          <mn>1</mn>
                        </mrow>
                        <mi>N</mi>
                      </msubsup>
                    </mtd>
                  </mtr>
                </mtable>
              </mrow>
            </mstyle>
          </math>,
it cannot output a new valid signature pair
          <math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
            <mstyle displaystyle="true" scriptlevel="0">
              <mrow data-mjx-texclass="ORD">
                <mtable rowspacing=".5em" columnspacing="1em" displaystyle="true">
                  <mtr>
                    <mtd>
                      <mo stretchy="false">(</mo>
                      <msup>
                        <mi>m</mi>
                        <mo>∗</mo>
                      </msup>
                      <mo>,</mo>
                      <msup>
                        <mi>σ</mi>
                        <mo>∗</mo>
                      </msup>
                      <mo stretchy="false">)</mo>
                    </mtd>
                  </mtr>
                </mtable>
              </mrow>
            </mstyle>
          </math>,
such that
          <math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
            <mstyle displaystyle="true" scriptlevel="0">
              <mrow data-mjx-texclass="ORD">
                <mtable rowspacing=".5em" columnspacing="1em" displaystyle="true">
                  <mtr>
                    <mtd>
                      <mo stretchy="false">(</mo>
                      <msup>
                        <mi>m</mi>
                        <mo>∗</mo>
                      </msup>
                      <mo>,</mo>
                      <msup>
                        <mi>σ</mi>
                        <mo>∗</mo>
                      </msup>
                      <mo stretchy="false">)</mo>
                      <mo>∉</mo>
                      <mo fence="false" stretchy="false">{</mo>
                      <msup>
                        <mi>m</mi>
                        <mi>i</mi>
                      </msup>
                      <mo>,</mo>
                      <msup>
                        <mi>σ</mi>
                        <mi>i</mi>
                      </msup>
                      <msubsup>
                        <mo fence="false" stretchy="false">}</mo>
                        <mrow data-mjx-texclass="ORD">
                          <mi>i</mi>
                          <mo>=</mo>
                          <mn>1</mn>
                        </mrow>
                        <mi>N</mi>
                      </msubsup>
                    </mtd>
                  </mtr>
                </mtable>
              </mrow>
            </mstyle>
          </math>
(except with negligible probability). Strong unforgeability implies that an
adversary cannot only sign new messages, but also cannot find a new signature
on an old message.
        </p>

        <p>
In [<cite><a class="bibref" data-link-type="biblio" href="#bib-cdl2016" title="Anonymous Attestation Using the Strong Diffie Hellman Assumption Revisited">CDL2016</a></cite>] under some reasonable assumptions BBS signatures were proven to
be EUF-CMA. Furthermore, in [<cite><a class="bibref" data-link-type="biblio" href="#bib-tz2023" title="Revisiting BBS Signatures">TZ2023</a></cite>], under similar assumptions BBS signatures
were proven to be SUF-CMA. In both cases the assumptions are related to the
hardness of the discrete logarithm problem which is not considered post large
scale quantum computing secure.
        </p>
        <p>
Under non-quantum computing conditions [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-SIGNATURE</a></cite>] provides
additional security guidelines to BBS signature suite implementors. Further
security considerations related to pairing friendly curves are discussed in
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-pairing-friendly" title="Pairing-Friendly Curves">CFRG-PAIRING-FRIENDLY</a></cite>].
        </p>
      </section>

      <section class="informative" id="derived-proof-security-properties"><div class="header-wrapper"><h3 id="x5-2-derived-proof-security-properties"><bdi class="secno">5.2 </bdi>Derived Proof Security Properties</h3><a class="self-link" href="#derived-proof-security-properties" aria-label="Permalink for Section 5.2"></a></div><p><em>This section is non-normative.</em></p>
        
        <p>
The security of the derived proof is dependent on the security properties of
the associated <em>BBS proof</em>. Both [<cite><a class="bibref" data-link-type="biblio" href="#bib-cdl2016" title="Anonymous Attestation Using the Strong Diffie Hellman Assumption Revisited">CDL2016</a></cite>] and [<cite><a class="bibref" data-link-type="biblio" href="#bib-tz2023" title="Revisiting BBS Signatures">TZ2023</a></cite>] prove that a
<em>BBS proof</em> is <q>a zero knowledge proof of knowledge of a BBS
  signature</q>.
        </p>
        <p>
As explained in [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-SIGNATURE</a></cite>] this means:
        </p>
        <blockquote>
a verifying party in receipt of a proof is unable to determine which signature
was used to generate the proof, removing a common source of correlation. In
general, each proof generated is indistinguishable from random even for two
proofs generated from the same signature.
        </blockquote>
        <p>
and
        </p>
        <blockquote>
The proofs generated by the scheme prove to a verifier that the party who
generated the proof (holder/prover or an agent of theirs) was in possession of a
signature without revealing it.
        </blockquote>
        <p>
More precisely, verification of a <em>BBS proof</em> requires the original
issuers public key as well as the unaltered, revealed <em>BBS message</em> in
the proper order.
        </p>
      </section>

    </section>

    <section class="informative" id="privacy-considerations"><div class="header-wrapper"><h2 id="x6-privacy-considerations"><bdi class="secno">6. </bdi>Privacy Considerations</h2><a class="self-link" href="#privacy-considerations" aria-label="Permalink for Section 6."></a></div><p><em>This section is non-normative.</em></p>
      
      <section id="selective-disclosure-and-data-leakage"><div class="header-wrapper"><h3 id="x6-1-selective-disclosure-and-data-leakage"><bdi class="secno">6.1 </bdi>Selective Disclosure and Data Leakage</h3><a class="self-link" href="#selective-disclosure-and-data-leakage" aria-label="Permalink for Section 6.1"></a></div>
        
        <p>
Selective disclosure permits a <em>holder</em> to <em>minimize</em> the information
revealed to a <em>verifier</em> to achieve a particular purpose. In prescribing
an overall system that enables selective disclosure, care has to be taken that
additional information that was not meant to be disclosed to the
<em>verifier</em> is minimized. Such leakage can occur through artifacts of the
system. Such artifacts can come from higher layers of the system, such as in
the structure of data or from the lower level cryptographic primitives.
        </p>
        <p>
For example the BBS signature scheme is an extremely space efficient scheme for
producing a signature on multiple <em>messages</em>, i.e.,  the cryptographic
signature sent to the <em>holder</em> is a constant size regardless of the
number of <em>messages</em>. The <em>holder</em> then can selectively disclose
any of these <em>messages</em> to a <em>verifier</em>, however as part of the
encryption scheme, the total number of messages signed by the <em>issuer</em>
has to be revealed to the <em>verifier</em>. If such information leakage needs to
be avoided then it is recommended to pad the number of messages out to a common
length as suggested in the privacy considerations section of
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-SIGNATURE</a></cite>].
        </p>
        <p>
At the higher levels, how data gets mapped into individual <em>statements</em>
suitable for selective disclosure, i.e., BBS <em>messages</em>, is a potential
source of data leakage. This cryptographic suite is able to eliminate many
structural artifacts used to express JSON data that might leak information
(nesting, map, or array position, etc.) by using JSON-LD processing to transform
inputs into RDF. RDF can then be expressed as a canonical, flat format of simple
subject, property, value statements (referred to as claims in the Verifiable
Credentials Data Model [<cite><a class="bibref" data-link-type="biblio" href="#bib-vc-data-model-2.0" title="Verifiable Credentials Data Model v2.0">VC-DATA-MODEL-2.0</a></cite>]). In the following, we examine RDF
canonicalization, a general scheme for mapping a verifiable credential in
JSON-LD format into a set of <em>statements</em> (BBS <em>messages</em>), for
selective disclosure. We show that after this process is performed, there
remains a possible source of information leakage, and we show how this leakage
is mitigated via the use of a keyed pseudo random function (PRF).
        </p>
        <p>
RDF canonicalization can be used to <q>flatten</q> a JSON-LD VC into a set of
<em>statements</em>. The algorithm is dependent on the content of the VC and
also employs a cryptographic hash function to help in ordering the
<em>statements</em>. In essence, how this happens is that each JSON object that
represents the subject of claims within a JSON-LD document will be assigned an
id, if it doesn't have an <code>@id</code> field defined. Such <em>ids</em> are known as
<em>blank node ids</em>. These ids are needed to express claims as simple
subject, property, value statements such that the subject in each claim can be
differentiated. The id values are deterministically set per
[<cite><a class="bibref" data-link-type="biblio" href="#bib-rdf-canon" title="RDF Dataset Canonicalization">RDF-CANON</a></cite>] and are based on the data in the document and the
output of a cryptographic hash function such as SHA-256.
        </p>
        <p>
Below we show two slightly different VCs for a set of windsurf sails and their
canonicalization into a set of <em>statements</em> that can be used for
selective disclosure. By changing the year of the 6.1 size sail we see a major
change in statement ordering between these two VCs. If the <em>holder</em>
discloses information about just his larger sails (the 7.0 and 7.8) the
<em>verifier</em> could tell something changed about the set of sails, i.e.,
information leakage.
        </p>
        <div class="example" id="example-a-vc-for-a-set-of-windsurfing-sails">
        <div class="marker">
    <a class="self-link" href="#example-a-vc-for-a-set-of-windsurfing-sails">Example<bdi> 3</bdi></a><span class="example-title">: A VC for a set of windsurfing sails</span>
  </div> <pre class="nohighlight">{
  "@context": [
    "https://www.w3.org/ns/credentials/v2",
    {
      "@vocab": "https://windsurf.grotto-networking.com/selective#"
    }
  ],
  "type": [
    "VerifiableCredential"
  ],
  "credentialSubject": {
    "sails": [
      {
        "size": 5.5,
        "sailName": "Kihei",
        "year": 2023
      },
      {
        "size": 6.1,
        "sailName": "Lahaina",
        "year": 2023 // Will change this to see the effect on canonicalization
      },
      {
        "size": 7.0,
        "sailName": "Lahaina",
        "year": 2020
      },
      {
        "size": 7.8,
        "sailName": "Lahaina",
        "year": 2023
      }
    ]
  }
}</pre>
      </div>
        <p>
Canonical form of the above VC. Assignment of blank node ids, i.e., the
<q>_:c14nX</q> labels are dependent upon the content of the VC and this also
affects the ordering of the statements.
        </p>
        <div class="example" id="example-canonical-form-of-the-vc-for-a-set-of-windsurfing-sails">
        <div class="marker">
    <a class="self-link" href="#example-canonical-form-of-the-vc-for-a-set-of-windsurfing-sails">Example<bdi> 4</bdi></a><span class="example-title">: Canonical form of the VC for a set of windsurfing sails</span>
  </div> <pre class="nohighlight">_:c14n0 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; "Lahaina" .
_:c14n0 &lt;https://windsurf.grotto-networking.com/selective#size&gt; "7.8E0"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .
_:c14n0 &lt;https://windsurf.grotto-networking.com/selective#year&gt; "2023"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .
_:c14n1 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; &lt;https://www.w3.org/2018/credentials#VerifiableCredential&gt; .
_:c14n1 &lt;https://www.w3.org/2018/credentials#credentialSubject&gt; _:c14n4 .
_:c14n2 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; "Lahaina" .
_:c14n2 &lt;https://windsurf.grotto-networking.com/selective#size&gt; "7"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .
_:c14n2 &lt;https://windsurf.grotto-networking.com/selective#year&gt; "2020"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .
_:c14n3 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; "Kihei" .
_:c14n3 &lt;https://windsurf.grotto-networking.com/selective#size&gt; "5.5E0"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .
_:c14n3 &lt;https://windsurf.grotto-networking.com/selective#year&gt; "2023"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .
_:c14n4 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:c14n0 .
_:c14n4 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:c14n2 .
_:c14n4 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:c14n3 .
_:c14n4 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:c14n5 .
_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; "Lahaina" .
_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#size&gt; "6.1E0"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .
_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#year&gt; "2023"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .</pre>
      </div>
        <p>
Updated windsurf sail collection, i.e., the 6.1 size sail has been updated to
the 2024 model. This changes the ordering of statements via the assignment of
<em>blank node ids</em>.
        </p>
        <div class="example" id="example-a-vc-for-a-slightly-updated-set-of-windsurfing-sails">
        <div class="marker">
    <a class="self-link" href="#example-a-vc-for-a-slightly-updated-set-of-windsurfing-sails">Example<bdi> 5</bdi></a><span class="example-title">: A VC for a slightly updated set of windsurfing sails</span>
  </div> <pre class="nohighlight">{
  "@context": [
    "https://www.w3.org/ns/credentials/v2",
    {
      "@vocab": "https://windsurf.grotto-networking.com/selective#"
    }
  ],
  "type": [
    "VerifiableCredential"
  ],
  "credentialSubject": {
    "sails": [
      {
        "size": 5.5,
        "sailName": "Kihei",
        "year": 2023
      },
      {
        "size": 6.1,
        "sailName": "Lahaina",
        "year": 2024 // New sail to update older model, changes canonicalization
      },
      {
        "size": 7.0,
        "sailName": "Lahaina",
        "year": 2020
      },
      {
        "size": 7.8,
        "sailName": "Lahaina",
        "year": 2023
      }
    ]
  }
}</pre>
      </div>
        <p>
Canonical form of the previous VC. Note the difference in <em>blank node id</em>
assignment and ordering of statements.
        </p>
        <div class="example" id="example-canonical-form-of-the-updated-vc-for-a-set-of-windsurfing-sails">
        <div class="marker">
    <a class="self-link" href="#example-canonical-form-of-the-updated-vc-for-a-set-of-windsurfing-sails">Example<bdi> 6</bdi></a><span class="example-title">: Canonical form of the updated VC for a set of windsurfing sails</span>
  </div> <pre class="nohighlight">_:c14n0 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; "Lahaina" .
_:c14n0 &lt;https://windsurf.grotto-networking.com/selective#size&gt; "6.1E0"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .
_:c14n0 &lt;https://windsurf.grotto-networking.com/selective#year&gt; "2024"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .
_:c14n1 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; "Lahaina" .
_:c14n1 &lt;https://windsurf.grotto-networking.com/selective#size&gt; "7.8E0"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .
_:c14n1 &lt;https://windsurf.grotto-networking.com/selective#year&gt; "2023"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .
_:c14n2 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; &lt;https://www.w3.org/2018/credentials#VerifiableCredential&gt; .
_:c14n2 &lt;https://www.w3.org/2018/credentials#credentialSubject&gt; _:c14n5 .
_:c14n3 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; "Lahaina" .
_:c14n3 &lt;https://windsurf.grotto-networking.com/selective#size&gt; "7"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .
_:c14n3 &lt;https://windsurf.grotto-networking.com/selective#year&gt; "2020"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .
_:c14n4 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; "Kihei" .
_:c14n4 &lt;https://windsurf.grotto-networking.com/selective#size&gt; "5.5E0"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .
_:c14n4 &lt;https://windsurf.grotto-networking.com/selective#year&gt; "2023"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .
_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:c14n0 .
_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:c14n1 .
_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:c14n3 .
_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:c14n4 .</pre>
      </div>
        <p>
To prevent such information leakage from the assignment of these blank node ids
and the ordering they impose on the <em>statements</em>, an HMAC based PRF is
run on the <em>blank node ids</em>. The HMAC secret key is only shared between
the <em>issuer</em> and <em>holder</em> and each <em>Base Proof</em> generated
by the issuer uses a new HMAC key. An example of this can be seen in the
<a href="https://www.w3.org/TR/vc-di-ecdsa/#example-canonical-hmac-document">
canonical HMAC test vector</a> of [<cite><a class="bibref" data-link-type="biblio" href="#bib-di-ecdsa" title="The Elliptic Curve Digital Signature Algorithm Cryptosuites v1.0">DI-ECDSA</a></cite>].


As discussed in the next section, for BBS to preserve unlinkability we do not
use HMAC based <em>blank node ids</em> but produce a <q>shuffled</q> version of
the ordering based on the HMAC as shown in test vector <a href="#example-canonical-hmac-document" class="box-ref">Example<bdi> 12</bdi></a>.
Note that this furnishes less information hiding concerning <em>blank node
ids</em> than in the ECDSA-SD approach, since information the number of
<em>blank node ids</em> can leak, but prevents linkage attacks via the
essentially unique identifiers produced by applying an HMAC to blank node ids.
        </p>
      </section>
      <section id="selective-disclosure-and-unlinkability"><div class="header-wrapper"><h3 id="x6-2-selective-disclosure-and-unlinkability"><bdi class="secno">6.2 </bdi>Selective Disclosure and Unlinkability</h3><a class="self-link" href="#selective-disclosure-and-unlinkability" aria-label="Permalink for Section 6.2"></a></div>
        
        <p>
In some uses of VCs it can be important to the privacy of a <em>holder</em> to
prevent the tracking or linking of multiple different <em>verifier</em>
interactions. In particular we consider two important cases (i) <em>verifier to
issuer collusion</em>, and (ii) <em>verifier to verifier collusion</em>. In the
first case, shown in <a href="#verifier-issuer" class="fig-ref" title="Verifier to verifier collusion.">Figure <bdi class="">1</bdi></a>, a <em>verifier</em>
reports back to the original
<em>issuer</em> of the credential on an interaction with a <em>holder</em>. In
this situation, the <em>issuer</em> could track all the <em>holder</em>
interactions with various <em>verifiers</em> using the issued VC. In the second
situation, shown in <a href="#verifier-verifier" class="fig-ref" title="Verifier to issuer collusion.">Figure <bdi class="">2</bdi></a>, multiple
<em>verifiers</em> collude to share
information about <em>holders</em> with whom they have interacted.
        </p>
        <figure id="verifier-issuer">
          <img style="margin: auto; display: block; width: 100%;" src="diagrams/VerifierIssuerCollusion.svg" alt="
Diagram showing multiple verifiers sending data back to the issuer.
The diagram is laid out top to bottom with a circle labeled issuer at the top,
connected to a circle label holder below. From the circle labeled holder there
are multple arrows to additional circles labeled verifiers. From the circles
labeled verifiers there are dashed arrows back to the circle labeled issuer
showing collusion data flow.">
          <figcaption style="text-align: center;"><a class="self-link" href="#verifier-issuer">Figure <bdi class="figno">1</bdi></a> <span class="fig-title">
Verifier to verifier collusion.
          </span></figcaption>
        </figure>
        <figure id="verifier-verifier">
          <img style="margin: auto; display: block; width: 100%;" src="diagrams/VerifiersCollusion.svg" alt="
Diagram showing multiple verifiers sharing with each other.
The diagram is laid out top to bottom with a circle labeled issuer at the top,
connected to a circle label holder below. From the circle labeled holder there
are multple arrows to additional circles labeled verifiers. From the circles
labeled verifiers there are dashed arrows back to other circles labeled issuer
to show verifier to verifier collusion data flows.">
          <figcaption style="text-align: center;"><a class="self-link" href="#verifier-verifier">Figure <bdi class="figno">2</bdi></a> <span class="fig-title">
Verifier to issuer collusion.
          </span></figcaption>
        </figure>
        <p>
We use the term <em>unlinkability</em> to describe the property of a VC system
to prevent such "linkage attacks"  on holder privacy. Although the term
unlinkability is relatively new section 3.3 of [<cite><a class="bibref" data-link-type="biblio" href="#bib-nistir8053" title="NISTIR 8053: De-Identification of Personal Information">NISTIR8053</a></cite>] discusses and
gives a case study of <q>Re-identification through Linkage Attacks</q>. A
systemization of knowledge on <q>linkage attack on data privacy</q> can be found
in [<cite><a class="bibref" data-link-type="biblio" href="#bib-powar2023" title="SoK: Managing risks of linkage attacks on data privacy">Powar2023</a></cite>]. The most widespread use of linkage attack on user privacy
occurs via the practice of web browser fingerprinting, a survey of which can be
found in [<cite><a class="bibref" data-link-type="biblio" href="#bib-pugliese2020" title="Long-Term Observation on Browser Fingerprinting: Users' Trackability and Perspective">Pugliese2020</a></cite>].
        </p>
        <p>
To quantify the notion of linkage, [<cite><a class="bibref" data-link-type="biblio" href="#bib-powar2023" title="SoK: Managing risks of linkage attacks on data privacy">Powar2023</a></cite>] introduces the idea of an
<strong>anonymity set</strong>. In the VC case we are concerned with here, the
anonymity set would contain the <em>holder</em> of a particular VC and other
holders associated with a particular <em>issuer</em>. The smaller the anonymity
set the more likely the holder can be tracked across verifiers. Since a signed
VC contains a reference to a public key of the issuer, the starting size for the
anonymity set for a holder possessing a VC from a particular issuer is the
number of VC issued by that issuer with that particular public/private key pair.
Non-malicious issuers are expected to minimize the number of public/private key
pairs used to issue VCs. Note that the anonymity set idea is similar to the
group privacy concept in [<cite><a class="bibref" data-link-type="biblio" href="#bib-vc-bitstring-status-list" title="Bitstring Status List v1.0">vc-bitstring-status-list</a></cite>]. When we use the term
linkage here we generally mean any mechanism that results in a reduction in size
of the anonymity set.
        </p>
        <p>
Sources of linkage in a VC system supporting selective disclosure:
        </p>
        <ol>
          <li>
Artifacts from cryptographic primitives.
          </li>
          <li>
Artifacts from mapping a VC into a set of statements suitable for selective disclosure.
          </li>
          <li>
Artifacts from Proof Options and Mandatory reveal Information in the VC.
          </li>
          <li>
Selectively revealed information in the VC.
          </li>
          <li>
External VC System Based Linkage
          </li>
        </ol>
        <p>
We discuss each of these below.
        </p>
        <section id="linkage-via-cryptographic-artifacts"><div class="header-wrapper"><h4 id="x6-2-1-linkage-via-cryptographic-artifacts"><bdi class="secno">6.2.1 </bdi>Linkage via Cryptographic Artifacts</h4><a class="self-link" href="#linkage-via-cryptographic-artifacts" aria-label="Permalink for Section 6.2.1"></a></div>
          
          <p>
Cryptographic Hashes, HMACs, and digital signatures by their nature generate
highly unique identifiers. The output of a hash function such as SHA-256, by its
collision resistance properties, are guaranteed to be essentially unique given
different inputs and result in a strong linkage, i.e., reduces the anonymity set
size to one. Similarly deterministic signature algorithms such as Ed25519 and
deterministic ECDSA will produce essentially unique outputs for different inputs
and lead to strong linkages.
          </p>
          <p>
This implies that <em>holders</em> can be easily tracked across
<em>verifiers</em> via digital signature, HMAC, or hash artifacts inside VCs and
hence are vulnerable to <em>verifier-verifier</em> collusion and
<em>verifier-issuer</em> collusion. Randomized signature algorithms such as some
forms of ECDSA can permit the issuer to generate many distinct signatures on the
same inputs and send these to the <em>holder</em> for use with different
<em>verifiers</em>. Such an approach could be used to prevent
<em>verifier-verifier</em> collusion based tracking but cannot help with
<em>verifier-issuer</em> collusion.
          </p>
          <p>
To achieve unlinkability requires specially designed cryptographic signature
schemes that allow the <em>holder</em> to generate what is called a <q>zero
knowledge proof of knowledge of a signature</q> (ZKPKS). What this means is that
the <em>holder</em> can take a signature from the <em>issuer</em> in such a
scheme, compute a ZKPKS to send to a <em>verifier</em>. This ZKPKS cannot be
linked back to the original signature, but has all the desirable properties of a
signature, i.e., the <em>verifier</em> can use it to verify that the messages
were signed by the <em>issuers</em> public key and that the messages have not
been altered. In addition, the <em>holder</em> can generate as many ZKPKSs as
desired for different <em>verifiers</em> and these are essentially independent
and unlinkable. BBS is one such signature scheme that supports this capability.
          </p>
          <p>
Although the ZKPKS, known as a <em>BBS proof</em> in this document, has
guaranteed unlinkability properties. BBS when used with selective disclosure has
two artifacts that can contribute to linkability. These are the total number of
messages originally signed, and the index values for the revealed statements.
See the privacy considerations in [<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-SIGNATURE</a></cite>] for a discussion and
mitigation techniques.
          </p>
          <p>
As mentioned in the section on <q>Issuer's Public Keys</q> of
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-SIGNATURE</a></cite>] there is the potential threat that an <em>issuer</em> might
use multiple public keys with some of those used to track a specific subset of
users via <em>verifier-issuer</em> collusion. Since the <em>issuers</em> public
key has to be visible to the <em>verifier</em>, i.e., it is referenced in the BBS
proof (derived proof) this can be used as a linkage point if the <em>issuer</em>
has many different public keys and particularly if it uses a subset of those
keys with a small subset of users (<em>holders</em>).
          </p>
        </section>
        <section id="linkage-via-vc-processing"><div class="header-wrapper"><h4 id="x6-2-2-linkage-via-vc-processing"><bdi class="secno">6.2.2 </bdi>Linkage via VC Processing</h4><a class="self-link" href="#linkage-via-vc-processing" aria-label="Permalink for Section 6.2.2"></a></div>
          
          <p>
We saw in the section on information leakage that RDF canonicalization uses a
hash function to order statements and that a further <q>shuffle</q> of the order
of the statements is performed based on an HMAC. This can leave a fingerprint
that might allow for some linkage. How strong of a linkage is dependent on the
number of blank nodes, essentially JSON objects within the VC, and the number of
indexes revealed. Given <em>n</em> blank nodes and <em>k</em> disclosed indexes
in the worst case this would be a reduction in the anonymity set size by a
factor of <em>C(n, k)</em>, i.e., the number combinations of size <em>k</em>
chosen from a set of <em>n</em> elements. One can keep this number quite low by
reducing the number of blank nodes in the VC, e.g., keep the VC short and
simple.
          </p>
        </section>
        <section id="linkage-via-json-ld-node-identifiers"><div class="header-wrapper"><h4 id="x6-2-3-linkage-via-json-ld-node-identifiers"><bdi class="secno">6.2.3 </bdi>Linkage via JSON-LD Node Identifiers</h4><a class="self-link" href="#linkage-via-json-ld-node-identifiers" aria-label="Permalink for Section 6.2.3"></a></div>
          
          <p>
JSON-LD is a JSON-based format for serialization of Linked Data. As such, it supports
assigning a globally unambiguous <code>@id</code> attribute (node identifier) to each object
("node", in JSON-LD terminology) within a document. This allows for <q>the linking
of linked data</q>, enabling information about the same entity to be correlated.
This correlation can be desirable or undesirable, depending on the use case.
          </p>
          <p>
When using BBS for its unlinkability feature, globally unambiguous node
identifiers cannot be used for individuals nor for their personally identifiable
information, since the strong linkage they provide is undesirable. Note that the
use of such identifiers is acceptable when expressing statements about non-personal
information (e.g., using a globally unambiguous identifier to identify a large
country or a concert event). Also note that JSON-LD's use of <code>@context</code>, which
maps terms to IRIs, does not generally affect unlinkability.
          </p>
        </section>
        <section id="linkage-via-proof-options-and-mandatory-reveal"><div class="header-wrapper"><h4 id="x6-2-4-linkage-via-proof-options-and-mandatory-reveal"><bdi class="secno">6.2.4 </bdi>Linkage via Proof Options and Mandatory Reveal</h4><a class="self-link" href="#linkage-via-proof-options-and-mandatory-reveal" aria-label="Permalink for Section 6.2.4"></a></div>
          
          <p>
In the [<cite><a class="bibref" data-link-type="biblio" href="#bib-vc-data-integrity" title="Verifiable Credential Data Integrity 1.0">vc-data-integrity</a></cite>] specification, a number of properties of the
<code>proof</code> attribute of a VC are given. Care has to be taken that optional fields
ought not provide strong linkage across verifiers. The optional fields include:
<em>id</em>, <em>created</em>, <em>expires</em>, <em>domain</em>,
<em>challenge</em>, and <em>nonce</em>. For example the optional
<em>created</em> field is a <code>dateTimeStamp</code> object which can specify the
creation date for the proof down to an arbitrary sub-second granularity. Such
information, if present, could greatly reduce the size of the anonymity set. If
the issuer wants to include such information they ought to make it as coarse
grained as possible, relative to the number of VCs being issued over time.
          </p>
          <p>
The <em>issuer</em> can also compel a <em>holder</em> to reveal certain
statements to a <em>verifier</em> via the <code>mandatoryPointers</code> input used in the
creation of the <em>Base Proof</em>. See section
<a href="#base-proof-transformation-bbs-2023" class="sec-ref"><bdi class="secno">3.4.2 </bdi>Base Proof Transformation (bbs-2023)</a>,
<a href="#example-mandatory-pointers" class="box-ref">Example<bdi> 9</bdi></a>, and
<a href="#example-json-pointers-and-values" class="box-ref">Example<bdi> 10</bdi></a>. By <q>compel</q> we mean that
a generated Derived Proof will not verify unless these statements are revealed
to the <em>verifier</em>. Care should be taken such that if such information is
required to be disclosed, that the anonymity set remains sufficiently large.
          </p>
        </section>
        <section id="linkage-via-holder-selective-reveal"><div class="header-wrapper"><h4 id="x6-2-5-linkage-via-holder-selective-reveal"><bdi class="secno">6.2.5 </bdi>Linkage via Holder Selective Reveal</h4><a class="self-link" href="#linkage-via-holder-selective-reveal" aria-label="Permalink for Section 6.2.5"></a></div>
          
          <p>
As discussed in [<cite><a class="bibref" data-link-type="biblio" href="#bib-powar2023" title="SoK: Managing risks of linkage attacks on data privacy">Powar2023</a></cite>] there are many documented cases of
re-identification of individuals from linkage attacks. Hence the <em>holder</em>
is urged  to reveal as little information as possible to help keep the anonymity
set large. In addition, it has been shown a number of times that innocuous
seeming information can be highly unique and thus leading to re-identification
or tracking.  See [<cite><a class="bibref" data-link-type="biblio" href="#bib-nistir8053" title="NISTIR 8053: De-Identification of Personal Information">NISTIR8053</a></cite>] for a walk through of a particularly famous
case of a former governor of Massachusetts and [<cite><a class="bibref" data-link-type="biblio" href="#bib-powar2023" title="SoK: Managing risks of linkage attacks on data privacy">Powar2023</a></cite>] for further
analysis and categorization of 94 such public cases.
          </p>
        </section>
        <section id="external-vc-system-based-linkage"><div class="header-wrapper"><h4 id="x6-2-6-external-vc-system-based-linkage"><bdi class="secno">6.2.6 </bdi>External VC System Based Linkage</h4><a class="self-link" href="#external-vc-system-based-linkage" aria-label="Permalink for Section 6.2.6"></a></div>
          
          <p>
It ought to be pointed out that maintaining unlinkability, i.e., anonymity,
requires care in the systems holding and communicating the VCs. Networking
artifacts such as IP address (layer 3) or Ethernet/MAC address (layer 2) are
well known sources of linkage. For example, mobile phone MAC addresses can be
used to track users if they revisited a particular access point, this led to
mobile phone manufacturers providing a MAC address randomization feature.
Public IP addresses generally provide enough information to geolocate an
individual to a city or region within a country potentially greatly reducing
the anonymity set.
          </p>
        </section>
      </section>
    </section>

    <section class="appendix informative" id="test-vectors"><div class="header-wrapper"><h2 id="a-test-vectors"><bdi class="secno">A. </bdi>Test Vectors</h2><a class="self-link" href="#test-vectors" aria-label="Permalink for Appendix A."></a></div><p><em>This section is non-normative.</em></p>
      
      <p>
Demonstration of selective disclosure features including mandatory disclosure,
selective disclosure, and overlap between those,
requires an input credential document with more content than previous test
vectors. To avoid excessively long test vectors, the starting document test
vector is based on a purely fictitious windsurfing (sailing) competition
scenario. In addition, we break the test vectors into two groups, based on those
that would be generated by the issuer (base proof) and those that would be
generated by the holder (derived proof).
        </p>
        <section id="base-proof"><div class="header-wrapper"><h3 id="a-1-base-proof"><bdi class="secno">A.1 </bdi>Base Proof</h3><a class="self-link" href="#base-proof" aria-label="Permalink for Appendix A.1"></a></div>
          
          <p>
To add a selective disclosure base proof to a document, the issuer needs
the following cryptographic key material:
          </p>
          <ol>
            <li>
The issuer's private/public key pair, i.e., the key pair corresponding to the
verification method that will be part of the proof.
            </li>
            <li>
An HMAC key. This is used to randomize the order of the blank node IDs to avoid
potential information leakage via the blank node ID ordering. This is used only
once, and is shared between issuer and holder. The HMAC in this case is
functioning as a pseudorandom function (PRF).
            </li>
          </ol>
          <p>
The key material used for generating the test vectors to test <i>add base
proof</i> is shown below. Hexadecimal representation is used for the BBS key
pairs and the HMAC key.
          </p>
          <div class="example" id="example-private-and-public-keys-for-signature">
        <div class="marker">
    <a class="self-link" href="#example-private-and-public-keys-for-signature">Example<bdi> 7</bdi></a><span class="example-title">: Private and Public keys for Signature</span>
  </div> <pre class="nohighlight">{
  "publicKeyHex": "a4ef1afa3da575496f122b9b78b8c24761531a8a093206ae7c45b80759c168ba4f7a260f9c3367b6c019b4677841104b10665edbe70ba3ebe7d9cfbffbf71eb016f70abfbb163317f372697dc63efd21fc55764f63926a8f02eaea325a2a888f",
  "privateKeyHex": "66d36e118832af4c5e28b2dfe1b9577857e57b042a33e06bdea37b811ed09ee0",
  "hmacKeyString": "00112233445566778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF"
}</pre>
      </div>
          <p>
In our scenario, a sailor is registering with a race organizer for a series of
windsurfing races to be held over a number of days on Maui. The organizer will
inspect the sailor's equipment to certify that what has been declared is
accurate. The sailor's unsigned equipment inventory is shown below.
          </p>
          <div class="example" id="example-credential-without-proof">
        <div class="marker">
    <a class="self-link" href="#example-credential-without-proof">Example<bdi> 8</bdi></a><span class="example-title">: Credential without Proof</span>
  </div> <pre class="nohighlight">{
  "@context": [
    "https://www.w3.org/ns/credentials/v2",
    {
      "@vocab": "https://windsurf.grotto-networking.com/selective#"
    }
  ],
  "type": [
    "VerifiableCredential"
  ],
  "issuer": "https://vc.example/windsurf/racecommittee",
  "credentialSubject": {
    "sailNumber": "Earth101",
    "sails": [
      {
        "size": 5.5,
        "sailName": "Kihei",
        "year": 2023
      },
      {
        "size": 6.1,
        "sailName": "Lahaina",
        "year": 2023
      },
      {
        "size": 7.0,
        "sailName": "Lahaina",
        "year": 2020
      },
      {
        "size": 7.8,
        "sailName": "Lahaina",
        "year": 2023
      }
    ],
    "boards": [
      {
        "boardName": "CompFoil170",
        "brand": "Wailea",
        "year": 2022
      },
      {
        "boardName": "Kanaha Custom",
        "brand": "Wailea",
        "year": 2019
      }
    ]
  }
}</pre>
      </div>
          <p>
In addition to letting other sailors know what kinds of equipment their competitors
may be sailing on, it is mandatory that each sailor disclose the year of their
most recent windsurfing board and full details on two of their sails. Note that
all sailors are identified by a sail number that is printed on all their
equipment. This mandatory information is specified via an array of JSON pointers
as shown below.
          </p>
          <div class="example" id="example-mandatory-pointers">
        <div class="marker">
    <a class="self-link" href="#example-mandatory-pointers">Example<bdi> 9</bdi></a><span class="example-title">: Mandatory Pointers</span>
  </div> <pre class="nohighlight">["/issuer", "/credentialSubject/sailNumber", "/credentialSubject/sails/1", "/credentialSubject/boards/0/year", "/credentialSubject/sails/2"]</pre>
      </div>
          <p>
The result of applying the above JSON pointers to the sailor's equipment document
is shown below.
          </p>
          <div class="example" id="example-json-pointers-and-values">
        <div class="marker">
    <a class="self-link" href="#example-json-pointers-and-values">Example<bdi> 10</bdi></a><span class="example-title">: JSON Pointers and Values</span>
  </div> <pre class="nohighlight">[
  {
    "pointer": "/sailNumber",
    "value": "Earth101"
  },
  {
    "pointer": "/sails/1",
    "value": {
      "size": 6.1,
      "sailName": "Lahaina",
      "year": 2023
    }
  },
  {
    "pointer": "/boards/0/year",
    "value": 2022
  },
  {
    "pointer": "/sails/2",
    "value": {
      "size": 7,
      "sailName": "Lahaina",
      "year": 2020
    }
  }
]</pre>
      </div>
          <p>
Transformation of the unsigned document begins with canonicalizing the document,
as shown below.
          </p>
          <div class="example" id="example-canonical-document">
        <div class="marker">
    <a class="self-link" href="#example-canonical-document">Example<bdi> 11</bdi></a><span class="example-title">: Canonical Document</span>
  </div> <pre class="nohighlight">[
  "_:c14n0 &lt;https://windsurf.grotto-networking.com/selective#boardName&gt; \"CompFoil170\" .\n",
  "_:c14n0 &lt;https://windsurf.grotto-networking.com/selective#brand&gt; \"Wailea\" .\n",
  "_:c14n0 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2022\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n",
  "_:c14n1 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; \"Lahaina\" .\n",
  "_:c14n1 &lt;https://windsurf.grotto-networking.com/selective#size&gt; \"7.8E0\"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .\n",
  "_:c14n1 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2023\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n",
  "_:c14n2 &lt;https://windsurf.grotto-networking.com/selective#boardName&gt; \"Kanaha Custom\" .\n",
  "_:c14n2 &lt;https://windsurf.grotto-networking.com/selective#brand&gt; \"Wailea\" .\n",
  "_:c14n2 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2019\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n",
  "_:c14n3 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; \"Lahaina\" .\n",
  "_:c14n3 &lt;https://windsurf.grotto-networking.com/selective#size&gt; \"7\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n",
  "_:c14n3 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2020\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n",
  "_:c14n4 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; \"Kihei\" .\n",
  "_:c14n4 &lt;https://windsurf.grotto-networking.com/selective#size&gt; \"5.5E0\"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .\n",
  "_:c14n4 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2023\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n",
  "_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#boards&gt; _:c14n0 .\n",
  "_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#boards&gt; _:c14n2 .\n",
  "_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#sailNumber&gt; \"Earth101\" .\n",
  "_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:c14n1 .\n",
  "_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:c14n3 .\n",
  "_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:c14n4 .\n",
  "_:c14n5 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:c14n6 .\n",
  "_:c14n6 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; \"Lahaina\" .\n",
  "_:c14n6 &lt;https://windsurf.grotto-networking.com/selective#size&gt; \"6.1E0\"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .\n",
  "_:c14n6 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2023\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n",
  "_:c14n7 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; &lt;https://www.w3.org/2018/credentials#VerifiableCredential&gt; .\n",
  "_:c14n7 &lt;https://www.w3.org/2018/credentials#credentialSubject&gt; _:c14n5 .\n",
  "_:c14n7 &lt;https://www.w3.org/2018/credentials#issuer&gt; &lt;https://vc.example/windsurf/racecommittee&gt; .\n"
]</pre>
      </div>
          <p>
To prevent possible information leakage from the ordering of the blank node IDs
these are processed through a PRF (i.e., the HMAC) to give the canonicalized HMAC
document shown below. This represents an ordered list of statements that will be
subject to mandatory and selective disclosure, i.e., it is from this list that
statements are grouped.
          </p>
          <div class="example" id="example-canonical-hmac-document">
        <div class="marker">
    <a class="self-link" href="#example-canonical-hmac-document">Example<bdi> 12</bdi></a><span class="example-title">: Canonical HMAC Document</span>
  </div> <pre class="nohighlight">[
  "_:b0 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; &lt;https://www.w3.org/2018/credentials#VerifiableCredential&gt; .\n",
  "_:b0 &lt;https://www.w3.org/2018/credentials#credentialSubject&gt; _:b3 .\n",
  "_:b0 &lt;https://www.w3.org/2018/credentials#issuer&gt; &lt;https://vc.example/windsurf/racecommittee&gt; .\n",
  "_:b1 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; \"Lahaina\" .\n",
  "_:b1 &lt;https://windsurf.grotto-networking.com/selective#size&gt; \"7.8E0\"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .\n",
  "_:b1 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2023\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n",
  "_:b2 &lt;https://windsurf.grotto-networking.com/selective#boardName&gt; \"CompFoil170\" .\n",
  "_:b2 &lt;https://windsurf.grotto-networking.com/selective#brand&gt; \"Wailea\" .\n",
  "_:b2 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2022\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n",
  "_:b3 &lt;https://windsurf.grotto-networking.com/selective#boards&gt; _:b2 .\n",
  "_:b3 &lt;https://windsurf.grotto-networking.com/selective#boards&gt; _:b4 .\n",
  "_:b3 &lt;https://windsurf.grotto-networking.com/selective#sailNumber&gt; \"Earth101\" .\n",
  "_:b3 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:b1 .\n",
  "_:b3 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:b5 .\n",
  "_:b3 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:b6 .\n",
  "_:b3 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:b7 .\n",
  "_:b4 &lt;https://windsurf.grotto-networking.com/selective#boardName&gt; \"Kanaha Custom\" .\n",
  "_:b4 &lt;https://windsurf.grotto-networking.com/selective#brand&gt; \"Wailea\" .\n",
  "_:b4 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2019\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n",
  "_:b5 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; \"Kihei\" .\n",
  "_:b5 &lt;https://windsurf.grotto-networking.com/selective#size&gt; \"5.5E0\"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .\n",
  "_:b5 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2023\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n",
  "_:b6 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; \"Lahaina\" .\n",
  "_:b6 &lt;https://windsurf.grotto-networking.com/selective#size&gt; \"6.1E0\"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .\n",
  "_:b6 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2023\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n",
  "_:b7 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; \"Lahaina\" .\n",
  "_:b7 &lt;https://windsurf.grotto-networking.com/selective#size&gt; \"7\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n",
  "_:b7 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2020\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n"
]</pre>
      </div>
          <p>
The above canonical document gets grouped into mandatory and non-mandatory
statements. The final output of the selective disclosure transformation process
is shown below. Each statement is now grouped as mandatory or non-mandatory, and
its index in the previous list of statements is remembered.
          </p>
          <div class="example" id="example-add-base-transformation">
        <div class="marker">
    <a class="self-link" href="#example-add-base-transformation">Example<bdi> 13</bdi></a><span class="example-title">: Add Base Transformation</span>
  </div> <pre class="nohighlight">{
  "mandatoryPointers": [
    "/issuer",
    "/credentialSubject/sailNumber",
    "/credentialSubject/sails/1",
    "/credentialSubject/boards/0/year",
    "/credentialSubject/sails/2"
  ],
  "mandatory": {
    "dataType": "Map",
    "value": [
      [
        0,
        "_:b0 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; &lt;https://www.w3.org/2018/credentials#VerifiableCredential&gt; .\n"
      ],
      [
        1,
        "_:b0 &lt;https://www.w3.org/2018/credentials#credentialSubject&gt; _:b3 .\n"
      ],
      [
        2,
        "_:b0 &lt;https://www.w3.org/2018/credentials#issuer&gt; &lt;https://vc.example/windsurf/racecommittee&gt; .\n"
      ],
      [
        8,
        "_:b2 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2022\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n"
      ],
      [
        9,
        "_:b3 &lt;https://windsurf.grotto-networking.com/selective#boards&gt; _:b2 .\n"
      ],
      [
        11,
        "_:b3 &lt;https://windsurf.grotto-networking.com/selective#sailNumber&gt; \"Earth101\" .\n"
      ],
      [
        14,
        "_:b3 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:b6 .\n"
      ],
      [
        15,
        "_:b3 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:b7 .\n"
      ],
      [
        22,
        "_:b6 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; \"Lahaina\" .\n"
      ],
      [
        23,
        "_:b6 &lt;https://windsurf.grotto-networking.com/selective#size&gt; \"6.1E0\"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .\n"
      ],
      [
        24,
        "_:b6 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2023\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n"
      ],
      [
        25,
        "_:b7 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; \"Lahaina\" .\n"
      ],
      [
        26,
        "_:b7 &lt;https://windsurf.grotto-networking.com/selective#size&gt; \"7\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n"
      ],
      [
        27,
        "_:b7 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2020\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n"
      ]
    ]
  },
  "nonMandatory": {
    "dataType": "Map",
    "value": [
      [
        3,
        "_:b1 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; \"Lahaina\" .\n"
      ],
      [
        4,
        "_:b1 &lt;https://windsurf.grotto-networking.com/selective#size&gt; \"7.8E0\"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .\n"
      ],
      [
        5,
        "_:b1 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2023\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n"
      ],
      [
        6,
        "_:b2 &lt;https://windsurf.grotto-networking.com/selective#boardName&gt; \"CompFoil170\" .\n"
      ],
      [
        7,
        "_:b2 &lt;https://windsurf.grotto-networking.com/selective#brand&gt; \"Wailea\" .\n"
      ],
      [
        10,
        "_:b3 &lt;https://windsurf.grotto-networking.com/selective#boards&gt; _:b4 .\n"
      ],
      [
        12,
        "_:b3 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:b1 .\n"
      ],
      [
        13,
        "_:b3 &lt;https://windsurf.grotto-networking.com/selective#sails&gt; _:b5 .\n"
      ],
      [
        16,
        "_:b4 &lt;https://windsurf.grotto-networking.com/selective#boardName&gt; \"Kanaha Custom\" .\n"
      ],
      [
        17,
        "_:b4 &lt;https://windsurf.grotto-networking.com/selective#brand&gt; \"Wailea\" .\n"
      ],
      [
        18,
        "_:b4 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2019\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n"
      ],
      [
        19,
        "_:b5 &lt;https://windsurf.grotto-networking.com/selective#sailName&gt; \"Kihei\" .\n"
      ],
      [
        20,
        "_:b5 &lt;https://windsurf.grotto-networking.com/selective#size&gt; \"5.5E0\"^^&lt;http://www.w3.org/2001/XMLSchema#double&gt; .\n"
      ],
      [
        21,
        "_:b5 &lt;https://windsurf.grotto-networking.com/selective#year&gt; \"2023\"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt; .\n"
      ]
    ]
  },
  "hmacKeyString": "00112233445566778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF"
}</pre>
      </div>
          <p>
The next step is to create the base proof configuration and canonicalize it.
This is shown in the following two examples.
          </p>
          <div class="example" id="example-base-proof-configuration">
        <div class="marker">
    <a class="self-link" href="#example-base-proof-configuration">Example<bdi> 14</bdi></a><span class="example-title">: Base Proof Configuration</span>
  </div> <pre class="nohighlight">{
  "type": "DataIntegrityProof",
  "cryptosuite": "bbs-2023",
  "created": "2023-08-15T23:36:38Z",
  "verificationMethod": "did:key:zUC7DerdEmfZ8f4pFajXgGwJoMkV1ofMTmEG5UoNvnWiPiLuGKNeqgRpLH2TV4Xe5mJ2cXV76gRN7LFQwapF1VFu6x2yrr5ci1mXqC1WNUrnHnLgvfZfMH7h6xP6qsf9EKRQrPQ#zUC7DerdEmfZ8f4pFajXgGwJoMkV1ofMTmEG5UoNvnWiPiLuGKNeqgRpLH2TV4Xe5mJ2cXV76gRN7LFQwapF1VFu6x2yrr5ci1mXqC1WNUrnHnLgvfZfMH7h6xP6qsf9EKRQrPQ",
  "proofPurpose": "assertionMethod",
  "@context": [
    "https://www.w3.org/ns/credentials/v2",
    {
      "@vocab": "https://windsurf.grotto-networking.com/selective#"
    }
  ]
}</pre>
      </div>
          <div class="example" id="example-canonical-base-proof-configuration">
        <div class="marker">
    <a class="self-link" href="#example-canonical-base-proof-configuration">Example<bdi> 15</bdi></a><span class="example-title">: Canonical Base Proof Configuration</span>
  </div> <pre class="nohighlight">_:c14n0 &lt;http://purl.org/dc/terms/created&gt; "2023-08-15T23:36:38Z"^^&lt;http://www.w3.org/2001/XMLSchema#dateTime&gt; .
_:c14n0 &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; &lt;https://w3id.org/security#DataIntegrityProof&gt; .
_:c14n0 &lt;https://w3id.org/security#cryptosuite&gt; "bbs-2023"^^&lt;https://w3id.org/security#cryptosuiteString&gt; .
_:c14n0 &lt;https://w3id.org/security#proofPurpose&gt; &lt;https://w3id.org/security#assertionMethod&gt; .
_:c14n0 &lt;https://w3id.org/security#verificationMethod&gt; &lt;did:key:zUC7DerdEmfZ8f4pFajXgGwJoMkV1ofMTmEG5UoNvnWiPiLuGKNeqgRpLH2TV4Xe5mJ2cXV76gRN7LFQwapF1VFu6x2yrr5ci1mXqC1WNUrnHnLgvfZfMH7h6xP6qsf9EKRQrPQ#zUC7DerdEmfZ8f4pFajXgGwJoMkV1ofMTmEG5UoNvnWiPiLuGKNeqgRpLH2TV4Xe5mJ2cXV76gRN7LFQwapF1VFu6x2yrr5ci1mXqC1WNUrnHnLgvfZfMH7h6xP6qsf9EKRQrPQ&gt; .</pre>
      </div>
          <p>
In the hashing step, we compute the SHA-256 hash of the canonicalized proof
options to produce the <code>proofHash</code>, and we compute the SHA-256 hash of the
join of all the mandatory N-Quads to produce the <code>mandatoryHash</code>. These are
shown below in hexadecimal format.
          </p>
          <div class="example" id="example-add-base-hashes">
        <div class="marker">
    <a class="self-link" href="#example-add-base-hashes">Example<bdi> 16</bdi></a><span class="example-title">: Add Base Hashes</span>
  </div> <pre class="nohighlight">{
  "proofHash": "3a5bbf25d34d90b18c35cd2357be6a6f42301e94fc9e52f77e93b773c5614bdf",
  "mandatoryHash": "555de05f898817e31301bac187d0c3ff2b03e2cbdb4adb4d568c17de961f9a18"
}</pre>
      </div>
          <p>
Shown below are the computed <code>bbsSignature</code> in hexadecimal, and the
<code>mandatoryPointers</code>. These are are fed to the final serialization step with the
<code>hmacKey</code>.
          </p>
          <div class="example" id="example-add-base-signing">
        <div class="marker">
    <a class="self-link" href="#example-add-base-signing">Example<bdi> 17</bdi></a><span class="example-title">: Add Base Signing</span>
  </div> <pre class="nohighlight">{
  "bbsSignature": "86bb8063768d4b708f9a65821ee6fe426b3d4f6fe5c2c5c9a5f80caa573fd8c20cbdf17826fe4e1a624070ba5f201d9202a0fceb55842ea9e61a72a7aa04891437fc35f6ab9ef8bf8ec3004cc46c9458",
  "mandatoryPointers": [
    "/issuer",
    "/credentialSubject/sailNumber",
    "/credentialSubject/sails/1",
    "/credentialSubject/boards/0/year",
    "/credentialSubject/sails/2"
  ]
}</pre>
      </div>
          <p>
Finally, the values above are run through the algorithm of Section
<a href="#serializebaseproofvalue" class="sec-ref"><bdi class="secno">3.3.1 </bdi>serializeBaseProofValue</a>, to produce the <code>proofValue</code> which is
used in the signed base document shown below.
          </p>
          <div class="example" id="example-signed-base-document">
        <div class="marker">
    <a class="self-link" href="#example-signed-base-document">Example<bdi> 18</bdi></a><span class="example-title">: Signed Base Document</span>
  </div> <pre class="nohighlight">{
  "@context": [
    "https://www.w3.org/ns/credentials/v2",
    {
      "@vocab": "https://windsurf.grotto-networking.com/selective#"
    }
  ],
  "type": [
    "VerifiableCredential"
  ],
  "issuer": "https://vc.example/windsurf/racecommittee",
  "credentialSubject": {
    "sailNumber": "Earth101",
    "sails": [
      {
        "size": 5.5,
        "sailName": "Kihei",
        "year": 2023
      },
      {
        "size": 6.1,
        "sailName": "Lahaina",
        "year": 2023
      },
      {
        "size": 7,
        "sailName": "Lahaina",
        "year": 2020
      },
      {
        "size": 7.8,
        "sailName": "Lahaina",
        "year": 2023
      }
    ],
    "boards": [
      {
        "boardName": "CompFoil170",
        "brand": "Wailea",
        "year": 2022
      },
      {
        "boardName": "Kanaha Custom",
        "brand": "Wailea",
        "year": 2019
      }
    ]
  },
  "proof": {
    "type": "DataIntegrityProof",
    "cryptosuite": "bbs-2023",
    "created": "2023-08-15T23:36:38Z",
    "verificationMethod": "did:key:zUC7DerdEmfZ8f4pFajXgGwJoMkV1ofMTmEG5UoNvnWiPiLuGKNeqgRpLH2TV4Xe5mJ2cXV76gRN7LFQwapF1VFu6x2yrr5ci1mXqC1WNUrnHnLgvfZfMH7h6xP6qsf9EKRQrPQ#zUC7DerdEmfZ8f4pFajXgGwJoMkV1ofMTmEG5UoNvnWiPiLuGKNeqgRpLH2TV4Xe5mJ2cXV76gRN7LFQwapF1VFu6x2yrr5ci1mXqC1WNUrnHnLgvfZfMH7h6xP6qsf9EKRQrPQ",
    "proofPurpose": "assertionMethod",
    "proofValue": "u2V0ChVhQhruAY3aNS3CPmmWCHub-Qms9T2_lwsXJpfgMqlc_2MIMvfF4Jv5OGmJAcLpfIB2SAqD861WELqnmGnKnqgSJFDf8Nfarnvi_jsMATMRslFhYQDpbvyXTTZCxjDXNI1e-am9CMB6U_J5S936Tt3PFYUvfVV3gX4mIF-MTAbrBh9DD_ysD4svbSttNVowX3pYfmhhYYKTvGvo9pXVJbxIrm3i4wkdhUxqKCTIGrnxFuAdZwWi6T3omD5wzZ7bAGbRneEEQSxBmXtvnC6Pr59nPv_v3HrAW9wq_uxYzF_NyaX3GPv0h_FV2T2OSao8C6uoyWiqIj1ggABEiM0RVZneImaq7zN3u_wARIjNEVWZ3iJmqu8zd7v-FZy9pc3N1ZXJ4HS9jcmVkZW50aWFsU3ViamVjdC9zYWlsTnVtYmVyeBovY3JlZGVudGlhbFN1YmplY3Qvc2FpbHMvMXggL2NyZWRlbnRpYWxTdWJqZWN0L2JvYXJkcy8wL3llYXJ4Gi9jcmVkZW50aWFsU3ViamVjdC9zYWlscy8y"
  }
}</pre>
      </div>
        </section>
        <section id="derived-proof"><div class="header-wrapper"><h3 id="a-2-derived-proof"><bdi class="secno">A.2 </bdi>Derived Proof</h3><a class="self-link" href="#derived-proof" aria-label="Permalink for Appendix A.2"></a></div>
          
          <p>
Random numbers are used, and an optional <code>presentationHeader</code> can be an input,
for the creation of <q>BBS proofs</q>. To furnish a deterministic set of test
vectors, we used the <q>Mocked Random Scalars</q> procedure from
[<cite><a class="bibref" data-link-type="biblio" href="#bib-cfrg-bbs-signature" title="The BBS Signature Scheme">CFRG-BBS-SIGNATURE</a></cite>]. The <code>seed</code> and <code>presentationHeader</code> values we used for
generation of the derived proof test vectors are given in hex, below.
          </p>
          <div class="example" id="example-seed-and-presentation-header-values">
        <div class="marker">
    <a class="self-link" href="#example-seed-and-presentation-header-values">Example<bdi> 19</bdi></a><span class="example-title">: seed and presentation header values</span>
  </div> <pre class="nohighlight">{
  "presentationHeaderHex": "113377aa",
  "pseudoRandSeedHex": "332e313431353932363533353839373933323338343632363433333833323739"
}</pre>
      </div>
          <p>
To create a derived proof, a holder starts with a signed document
containing a base proof. The base document we will use for these test vectors is
the final example from Section <a href="#base-proof" class="sec-ref"><bdi class="secno">A.1 </bdi>Base Proof</a>, above. The first
step is to run the algorithm of Section <a href="#parsebaseproofvalue" class="sec-ref"><bdi class="secno">3.3.2 </bdi>parseBaseProofValue</a> to
recover <code>bbsSignature</code>, <code>hmacKey</code>, and <code>mandatoryPointers</code>, as shown below.
          </p>
          <div class="example" id="example-recovered-base-signature-data">
        <div class="marker">
    <a class="self-link" href="#example-recovered-base-signature-data">Example<bdi> 20</bdi></a><span class="example-title">: Recovered Base Signature Data</span>
  </div> <pre class="nohighlight">{
  "bbsSignature": "86bb8063768d4b708f9a65821ee6fe426b3d4f6fe5c2c5c9a5f80caa573fd8c20cbdf17826fe4e1a624070ba5f201d9202a0fceb55842ea9e61a72a7aa04891437fc35f6ab9ef8bf8ec3004cc46c9458",
  "hmacKey": "00112233445566778899aabbccddeeff00112233445566778899aabbccddeeff",
  "mandatoryPointers": [
    "/issuer",
    "/credentialSubject/sailNumber",
    "/credentialSubject/sails/1",
    "/credentialSubject/boards/0/year",
    "/credentialSubject/sails/2"
  ]
}</pre>
      </div>
          <p>
Next, the holder needs to indicate what else, if anything, they wish to reveal
to the verifiers, by specifying JSON pointers for selective disclosure. In our
windsurfing competition scenario, a sailor (the holder) has just completed their
first day of racing, and wishes to reveal to the general public (the verifiers)
all the details of the windsurfing boards they used in the competition. These
are shown below. Note that this slightly overlaps with the mandatory disclosed
information which included only the year of their most recent board.
          </p>
          <div class="example" id="example-selective-disclosure-pointers">
        <div class="marker">
    <a class="self-link" href="#example-selective-disclosure-pointers">Example<bdi> 21</bdi></a><span class="example-title">: Selective Disclosure Pointers</span>
  </div> <pre class="nohighlight">["/credentialSubject/boards/0", "/credentialSubject/boards/1"]</pre>
      </div>
          <p>
To produce the <code>revealDocument</code> (i.e., the unsigned document that will
eventually be signed and sent to the verifier), we append the selective pointers
to the mandatory pointers, and input these combined pointers along with the
document without proof to the <code>selectJsonLd</code> algorithm of [<cite><a class="bibref" data-link-type="biblio" href="#bib-di-ecdsa" title="The Elliptic Curve Digital Signature Algorithm Cryptosuites v1.0">DI-ECDSA</a></cite>],
to get the result shown below.
          </p>
          <div class="example" id="example-unsigned-reveal-document">
        <div class="marker">
    <a class="self-link" href="#example-unsigned-reveal-document">Example<bdi> 22</bdi></a><span class="example-title">: Unsigned Reveal Document</span>
  </div> <pre class="nohighlight">{
  "@context": [
    "https://www.w3.org/ns/credentials/v2",
    {
      "@vocab": "https://windsurf.grotto-networking.com/selective#"
    }
  ],
  "type": [
    "VerifiableCredential"
  ],
  "issuer": "https://vc.example/windsurf/racecommittee",
  "credentialSubject": {
    "sailNumber": "Earth101",
    "sails": [
      {
        "size": 6.1,
        "sailName": "Lahaina",
        "year": 2023
      },
      {
        "size": 7,
        "sailName": "Lahaina",
        "year": 2020
      }
    ],
    "boards": [
      {
        "year": 2022,
        "boardName": "CompFoil170",
        "brand": "Wailea"
      },
      {
        "boardName": "Kanaha Custom",
        "brand": "Wailea",
        "year": 2019
      }
    ]
  }
}</pre>
      </div>
          <p>
Now that we know what the revealed document looks like, we need to furnish
appropriately updated information to the verifier about which statements are
mandatory, and the indexes for the selected non-mandatory statements. Running
step 6 of the
<a href="#createdisclosuredata" class="sec-ref"><bdi class="secno">3.3.3 </bdi>createDisclosureData</a> yields an abundance of information about
various statement groups relative to the original document. Below we show a
portion of the indexes for those groups.
          </p>
          <div class="example" id="example-derived-group-indexes">
        <div class="marker">
    <a class="self-link" href="#example-derived-group-indexes">Example<bdi> 23</bdi></a><span class="example-title">: Derived Group Indexes</span>
  </div> <pre class="nohighlight">{
  "combinedIndexes":[0,1,2,6,7,8,9,10,11,14,15,16,17,18,22,23,24,25,26,27],
  "mandatoryIndexes":[0,1,2,8,9,11,14,15,22,23,24,25,26,27],
  "nonMandatoryIndexes":[3,4,5,6,7,10,12,13,16,17,18,19,20,21],
  "selectiveIndexes":[0,1,6,7,8,9,10,16,17,18]
}</pre>
      </div>
          <p>
The verifier needs to be able to aggregate and hash the mandatory statements. To
enable this, we furnish them with a list of indexes of the mandatory statements
adjusted to their positions in the reveal document (i.e., relative to the
<code>combinedIndexes</code>), while the <code>selectiveIndexes</code> need to be adjusted relative to
their positions within the <code>nonMandatoryIndexes</code>. These "adjusted" indexes are
shown below.
          </p>
          <div class="example" id="example-adjusted-mandatory-and-selective-indexes">
        <div class="marker">
    <a class="self-link" href="#example-adjusted-mandatory-and-selective-indexes">Example<bdi> 24</bdi></a><span class="example-title">: Adjusted Mandatory and Selective Indexes</span>
  </div> <pre class="nohighlight">{
  "adjMandatoryIndexes":[0,1,2,5,6,8,9,10,14,15,16,17,18,19],
  "adjSelectiveIndexes":[3,4,5,8,9,10]
}</pre>
      </div>

          <p>
The last important piece of disclosure data is a mapping of canonical blank node
IDs to HMAC-based shuffled IDs, the <code>labelMap</code>, computed according to Section
<a href="#createdisclosuredata" class="sec-ref"><bdi class="secno">3.3.3 </bdi>createDisclosureData</a>. This is shown below along with
the rest of the disclosure data minus the reveal document.
          </p>
          <div class="example" id="example-disclosure-data">
        <div class="marker">
    <a class="self-link" href="#example-disclosure-data">Example<bdi> 25</bdi></a><span class="example-title">: Disclosure Data</span>
  </div> <pre class="nohighlight">{
  "bbsProof":"85b72d74b55aae76e4f8e986387352f6d3e13f19387f5935a9f34c59aa3af77885501ef1dba67576bd24e6dab1b1c5b3891671112c26982c441d4f352e1bc8f5451127fbda2ad240d9a5d6933f455db741cc3e79d3281bc5b611118b363461f2b6a5ecdd423f6b76711680824665f50eec1f5cbaf219ee90e66ceac575146d1a8935f770be6d29a376b00e4e39a4fa7755ecf4eb42aa3babfd6e48bb23e91081f08d0d259b4029683d01c25378be3c61213a097750b8ce2a3c0915061a547405b3ce587d1d8299269fad29103509b3e53067f7b6078e9dc66a5112192aede3662e6dac5876d945fd05863fb249b0fca02e10ab5173650ef665e92c3ea72eaba94fca860cd6c639538e5156f8cbc3b4d222f7a11f837bb9e76ba54d58c1b4ac834ef338a3db4bf645b4622153c897f477255f40e4fcc7919348ae5bf9032a9f7c0876e47a6666ca9f178673ac7a41b864480d8e84c6655cd2f0e1866dedc467590a2ba76c28cb41f3d5582e0773b737914b8353fea4df918a022aa5aa92f490f0b3c2edf4a4d5538b8d07aa2530f118863e654eeaaac69c2c020509c24294c13bda721c73b8610bbce7e7030d1710dd5148731a5026c741d1da9e0693d32b90d09bb58a8e4a295a32fb27f654a03c31c56e6c3afb1aa3f2fa240f5095f31fe8b95f8179bc4408cf96713f3aec6a06409a6f1486a99d9923befdb274d3e04f6faa9bf316ce9a2c4f5e1bc6db031593323b",
  "labelMap":{"dataType":"Map","value":[["c14n0","b2"],["c14n1","b4"],["c14n2","b3"],["c14n3","b7"],["c14n4","b6"],["c14n5","b0"]]},
  "mandatoryIndexes":[0,1,2,5,6,8,9,10,14,15,16,17,18,19],
  "adjSelectiveIndexes":[3,4,5,8,9,10],
  "presentationHeader":{"0":17,"1":51,"2":119,"3":170}
}</pre>
      </div>
          <p>
Finally, using the disclosure data above with the algorithm of Section
<a href="#serializederivedproofvalue" class="sec-ref"><bdi class="secno">3.3.6 </bdi>serializeDerivedProofValue</a>, we obtain the signed derived (reveal)
document shown below.
          </p>
          <div class="example" id="example-signed-derived-document">
        <div class="marker">
    <a class="self-link" href="#example-signed-derived-document">Example<bdi> 26</bdi></a><span class="example-title">: Signed Derived Document</span>
  </div> <pre class="nohighlight">{
  "@context": [
    "https://www.w3.org/ns/credentials/v2",
    {
      "@vocab": "https://windsurf.grotto-networking.com/selective#"
    }
  ],
  "type": [
    "VerifiableCredential"
  ],
  "issuer": "https://vc.example/windsurf/racecommittee",
  "credentialSubject": {
    "sailNumber": "Earth101",
    "sails": [
      {
        "size": 6.1,
        "sailName": "Lahaina",
        "year": 2023
      },
      {
        "size": 7,
        "sailName": "Lahaina",
        "year": 2020
      }
    ],
    "boards": [
      {
        "year": 2022,
        "boardName": "CompFoil170",
        "brand": "Wailea"
      },
      {
        "boardName": "Kanaha Custom",
        "brand": "Wailea",
        "year": 2019
      }
    ]
  },
  "proof": {
    "type": "DataIntegrityProof",
    "cryptosuite": "bbs-2023",
    "created": "2023-08-15T23:36:38Z",
    "verificationMethod": "did:key:zUC7DerdEmfZ8f4pFajXgGwJoMkV1ofMTmEG5UoNvnWiPiLuGKNeqgRpLH2TV4Xe5mJ2cXV76gRN7LFQwapF1VFu6x2yrr5ci1mXqC1WNUrnHnLgvfZfMH7h6xP6qsf9EKRQrPQ#zUC7DerdEmfZ8f4pFajXgGwJoMkV1ofMTmEG5UoNvnWiPiLuGKNeqgRpLH2TV4Xe5mJ2cXV76gRN7LFQwapF1VFu6x2yrr5ci1mXqC1WNUrnHnLgvfZfMH7h6xP6qsf9EKRQrPQ",
    "proofPurpose": "assertionMethod",
    "proofValue": "u2V0DhVkCEIW3LXS1Wq525PjphjhzUvbT4T8ZOH9ZNanzTFmqOvd4hVAe8dumdXa9JObasbHFs4kWcREsJpgsRB1PNS4byPVFESf72irSQNml1pM_RV23Qcw-edMoG8W2ERGLNjRh8ral7N1CP2t2cRaAgkZl9Q7sH1y68hnukOZs6sV1FG0aiTX3cL5tKaN2sA5OOaT6d1Xs9OtCqjur_W5IuyPpEIHwjQ0lm0ApaD0BwlN4vjxhIToJd1C4zio8CRUGGlR0BbPOWH0dgpkmn60pEDUJs-UwZ_e2B46dxmpREhkq7eNmLm2sWHbZRf0Fhj-ySbD8oC4Qq1FzZQ72ZeksPqcuq6lPyoYM1sY5U45RVvjLw7TSIvehH4N7uedrpU1YwbSsg07zOKPbS_ZFtGIhU8iX9HclX0Dk_MeRk0iuW_kDKp98CHbkemZmyp8XhnOsekG4ZEgNjoTGZVzS8OGGbe3EZ1kKK6dsKMtB89VYLgdztzeRS4NT_qTfkYoCKqWqkvSQ8LPC7fSk1VOLjQeqJTDxGIY-ZU7qqsacLAIFCcJClME72nIcc7hhC7zn5wMNFxDdUUhzGlAmx0HR2p4Gk9MrkNCbtYqOSilaMvsn9lSgPDHFbmw6-xqj8vokD1CV8x_ouV-BebxECM-WcT867GoGQJpvFIapnZkjvv2ydNPgT2-qm_MWzposT14bxtsDFZMyO6YAAgEEAgMDBwQGBQCOAAECBQYICQoODxAREhOGAwQFCAkKRBEzd6o"
  }
}</pre>
      </div>
        </section>

    </section>
    <section class="appendix" id="acknowledgements"><div class="header-wrapper"><h2 id="b-acknowledgements"><bdi class="secno">B. </bdi>Acknowledgements</h2><a class="self-link" href="#acknowledgements" aria-label="Permalink for Appendix B."></a></div>
      
      <p>
        Portions of the work on this specification have been funded by the
        United States Department of Homeland Security's (US DHS) Silicon Valley
        Innovation Program under contracts
        70RSAT20T00000003,
        and
        70RSAT20T00000033.
        The content of this specification does not
        necessarily reflect the position or the policy of the U.S. Government
        and no official endorsement should be inferred.
      </p>
    </section>
  

<section id="references" class="appendix"><div class="header-wrapper"><h2 id="c-references"><bdi class="secno">C. </bdi>References</h2><a class="self-link" href="#references" aria-label="Permalink for Appendix C."></a></div><section id="normative-references"><div class="header-wrapper"><h3 id="c-1-normative-references"><bdi class="secno">C.1 </bdi>Normative references</h3><a class="self-link" href="#normative-references" aria-label="Permalink for Appendix C.1"></a></div>
    
    <dl class="bibliography"><dt id="bib-cfrg-bbs-signature">[CFRG-BBS-SIGNATURE]</dt><dd>
      <a href="https://www.ietf.org/archive/id/draft-irtf-cfrg-bbs-signatures-02.html"><cite>The BBS Signature Scheme</cite></a>. Tobias Looker; Vasilis Kalos; Andrew Whitehead; Mike Lodder. Draft. URL: <a href="https://www.ietf.org/archive/id/draft-irtf-cfrg-bbs-signatures-02.html">https://www.ietf.org/archive/id/draft-irtf-cfrg-bbs-signatures-02.html</a>
    </dd><dt id="bib-cfrg-blind-bbs-signature">[CFRG-Blind-BBS-Signature]</dt><dd>
      <a href="https://www.ietf.org/archive/id/draft-kalos-bbs-blind-signatures-00.html#name-proof-generation"><cite>Blind BBS Signatures</cite></a>. V. Kalos; G. Bernstein. 2024. URL: <a href="https://www.ietf.org/archive/id/draft-kalos-bbs-blind-signatures-00.html#name-proof-generation">https://www.ietf.org/archive/id/draft-kalos-bbs-blind-signatures-00.html#name-proof-generation</a>
    </dd><dt id="bib-cfrg-pseudonym-bbs-signature">[CFRG-Pseudonym-BBS-Signature]</dt><dd>
      <a href="https://basileioskal.github.io/bbs-per-verifier-id/draft-vasilis-bbs-per-verifier-linkability.html"><cite>BBS per Verifier Linkability</cite></a>. V. Kalos. 2023. URL: <a href="https://basileioskal.github.io/bbs-per-verifier-id/draft-vasilis-bbs-per-verifier-linkability.html">https://basileioskal.github.io/bbs-per-verifier-id/draft-vasilis-bbs-per-verifier-linkability.html</a>
    </dd><dt id="bib-di-ecdsa">[DI-ECDSA]</dt><dd>
      <a href="https://www.w3.org/TR/vc-di-ecdsa/"><cite>The Elliptic Curve Digital Signature Algorithm Cryptosuites v1.0</cite></a>. David Longley; Manu Sporny; Marty Reed.  W3C Verifiable Credentials Working Group. W3C Working Draft. URL: <a href="https://www.w3.org/TR/vc-di-ecdsa/">https://www.w3.org/TR/vc-di-ecdsa/</a>
    </dd><dt id="bib-infra">[INFRA]</dt><dd>
      <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Anne van Kesteren; Domenic Denicola.  WHATWG. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
    </dd><dt id="bib-rdf-canon">[RDF-CANON]</dt><dd>
      <a href="https://www.w3.org/TR/rdf-canon/"><cite>RDF Dataset Canonicalization</cite></a>. Dave Longley; Gregg Kellogg; Dan Yamamoto.  W3C. 30 November 2023. W3C Candidate Recommendation. URL: <a href="https://www.w3.org/TR/rdf-canon/">https://www.w3.org/TR/rdf-canon/</a>
    </dd><dt id="bib-rfc2104">[RFC2104]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc2104"><cite>HMAC: Keyed-Hashing for Message Authentication</cite></a>. H. Krawczyk; M. Bellare; R. Canetti.  IETF. February 1997. Informational. URL: <a href="https://www.rfc-editor.org/rfc/rfc2104">https://www.rfc-editor.org/rfc/rfc2104</a>
    </dd><dt id="bib-rfc2119">[RFC2119]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. S. Bradner.  IETF. March 1997. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>
    </dd><dt id="bib-rfc8174">[RFC8174]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc8174"><cite>Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words</cite></a>. B. Leiba.  IETF. May 2017. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>
    </dd><dt id="bib-rfc8949">[RFC8949]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc8949"><cite>Concise Binary Object Representation (CBOR)</cite></a>. C. Bormann; P. Hoffman.  IETF. December 2020. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8949">https://www.rfc-editor.org/rfc/rfc8949</a>
    </dd><dt id="bib-vc-data-integrity">[VC-DATA-INTEGRITY]</dt><dd>
      <a href="https://www.w3.org/TR/vc-data-integrity/"><cite>Verifiable Credential Data Integrity 1.0</cite></a>. Manu Sporny; Dave Longley; Greg Bernstein; Dmitri Zagidulin; Sebastian Crane.  W3C. 10 December 2023. W3C Candidate Recommendation. URL: <a href="https://www.w3.org/TR/vc-data-integrity/">https://www.w3.org/TR/vc-data-integrity/</a>
    </dd><dt id="bib-vc-data-model-2.0">[VC-DATA-MODEL-2.0]</dt><dd>
      <a href="https://www.w3.org/TR/vc-data-model-2.0/"><cite>Verifiable Credentials Data Model v2.0</cite></a>. Manu Sporny; Ted Thibodeau Jr; Ivan Herman; Michael Jones; Gabe Cohen.  W3C. 7 February 2024. W3C Candidate Recommendation. URL: <a href="https://www.w3.org/TR/vc-data-model-2.0/">https://www.w3.org/TR/vc-data-model-2.0/</a>
    </dd><dt id="bib-xmlschema11-2">[XMLSCHEMA11-2]</dt><dd>
      <a href="https://www.w3.org/TR/xmlschema11-2/"><cite>W3C XML Schema Definition Language (XSD) 1.1 Part 2: Datatypes</cite></a>. David Peterson; Sandy Gao; Ashok Malhotra; Michael Sperberg-McQueen; Henry Thompson; Paul V. Biron et al.  W3C. 5 April 2012. W3C Recommendation. URL: <a href="https://www.w3.org/TR/xmlschema11-2/">https://www.w3.org/TR/xmlschema11-2/</a>
    </dd></dl>
  </section><section id="informative-references"><div class="header-wrapper"><h3 id="c-2-informative-references"><bdi class="secno">C.2 </bdi>Informative references</h3><a class="self-link" href="#informative-references" aria-label="Permalink for Appendix C.2"></a></div>
    
    <dl class="bibliography"><dt id="bib-cdl2016">[CDL2016]</dt><dd>
      <a href="https://eprint.iacr.org/2016/663"><cite>Anonymous Attestation Using the Strong Diffie Hellman Assumption Revisited</cite></a>. Jan Camenisch; Manu Drijvers; Anja Lehmann.  Cryptology ePrint Archive, Paper 2016/663. 2016. URL: <a href="https://eprint.iacr.org/2016/663">https://eprint.iacr.org/2016/663</a>
    </dd><dt id="bib-cfrg-pairing-friendly">[CFRG-PAIRING-FRIENDLY]</dt><dd>
      <a href="https://www.ietf.org/archive/id/draft-irtf-cfrg-pairing-friendly-curves-11.html"><cite>Pairing-Friendly Curves</cite></a>. Yumi Sakemi; Tetsutaro Kobayashi; Tsunekazu Saito; Riad S. Wahby. Draft. URL: <a href="https://www.ietf.org/archive/id/draft-irtf-cfrg-pairing-friendly-curves-11.html">https://www.ietf.org/archive/id/draft-irtf-cfrg-pairing-friendly-curves-11.html</a>
    </dd><dt id="bib-nistir8053">[NISTIR8053]</dt><dd>
      <a href="https://nvlpubs.nist.gov/nistpubs/ir/2015/NIST.IR.8053.pdf"><cite>NISTIR 8053: De-Identification of Personal Information</cite></a>. Simson L. Garfinkel. October 2015. URL: <a href="https://nvlpubs.nist.gov/nistpubs/ir/2015/NIST.IR.8053.pdf">https://nvlpubs.nist.gov/nistpubs/ir/2015/NIST.IR.8053.pdf</a>
    </dd><dt id="bib-powar2023">[Powar2023]</dt><dd>
      <a href="https://petsymposium.org/popets/2023/popets-2023-0043.php"><cite>SoK: Managing risks of linkage attacks on data privacy</cite></a>. J. Powar; A. R. Beresford.  Proceedings on Privacy Enhancing Technologies. 2023. URL: <a href="https://petsymposium.org/popets/2023/popets-2023-0043.php">https://petsymposium.org/popets/2023/popets-2023-0043.php</a>
    </dd><dt id="bib-pugliese2020">[Pugliese2020]</dt><dd>
      <a href="https://petsymposium.org/popets/2020/popets-2020-0041.php"><cite>Long-Term Observation on Browser Fingerprinting: Users' Trackability and Perspective</cite></a>. G. Pugliese; C. Riess; F. Gassmann; Z. Benenson.  Proceedings on Privacy Enhancing Technologies. 2020. URL: <a href="https://petsymposium.org/popets/2020/popets-2020-0041.php">https://petsymposium.org/popets/2020/popets-2020-0041.php</a>
    </dd><dt id="bib-taming_eddsas">[Taming_EdDSAs]</dt><dd>
      <a href="https://eprint.iacr.org/2020/1244"><cite>Taming the many EdDSAs</cite></a>. Konstantinos Chalkias; François Garillot; Valeria Nikolaenko.  Cryptology ePrint Archive, Paper 2020/1244. 2020. URL: <a href="https://eprint.iacr.org/2020/1244">https://eprint.iacr.org/2020/1244</a>
    </dd><dt id="bib-tz2023">[TZ2023]</dt><dd>
      <a href="https://eprint.iacr.org/2023/275"><cite>Revisiting BBS Signatures</cite></a>. Stefano Tessaro; Chenzhi Zhu.  Cryptology ePrint Archive, Paper 2023/275. 2023. URL: <a href="https://eprint.iacr.org/2023/275">https://eprint.iacr.org/2023/275</a>
    </dd><dt id="bib-vc-bitstring-status-list">[vc-bitstring-status-list]</dt><dd>
      <a href="https://www.w3.org/TR/vc-bitstring-status-list/"><cite>Bitstring Status List v1.0</cite></a>. Manu Sporny; Dave Longley; Michael Prorock; Mahmoud Alkhraishi.  W3C. 4 February 2024. W3C Working Draft. URL: <a href="https://www.w3.org/TR/vc-bitstring-status-list/">https://www.w3.org/TR/vc-bitstring-status-list/</a>
    </dd></dl>
  </section></section><p role="navigation" id="back-to-top">
    <a href="#title"><abbr title="Back to Top">↑</abbr></a>
  </p><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-conforming-proof" aria-label="Links in this document to definition: conforming proof">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-conforming-proof" aria-label="Permalink for definition: conforming proof. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-conforming-proof-1" title="§ 1.2 Conformance">§ 1.2 Conformance</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-conforming-processor" aria-label="Links in this document to definition: conforming processor">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-conforming-processor" aria-label="Permalink for definition: conforming processor. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
      <li>Not referenced in this document.</li>
    </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-verification-result" aria-label="Links in this document to definition: verification result">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-verification-result" aria-label="Permalink for definition: verification result. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-verification-result-1" title="§ 3.4.7 Verify Derived Proof (bbs-2023)">§ 3.4.7 Verify Derived Proof (bbs-2023)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-verified" aria-label="Links in this document to definition: verified">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-verified" aria-label="Permalink for definition: verified. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-verified-1" title="§ 3.4.7 Verify Derived Proof (bbs-2023)">§ 3.4.7 Verify Derived Proof (bbs-2023)</a> <a href="#ref-for-dfn-verified-2" title="Reference 2">(2)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-verifieddocument" aria-label="Links in this document to definition: verifiedDocument">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-verifieddocument" aria-label="Permalink for definition: verifiedDocument. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-verifieddocument-1" title="§ 3.4.7 Verify Derived Proof (bbs-2023)">§ 3.4.7 Verify Derived Proof (bbs-2023)</a> 
    </li>
  </ul>
    </div><script id="respec-dfn-panel">(() => {
// @ts-check
if (document.respec) {
  document.respec.ready.then(setupPanel);
} else {
  setupPanel();
}

function setupPanel() {
  const listener = panelListener();
  document.body.addEventListener("keydown", listener);
  document.body.addEventListener("click", listener);
}

function panelListener() {
  /** @type {HTMLElement} */
  let panel = null;
  return event => {
    const { target, type } = event;

    if (!(target instanceof HTMLElement)) return;

    // For keys, we only care about Enter key to activate the panel
    // otherwise it's activated via a click.
    if (type === "keydown" && event.key !== "Enter") return;

    const action = deriveAction(event);

    switch (action) {
      case "show": {
        hidePanel(panel);
        /** @type {HTMLElement} */
        const dfn = target.closest("dfn, .index-term");
        panel = document.getElementById(`dfn-panel-for-${dfn.id}`);
        const coords = deriveCoordinates(event);
        displayPanel(dfn, panel, coords);
        break;
      }
      case "dock": {
        panel.style.left = null;
        panel.style.top = null;
        panel.classList.add("docked");
        break;
      }
      case "hide": {
        hidePanel(panel);
        panel = null;
        break;
      }
    }
  };
}

/**
 * @param {MouseEvent|KeyboardEvent} event
 */
function deriveCoordinates(event) {
  const target = /** @type HTMLElement */ (event.target);

  // We prevent synthetic AT clicks from putting
  // the dialog in a weird place. The AT events sometimes
  // lack coordinates, so they have clientX/Y = 0
  const rect = target.getBoundingClientRect();
  if (
    event instanceof MouseEvent &&
    event.clientX >= rect.left &&
    event.clientY >= rect.top
  ) {
    // The event probably happened inside the bounding rect...
    return { x: event.clientX, y: event.clientY };
  }

  // Offset to the middle of the element
  const x = rect.x + rect.width / 2;
  // Placed at the bottom of the element
  const y = rect.y + rect.height;
  return { x, y };
}

/**
 * @param {Event} event
 */
function deriveAction(event) {
  const target = /** @type {HTMLElement} */ (event.target);
  const hitALink = !!target.closest("a");
  if (target.closest("dfn:not([data-cite]), .index-term")) {
    return hitALink ? "none" : "show";
  }
  if (target.closest(".dfn-panel")) {
    if (hitALink) {
      return target.classList.contains("self-link") ? "hide" : "dock";
    }
    const panel = target.closest(".dfn-panel");
    return panel.classList.contains("docked") ? "hide" : "none";
  }
  if (document.querySelector(".dfn-panel:not([hidden])")) {
    return "hide";
  }
  return "none";
}

/**
 * @param {HTMLElement} dfn
 * @param {HTMLElement} panel
 * @param {{ x: number, y: number }} clickPosition
 */
function displayPanel(dfn, panel, { x, y }) {
  panel.hidden = false;
  // distance (px) between edge of panel and the pointing triangle (caret)
  const MARGIN = 20;

  const dfnRects = dfn.getClientRects();
  // Find the `top` offset when the `dfn` can be spread across multiple lines
  let closestTop = 0;
  let minDiff = Infinity;
  for (const rect of dfnRects) {
    const { top, bottom } = rect;
    const diffFromClickY = Math.abs((top + bottom) / 2 - y);
    if (diffFromClickY < minDiff) {
      minDiff = diffFromClickY;
      closestTop = top;
    }
  }

  const top = window.scrollY + closestTop + dfnRects[0].height;
  const left = x - MARGIN;
  panel.style.left = `${left}px`;
  panel.style.top = `${top}px`;

  // Find if the panel is flowing out of the window
  const panelRect = panel.getBoundingClientRect();
  const SCREEN_WIDTH = Math.min(window.innerWidth, window.screen.width);
  if (panelRect.right > SCREEN_WIDTH) {
    const newLeft = Math.max(MARGIN, x + MARGIN - panelRect.width);
    const newCaretOffset = left - newLeft;
    panel.style.left = `${newLeft}px`;
    /** @type {HTMLElement} */
    const caret = panel.querySelector(".caret");
    caret.style.left = `${newCaretOffset}px`;
  }

  // As it's a dialog, we trap focus.
  // TODO: when <dialog> becomes a implemented, we should really
  // use that.
  trapFocus(panel, dfn);
}

/**
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function trapFocus(panel, dfn) {
  /** @type NodeListOf<HTMLAnchorElement> elements */
  const anchors = panel.querySelectorAll("a[href]");
  // No need to trap focus
  if (!anchors.length) return;

  // Move focus to first anchor element
  const first = anchors.item(0);
  first.focus();

  const trapListener = createTrapListener(anchors, panel, dfn);
  panel.addEventListener("keydown", trapListener);

  // Hiding the panel releases the trap
  const mo = new MutationObserver(records => {
    const [record] = records;
    const target = /** @type HTMLElement */ (record.target);
    if (target.hidden) {
      panel.removeEventListener("keydown", trapListener);
      mo.disconnect();
    }
  });
  mo.observe(panel, { attributes: true, attributeFilter: ["hidden"] });
}

/**
 *
 * @param {NodeListOf<HTMLAnchorElement>} anchors
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function createTrapListener(anchors, panel, dfn) {
  const lastIndex = anchors.length - 1;
  let currentIndex = 0;
  return event => {
    switch (event.key) {
      // Hitting "Tab" traps us in a nice loop around elements.
      case "Tab": {
        event.preventDefault();
        currentIndex += event.shiftKey ? -1 : +1;
        if (currentIndex < 0) {
          currentIndex = lastIndex;
        } else if (currentIndex > lastIndex) {
          currentIndex = 0;
        }
        anchors.item(currentIndex).focus();
        break;
      }

      // Hitting "Enter" on an anchor releases the trap.
      case "Enter":
        hidePanel(panel);
        break;

      // Hitting "Escape" returns focus to dfn.
      case "Escape":
        hidePanel(panel);
        dfn.focus();
        return;
    }
  };
}

/** @param {HTMLElement} panel */
function hidePanel(panel) {
  if (!panel) return;
  panel.hidden = true;
  panel.classList.remove("docked");
}
})()</script><script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script></body></html>